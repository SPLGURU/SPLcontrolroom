    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
        <title>Control Room V2</title>
        <!-- Firebase SDK - Core -->
        <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
        <!-- Firebase SDK - Auth -->
        <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
        <!-- Firebase SDK - Firestore -->
        <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!-- html2canvas library for capturing screenshots -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> 
        <!-- NEW: gif.js library for GIF encoding -->
        <script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>
        
        <!-- NEW: XLSX.js library for reading Excel files (still needed for FDR uploads) -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Oswald:wght@400;700&display=swap" rel="stylesheet">
        <!-- Font Awesome for Hamburger Icon -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <style id="main-styles">
            /* Base colors for light mode (current default) */
            :root {
                --spl-light-bg: #F8F9FA;
                --spl-container-bg: #FFFFFF;
                --spl-table-bg: #E0E4E8;
                --spl-table-header-bg: #B3D9FF;
                --spl-table-row-even: #D6DBE0;
                --spl-table-row-hover: #C7CCD1;
                --spl-text-dark: #212529;
                --spl-text-medium: #495057;
                --spl-primary-accent: #034667;
                --spl-accent-green: #28A745;
                --spl-accent-red: #DC3545;
                --spl-border-light: #CED4DA;
                --spl-shadow: rgba(0, 0, 0, 0.1);
            }

            /* Dark mode specific variables */
            body.dark-mode {
                --spl-light-bg: #034667; /* User requested background */
                --spl-container-bg: #1a3e5c; /* Darker blue for cards/containers */
                --spl-table-bg: #0d283c; /* Even darker blue for tables */
                --spl-table-header-bg: #0a1c2a; /* Very dark blue/black for table headers */
                --spl-table-row-even: #123045; /* Dark blue for even rows */
                --spl-table-row-hover: #1f4f7a; /* Lighter dark blue on hover */
                --spl-text-dark: #F8F9FA; /* Light text */
                --spl-text-medium: #CED4DA; /* Lighter medium text */
                --spl-primary-accent: #007bff; /* Brighter blue for accent */
                /* Green and Red accents remain the same for clarity */
                --spl-border-light: #495057; /* Darker border */
                --spl-shadow: rgba(255, 255, 255, 0.1); /* Light shadow for dark mode */
            }

            body {
                font-family: 'Roboto', sans-serif;
                background-color: var(--spl-light-bg);
                color: var(--spl-text-dark);
                margin: 0;
                padding: 20px;
                line-height: 1.6;
                display: flex;
                flex-direction: column;
                align-items: center;
                min-height: 100vh;
                box-sizing: border-box;
                transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for theme change */
            }

            #logo-container {
                text-align: center;
                margin-bottom: 20px; /* Space below the logo */
                width: 100%;
            }

            #logo-container img {
                max-width: 300px; /* Adjust as needed for PC size */
                height: auto;
                display: block; /* Remove extra space below image */
                margin: 0 auto; /* Center the image */
                transition: src 0.3s ease; /* Smooth transition for logo change */
            }

            /* Theme switch styles */
            .theme-switch-wrapper {
                display: flex;
                align-items: center;
                justify-content: center; /* Center the switch */
                margin-bottom: 20px;
                gap: 10px;
                color: var(--spl-text-dark); /* Ensure label text changes with theme */
                font-size: 0.95em;
                width: 100%;
                max-width: 1200px;
            }
            .theme-switch {
                position: relative;
                display: inline-block;
                width: 45px;
                height: 25px;
            }
            .theme-switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                -webkit-transition: .4s;
                transition: .4s;
            }
            .slider:before {
                position: absolute;
                content: "";
                height: 18px;
                width: 18px;
                left: 4px;
                bottom: 4px;
                background-color: white;
                -webkit-transition: .4s;
                transition: .4s;
            }
            input:checked + .slider {
                background-color: var(--spl-primary-accent);
            }
            input:focus + .slider {
                box-shadow: 0 0 1px var(--spl-primary-accent);
            }
            input:checked + .slider:before {
                -webkit-transform: translateX(20px);
                -ms-transform: translateX(20px);
                transform: translateX(20px);
            }
            /* Rounded sliders */
            .slider.round {
                border-radius: 25px;
            }
            .slider.round:before {
                border-radius: 50%;
            }
            /* Adjust switch background color for dark mode */
            body.dark-mode .theme-switch .slider {
                background-color: #555;
            }
            body.dark-mode input:checked + .slider {
                background-color: var(--spl-primary-accent);
            }
            body.dark-mode .theme-label {
                color: var(--spl-text-dark);
            }


            .container {
                background-color: var(--spl-container-bg);
                border-radius: 12px;
                box-shadow: 0 6px 12px var(--spl-shadow);
                padding: 30px;
                margin-bottom: 20px;
                width: 100%;
                max-width: 1200px;
                box-sizing: border-box;
                transition: background-color 0.3s ease, box-shadow 0.3s ease;
            }

            h1, h2, h3 {
                font-family: 'Oswald', sans-serif;
                color: var(--spl-primary-accent);
                text-align: center;
                margin-top: 0;
                margin-bottom: 20px;
                transition: color 0.3s ease;
            }
            
            .input-section {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 15px;
                margin-bottom: 30px;
            }

            /* --- Login/Signup Forms Styling --- */
            #authSection { 
                display: flex;
                flex-direction: column;
                align-items: center; 
                width: 100%; 
            }

            #loginForm, #signupForm {
                display: flex;
                flex-direction: column;
                align-items: center; 
                gap: 15px; 
                width: 100%; 
                max-width: 400px; 
                margin: 0 auto; 
                padding-bottom: 15px; 
                box-sizing: border-box; 
            }

            /* Input fields within login/signup forms */
            #loginForm input[type="email"],
            #loginForm input[type="password"],
            #signupForm input[type="email"],
            #signupForm input[type="password"],
            #signupForm input[type="text"] {
                display: block; 
                width: 100%; 
                max-width: 300px; 
                margin: 0 auto; 
                padding: 10px 12px; 
                border: 1px solid #ced4da; 
                border-radius: 4px; 
                font-size: 1em;
                box-sizing: border-box;
                text-align: left; 
                background-color: var(--spl-container-bg);
                color: var(--spl-text-dark);
                transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;

                -moz-appearance: textfield;
            }
            /* Webkit browsers (Chrome, Safari, Edge) for hiding arrows */
            .input-section input::-webkit-outer-spin-button,
            .input-section input::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            /* Buttons within login/signup forms */
            #loginForm button,
            #signupForm button {
                display: block; 
                width: 100%; 
                max-width: 300px; 
                margin: 0 auto; 
                background-color: #007bff; 
                color: white;
                padding: 10px 20px; 
                border: none;
                border-radius: 4px; 
                font-size: 1.1em;
                cursor: pointer;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); 
            }

            #loginForm button:hover,
            #signupForm button:hover {
                background-color: #0056b3; 
                transform: translateY(-1px); 
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
            }
            
            /* Centering the "Don't have an account?" and "Already have an account?" texts */
            #loginForm p,
            #signupForm p {
                text-align: center; 
                width: 100%; 
                max-width: 300px; 
                margin: 10px auto; 
                color: var(--spl-text-dark); 
                transition: color 0.3s ease; 
            }

            #loginForm p a,
            #signupForm p a {
                color: var(--spl-primary-accent); 
                text-decoration: none;
                font-weight: bold;
                transition: color 0.3s ease;
            }

            #loginForm p a:hover,
            #signupForm p a:hover {
                text-decoration: underline;
            }
            /* --- End Login/Signup Forms Styling --- */


            .input-section label {
                font-weight: bold;
                color: var(--spl-text-medium);
                font-size: 1.1em;
                transition: color 0.3s ease;
            }
            
            /* General input and button styles (for non-auth forms, if any) */
            .input-section input[type="text"],
            .input-section input[type="email"],
            .input-section input[type="password"] {
                padding: 12px 15px;
                border: 1px solid var(--spl-border-light);
                border-radius: 8px;
                font-size: 1em;
                box-sizing: border-box;
                text-align: center;
                background-color: var(--spl-container-bg);
                color: var(--spl-text-dark);
                transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            }

            .input-section button {
                background-color: var(--spl-primary-accent);
                color: white;
                padding: 12px 25px;
                border: none;
                border-radius: 8px;
                font-size: 1.1em;
                cursor: pointer;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
                box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
                display: block;
                margin: 0 auto;
            }
            .input-section button:hover {
                background-color: #0056b3;
                transform: translateY(-2px);
            }


            /* --- NEW MENU STYLES --- */
            #menuToggle {
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1001;
                cursor: pointer;
                font-size: 2em;
                color: var(--spl-primary-accent);
                transition: color 0.3s ease;
                display: none;
            }
            body.dark-mode #menuToggle {
                color: #fff;
            }

            #sidebarMenu {
                position: fixed;
                top: 0;
                left: -300px;
                width: 280px;
                height: 100%;
                background-color: var(--spl-container-bg);
                box-shadow: 3px 0 10px rgba(0, 0, 0, 0.2);
                z-index: 1000;
                transition: left 0.3s ease-in-out;
                padding-top: 20px;
                display: flex;
                flex-direction: column;
                gap: 10px;
                box-sizing: border-box;
            }
            body.dark-mode #sidebarMenu {
                background-color: var(--spl-container-bg);
            }

            #sidebarMenu.open {
                left: 0;
            }

            #sidebarMenu a {
                padding: 15px 25px;
                text-decoration: none;
                color: var(--spl-text-dark);
                font-size: 1.1em;
                display: block;
                transition: background-color 0.2s ease, color 0.2s ease;
                border-left: 5px solid transparent;
            }
            #sidebarMenu a:hover {
                background-color: var(--spl-table-row-hover);
                color: var(--spl-primary-accent);
            }
            body.dark-mode #sidebarMenu a {
                color: var(--spl-text-dark);
            }
            body.dark-mode #sidebarMenu a:hover {
                background-color: var(--spl-table-row-hover);
                color: var(--spl-primary-accent);
            }

            /* Red button style for Logout */
            .red-button {
                background-color: #DC3545 !important;
                color: white !important;
                padding: 10px 20px !important;
                border: none !important;
                border-radius: 4px !important;
                font-size: 1.1em !important;
                cursor: pointer !important;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease !important;
                box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2) !important;
                display: block;
                width: calc(100% - 50px);
                margin: 10px auto;
            }
            .red-button:hover {
                background-color: #c82333 !important;
                transform: translateY(-1px) !important;
                box-shadow: 0 4px 8px rgba(220, 53, 69, 0.25);
            }
            body.dark-mode .red-button {
                background-color: #f44336 !important;
                box-shadow: 0 44px 8px rgba(244, 67, 54, 0.2) !important;
            }
            body.dark-mode .red-button:hover {
                background-color: #d32f2f !important;
            }

            /* Sidebar Header for Team Name */
            #sidebarHeader {
                padding: 15px 25px 10px;
                font-family: 'Oswald', sans-serif;
                color: var(--spl-primary-accent);
                font-size: 1.2em;
                font-weight: bold;
                border-bottom: 1px solid var(--spl-border-light);
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
            }
            body.dark-mode #sidebarHeader {
                color: var(--spl-text-dark);
                border-bottom-color: var(--spl-border-light);
            }

            #sidebarTeamName {
                color: var(--spl-primary-accent);
                display: block; 
                margin-top: 5px; 
            }
            body.dark-mode #sidebarTeamName {
                color: #FFD700;
            }

            /* Manager ID Text in Sidebar */
            #sidebarManagerIdText {
                padding: 10px 25px;
                font-size: 0.95em;
                color: var(--spl-text-medium);
                margin-top: 10px;
                margin-bottom: 10px;
                text-align: center;
                border-top: 1px solid var(--spl-border-light);
                padding-top: 15px;
            }
            body.dark-mode #sidebarManagerIdText {
                color: var(--spl-text-medium);
                border-top-color: var(--spl-border-light);
            }


            /* This is the overlay when menu is open */
            #overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                display: none;
            }
            /* --- END NEW MENU STYLES --- */


            /* --- Admin Dashboard Specific Styles --- */
            #adminDashboardContent {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 20px;
                padding: 20px;
                margin-top: 20px;
                border-radius: 12px;
                background-color: var(--spl-container-bg); 
                box-shadow: 0 4px 8px var(--spl-shadow);
                width: 100%;
                max-width: 600px;
                box-sizing: border-box;
                min-height: 200px;
                margin-left: auto;
                margin-right: auto;
            }
            body.dark-mode #adminDashboardContent {
                background-color: var(--spl-container-bg);
            }

            #adminDashboardContent h2 {
                color: var(--spl-primary-accent);
                margin-bottom: 15px;
            }

            .admin-search-section, .admin-edit-section {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .admin-search-section input[type="text"],
            .admin-edit-section input[type="email"],
            .admin-edit-section input[type="text"] {
                width: 100%;
                max-width: 350px;
                padding: 10px 12px;
                border: 1px solid var(--spl-border-light);
                border-radius: 6px;
                font-size: 1em;
                background-color: var(--spl-table-bg); 
                color: var(--spl-text-dark);
                box-sizing: border-box;
                text-align: center;
            }

            .admin-search-section button,
            .admin-edit-section button {
                background-color: #6c757d; 
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                font-size: 1em;
                cursor: pointer;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                width: 100%;
                max-width: 350px;
            }
            .admin-search-section button:hover,
            .admin-edit-section button:hover {
                background-color: #5a6268;
                transform: translateY(-1px);
            }
            body.dark-mode .admin-search-section button,
            body.dark-mode .admin-edit-section button {
                background-color: #6f42c1; 
                box-shadow: 0 4px 8px rgba(111, 66, 193, 0.2);
            }
            body.dark-mode .admin-search-section button:hover,
            body.dark-mode .admin-edit-section button:hover {
                background-color: #5e35b1;
            }

            #adminSearchResults p {
                font-size: 1em;
                color: var(--spl-text-dark);
                margin-bottom: 5px;
                text-align: center;
                width: 100%;
            }
            #adminSearchResults strong {
                color: var(--spl-primary-accent);
            }

            /* Separate message box for admin actions */
            #adminMessage {
                text-align: center;
                padding: 10px;
                border-radius: 6px;
                margin-top: 10px;
                font-weight: bold;
                background-color: #d1ecf1;
                color: #0c5460;
                width: 100%;
                max-width: 350px;
                box-sizing: border-box;
                display: none;
            }
            body.dark-mode #adminMessage {
                background-color: #1f3d54;
                color: #b0e0e6;
            }
            /* New Admin Dashboard internal navigation buttons */
            .admin-dashboard-nav-buttons {
                display: flex;
                justify-content: center;
                gap: 15px;
                width: 100%;
                margin-bottom: 20px;
            }
            .admin-dashboard-nav-buttons button {
                background-color: var(--spl-primary-accent);
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                font-size: 1em;
                cursor: pointer;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                min-width: 120px;
            }
            .admin-dashboard-nav-buttons button:hover {
                background-color: #0056b3;
                transform: translateY(-1px);
            }
            body.dark-mode .admin-dashboard-nav-buttons button {
                background-color: #007bff;
            }
            body.dark-mode .admin-dashboard-nav-buttons button:hover {
                background-color: #0056b3;
            }
            /* --- End Admin Dashboard Specific Styles --- */


            .message-box { 
                text-align: center;
                padding: 15px;
                border-radius: 8px;
                margin-top: 15px;
                font-weight: bold;
                display: none; 
            }
            .message-box.success { background-color: #d4edda; color: #155724; }
            .message-box.error { background-color: #f8d7da; color: #721c24; }
            .message-box.info { background-color: #d1ecf1; color: #0c5460; }
            .message-box.warning { background-color: #fff3cd; color: #856404; } 


            .loading-message, .error-message { 
                text-align: center;
                padding: 20px;
                border-radius: 8px;
                margin-top: 20px;
                font-weight: bold;
                transition: background-color 0.3s ease, color 0.3s ease; 
            }

            .loading-message {
                background-color: #e0f7fa;
                color: #007BFF;
            }

            .error-message {
                background-color: #ffe0e6;
                color: #DC3545;
                border: 1px solid #DC3545;
            }

            /* Responsive Adjustments */
            @media (max-width: 950px) {
                body {
                    padding: 15px;
                }

                .container {
                    padding: 20px;
                }

                /* inputs and buttons inside specific forms */
                #loginForm input[type="text"],
                #loginForm input[type="email"],
                #loginForm input[type="password"],
                #signupForm input[type="text"],
                #signupForm input[type="email"],
                #signupForm input[type="password"],
                #loginForm button,
                #signupForm button {
                    font-size: 0.95em;
                    padding: 10px 20px;
                }
            }

            @media (max-width: 480px) {
                h1 {
                    font-size: 1.8em;
                }
                h2 {
                    font-size: 1.4em;
                }
                .input-section {
                    gap: 10px;
                }
            }

            .instructions {
                background-color: #e9ecef;
                border-left: 5px solid var(--spl-primary-accent);
                padding: 15px 20px;
                margin-top: 20px;
                border-radius: 8px;
                font-size: 0.95em;
                color: var(--spl-text-dark);
                line-height: 1.5;
                width: 100%;
                max-width: 600px;
                box-sizing: border-box;
                text-align: left;
                transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
            }
            .instructions h3 {
                color: var(--spl-primary-accent);
                margin-top: 0;
                margin-bottom: 10px;
                text-align: left;
                transition: color 0.3s ease;
            }
            .instructions ol {
                margin-left: 20px;
                padding-left: 0;
            }
            .instructions li {
                margin-bottom: 8px;
            }
            .instructions a {
                color: var(--spl-primary-accent);
                text-decoration: none;
                font-weight: bold;
                transition: color 0.3s ease;
            }
            .instructions a:hover {
                text-decoration: underline;
            }

            /* Dark mode specific styles for the instructions box text */
            body.dark-mode .instructions {
                background-color: var(--spl-light-bg);
                border-left-color: var(--spl-primary-accent);
                color: var(--spl-text-dark);
            }
            body.dark-mode .instructions h3,
            body.dark-mode .instructions a {
                color: #FFD700;
            }

            /* FDR Difficulty Scale Colors */
            .fdr-scale {
                display: flex;
                justify-content: center;
                align-items: center;
                margin-bottom: 20px; /* Adjusted margin */
                font-weight: bold;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                width: 100%; /* Ensure it takes full width of its container */
                max-width: 700px; /* Limit max width for readability */
                margin-left: auto;
                margin-right: auto;
            }
            .fdr-level {
                padding: 8px 12px;
                text-align: center;
                color: black;
                flex-grow: 1;
                min-width: 50px;
                transition: background-color 0.3s ease, color 0.3s ease;
            }
            .fdr-level span {
                display: block;
                font-size: 0.8em;
                margin-top: 2px;
            }

            /* Specific FDR Colors */
            .fdr-1 { background-color: #00B050; color: white; }
            .fdr-2 { background-color: #92D050; color: black; }
            .fdr-3 { background-color: #FFFF00; color: black; }
            .fdr-4 { background-color: #FFC000; color: black; }
            .fdr-5 { background-color: #FF0000; color: white; }
            .fdr-6 { background-color: #C00000; color: white; }
            .fdr-7 { background-color: #800000; color: white; }
            
            /* Dark Mode Adjustments for FDR Colors */
            body.dark-mode .fdr-level {
                color: white;
            }
            body.dark-mode .fdr-2, body.dark-mode .fdr-3, body.dark-mode .fdr-4 {
                color: black;
            }
            body.dark-mode .fdr-1 { background-color: #008037; }
            body.dark-mode .fdr-2 { background-color: #6B9F3B; }
            body.dark-mode .fdr-3 { background-color: #B3B300; }
            body.dark-mode .fdr-4 { background-color: #B38600; }
            body.dark-mode .fdr-5 { background-color: #B30000; }
            body.dark-mode .fdr-6 { background-color: #800000; }
            body.dark-mode .fdr-7 { background-color: #530000; }

            /* Styles for the two-column FDR display (Overall) */
            .fdr-data-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0;
                border: 1px solid var(--spl-border-light);
                border-radius: 8px;
                overflow: hidden;
                box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
            }
            body.dark-mode .fdr-data-grid {
                border-color: rgba(255,255,255,0.1);
                box-shadow: inset 0 0 5px rgba(255,255,255,0.05);
            }

            /* Styles for single-column FDR display (Home/Away) */
            .fdr-single-column-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0;
                border: 1px solid var(--spl-border-light);
                border-radius: 8px;
                overflow: hidden;
                box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
            }
            body.dark-mode .fdr-single-column-grid {
                border-color: rgba(255,255,255,0.1);
                box-shadow: inset 0 0 5px rgba(255,255,255,0.05);
            }

            .fdr-grid-item {
                padding: 10px 15px;
                text-align: center;
                font-weight: bold;
                font-size: 0.95em;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 5px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                color: black;
                min-height: 45px;
                box-sizing: border-box;
                border-bottom: 1px solid var(--spl-border-light);
                transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            }
            body.dark-mode .fdr-grid-item {
                color: white;
                border-bottom-color: rgba(255,255,255,0.1);
            }

            /* Vertical separator for the left column items (only applies to two-column grids) */
            .fdr-data-grid .fdr-grid-item:nth-child(2n-1) {
                border-right: 1px solid var(--spl-border-light);
                transition: border-color 0.3s ease;
            }
            body.dark-mode .fdr-data-grid .fdr-grid-item:nth-child(2n-1) {
                border-right-color: rgba(255,255,255,0.1);
            }

            /* Remove bottom border for items in the last "row" (last two items for 2-col, last item for 1-col) */
            .fdr-data-grid > :nth-last-child(-n + 2) { 
                border-bottom: none;
            }
            .fdr-single-column-grid > :last-child {
                border-bottom: none;
            }
            /* Style for the upload button label to make it look like a button */
            .upload-button-label {
                display: inline-block;
                background-color: var(--spl-primary-accent);
                color: white;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 1em;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                margin-top: 10px;
            }

            .upload-button-label:hover {
                background-color: #0056b3;
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            }

            .upload-button-label input[type="file"] {
                display: none;
            }
            /* Responsive adjustments for the new grid */
            @media (max-width: 480px) {
                .fdr-grid-item {
                    font-size: 0.8em;
                    padding: 8px 10px;
                    min-height: 35px;
                }
            }

            /* Styles for the FDR system selection in My Control Room */
            .fdr-system-selection {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin-bottom: 20px;
                flex-wrap: wrap; /* Allow wrapping on smaller screens */
            }

            .fdr-system-selection label {
                display: flex;
                align-items: center;
                cursor: pointer;
                font-weight: bold;
                color: var(--spl-text-dark);
                transition: color 0.3s ease;
            }

            .fdr-system-selection input[type="radio"] {
                margin-right: 8px;
                accent-color: var(--spl-primary-accent); /* Style the radio button itself */
                transform: scale(1.2); /* Make radio buttons slightly larger */
            }

            .fdr-system-selection button {
                background-color: var(--spl-primary-accent);
                color: white;
                padding: 8px 15px;
                border: none;
                border-radius: 6px;
                font-size: 0.9em;
                cursor: pointer;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .fdr-system-selection button:hover {
                background-color: #0056b3;
                transform: translateY(-1px);
            }
            body.dark-mode .fdr-system-selection label {
                color: var(--spl-text-dark);
            }
            body.dark-mode .fdr-system-selection button {
                background-color: #007bff;
            }
            body.dark-mode .fdr-system-selection button:hover {
                background-color: #0056b3;
            }

            /* Styles for individual fixture display */
            .fixture-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 15px;
                border-bottom: 1px solid var(--spl-border-light);
                background-color: var(--spl-container-bg);
                transition: background-color 0.3s ease;
            }
            .fixture-item:last-child {
                border-bottom: none;
            }
            .fixture-item span {
                font-weight: bold;
                color: var(--spl-text-dark);
            }
            .fixture-item .fdr-value {
                padding: 5px 10px;
                border-radius: 5px;
                font-weight: bold;
                color: white; /* Default for FDR colors */
                min-width: 40px;
                text-align: center;
            }
            /* Specific FDR Colors for fixture items */
            /* REMOVED FDR COLORS FOR SCHEDULE CELLS AS REQUESTED */
            /* .fixture-item .fdr-1 { background-color: #00B050; } */
            /* .fixture-item .fdr-2 { background-color: #92D050; color: black; } */
            /* .fixture-item .fdr-3 { background-color: #FFFF00; color: black; } */
            /* .fixture-item .fdr-4 { background-color: #FFC000; color: black; } */
            /* .fixture-item .fdr-5 { background-color: #FF0000; } */
            /* .fixture-item .fdr-6 { background-color: #C00000; } */
            /* .fixture-item .fdr-7 { background-color: #800000; } */

            body.dark-mode .fixture-item {
                background-color: var(--spl-container-bg);
                border-bottom-color: rgba(255,255,255,0.1);
            }
            body.dark-mode .fixture-item span {
                color: var(--spl-text-dark);
            }
            /* Dark mode specific FDR colors for fixture items */
            /* REMOVED FDR COLORS FOR SCHEDULE CELLS AS REQUESTED */
            /* body.dark-mode .fixture-item .fdr-1 { background-color: #008037; } */
            /* body.dark-mode .fixture-item .fdr-2 { background-color: #6B9F3B; } */
            /* body.dark-mode .fixture-item .fdr-3 { background-color: #B3B300; } */
            /* body.dark-mode .fixture-item .fdr-4 { background-color: #B38600; } */
            /* body.dark-mode .fixture-item .fdr-5 { background-color: #B30000; } */
            /* body.dark-mode .fixture-item .fdr-6 { background-color: #800000; } */
            /* body.dark-mode .fixture-item .fdr-7 { background-color: #530000; } */

            /* Container for fixtures list */
            .fixtures-list-container {
                border: 1px solid var(--spl-border-light);
                border-radius: 8px;
                overflow: hidden;
                box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
                margin-top: 20px;
                max-width: 400px; /* Limit width for readability */
                width: 100%;
                margin-left: auto;
                margin-right: auto;
            }
            body.dark-mode .fixtures-list-container {
                border-color: rgba(255,255,255,0.1);
                box-shadow: inset 0 0 5px rgba(255,255,255,0.05);
            }

            .fdr-section-title {
                text-align: center;
                font-size: 1.1em;
                font-weight: bold;
                color: var(--spl-primary-accent);
                margin-top: 25px;
                margin-bottom: 15px;
            }
            body.dark-mode .fdr-section-title {
                color: #FFD700;
            }

            /* Styles for Customized FDR inputs */
            .custom-fdr-input-group {
                display: flex;
                flex-direction: column; /* Stack opponent and input */
                justify-content: center; /* Center content vertically */
                align-items: center; /* Center content horizontally */
                padding: 5px; /* Reduced padding */
                border-bottom: 1px solid var(--spl-border-light);
                background-color: var(--spl-container-bg);
                transition: background-color 0.3s ease;
                min-height: 60px; /* Ensure enough height for stacked elements */
            }
            .custom-fdr-input-group:last-child {
                border-bottom: none;
            }
            .custom-fdr-input-group span {
                font-weight: bold;
                color: var(--spl-text-dark);
                text-align: center;
                margin-bottom: 5px; /* Space between opponent name and input */
            }
            .custom-fdr-input-group input[type="number"] {
                width: 50px; /* Slightly smaller input */
                padding: 3px; /* Reduced padding */
                border: 1px solid var(--spl-border-light);
                border-radius: 4px;
                text-align: center;
                font-size: 0.8em; /* Smaller font size */
                background-color: var(--spl-table-bg);
                color: var(--spl-text-dark);
            }
            .custom-fdr-input-group input[type="number"]:focus {
                outline: none;
                border-color: var(--spl-primary-accent);
                box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
            }
            body.dark-mode .custom-fdr-input-group {
                background-color: var(--spl-container-bg);
                border-bottom-color: rgba(255,255,255,0.1);
            }
            body.dark-mode .custom-fdr-input-group span {
                color: var(--spl-text-dark);
            }
            body.dark-mode .custom-fdr-input-group input[type="number"] {
                background-color: var(--spl-table-bg);
                color: var(--spl-text-dark);
                border-color: var(--spl-border-light);
            }

            /* Styling for the main FDR button in My Control Room */
            #showFDRButton {
                display: block;
                margin: 20px auto; /* Center the button */
                background-color: var(--spl-primary-accent);
                color: white;
                padding: 15px 30px;
                border: none;
                border-radius: 8px;
                font-size: 1.2em;
                cursor: pointer;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
                box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
                max-width: fit-content; /* Adjust width to content */
            }
            #showFDRButton:hover {
                background-color: #0056b3;
                transform: translateY(-2px);
                box-shadow: 0 6px 12px rgba(0, 123, 255, 0.3);
            }
            body.dark-mode #showFDRButton {
                background-color: #007bff;
            }
            body.dark-mode #showFDRButton:hover {
                background-color: #0056b3;
            }

            #fdrSystemsContainer {
                display: none; /* Hidden by default, shown when FDR button is clicked */
                flex-direction: column;
                align-items: center;
                gap: 20px;
                margin-top: 20px;
                padding: 20px;
                border-radius: 12px;
                background-color: var(--spl-container-bg);
                box-shadow: 0 4px 8px var(--spl-shadow);
                width: 100%;
                max-width: 1200px; /* Increased max-width to accommodate schedule table */
                box-sizing: border-box;
                margin-left: auto;
                margin-right: auto;
            }
            #fdrSystemsContainer p {
                text-align: center;
                font-size: 1.1em;
                color: var(--spl-text-dark);
                margin-bottom: 10px;
            }

            /* New: Welcome Dashboard content */
            #initialLoggedInDashboardContent {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 200px;
                text-align: center;
                padding: 20px;
                color: var(--spl-text-dark);
            }
            #initialLoggedInDashboardContent h2 {
                color: var(--spl-primary-accent);
            }

            /* Schedule display styles */
            .schedule-table-container {
                width: 100%;
                overflow-x: auto; /* Allows horizontal scrolling for large tables */
                margin-top: 20px; /* Adjusted margin */
                border: 1px solid var(--spl-border-light);
                border-radius: 8px;
                box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
                background-color: var(--spl-container-bg);
            }
            body.dark-mode .schedule-table-container {
                border-color: rgba(255,255,255,0.1);
                box-shadow: inset 0 0 5px rgba(255,255,255,0.05);
            }

            .schedule-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 0.9em;
                min-width: 600px; /* Ensure table doesn't get too squished */
            }

            .schedule-table th, .schedule-table td {
                border: 1px solid var(--spl-border-light);
                padding: 8px 12px;
                text-align: center;
                white-space: nowrap; /* Prevent wrapping in cells */
                transition: background-color 0.3s ease, border-color 0.3s ease;
            }

            .schedule-table th {
                background-color: var(--spl-table-header-bg);
                color: var(--spl-text-dark);
                font-weight: bold;
                position: sticky;
                top: 0; /* Keeps header visible on scroll */
                z-index: 10;
            }
            body.dark-mode .schedule-table th {
                background-color: var(--spl-table-header-bg);
                color: var(--spl-text-dark);
            }

            .schedule-table tr:nth-child(even) {
                background-color: var(--spl-table-row-even);
            }
            body.dark-mode .schedule-table tr:nth-child(even) {
                background-color: var(--spl-table-row-even);
            }

            .schedule-table tr:hover {
                background-color: var(--spl-table-row-hover);
            }
            body.dark-mode .schedule-table tr:hover {
                background-color: var(--spl-table-row-hover);
            }

            .schedule-table td {
                color: var(--spl-text-dark);
            }
            body.dark-mode .schedule-table td {
                color: var(--spl-text-dark);
            }

            /* Specific styling for fixture cells */
            .fixture-cell {
                display: flex;
                flex-direction: column; /* Stack multiple fixtures */
                align-items: center;
                justify-content: center;
                gap: 5px;
                font-weight: bold;
                padding: 5px 8px;
                border-radius: 4px;
                min-width: 60px; /* Ensure enough space for opponent + FDR */
            }
            .fixture-item-display {
                display: flex;
                align-items: center;
                gap: 5px;
                padding: 2px 5px;
                border-radius: 3px;
                font-size: 0.85em; /* Smaller font for individual fixture in a cell */
                white-space: nowrap;
                /* No background-color or color for FDR here anymore */
            }

            /* No FDR coloring for schedule cells in this version */
            /* .fixture-item-display.fdr-1 { background-color: #00B050; } */
            /* ... removed other fdr- classes for fixture-item-display ... */
            /* .fixture-item-display.fdr-na { background-color: #ccc; color: #666; } */

            /* Tuning section styles */
            .tuning-section {
                display: flex;
                flex-direction: column;
                gap: 15px;
                margin-top: 20px; 
                padding: 15px;
                /* Removed border, box-shadow, background-color for minimal design */
                border-radius: 8px;
                max-width: 400px;
                margin-left: auto;
                margin-right: auto;
            }
            .tuning-section label {
                font-weight: bold;
                color: var(--spl-text-dark);
            }
            .tuning-section input[type="range"] {
                width: 100%;
                -webkit-appearance: none;
                height: 8px;
                border-radius: 5px;
                background: var(--spl-border-light);
                outline: none;
                opacity: 0.7;
                -webkit-transition: .2s;
                transition: opacity .2s;
            }
            .tuning-section input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: var(--spl-primary-accent);
                cursor: pointer;
            }
            .tuning-section input[type="range"]::-moz-range-thumb {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: var(--spl-primary-accent);
                cursor: pointer;
            }
            .tuning-option {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            /* Removed styling for checkboxes as they are removed */
            /* .tuning-option input[type="checkbox"] {
                transform: scale(1.2);
                accent-color: var(--spl-primary-accent);
            } */
            .tuning-value {
                font-weight: bold;
                color: var(--spl-primary-accent);
            }
            body.dark-mode .tuning-section {
                /* Removed border-color, box-shadow for minimal design */
            }
            body.dark-mode .tuning-section label {
                color: var(--spl-text-dark);
            }
            body.dark-mode .tuning-section input[type="range"] {
                background: #555;
            }
            body.dark-mode .tuning-section input[type="range"]::-webkit-slider-thumb {
                background: #007bff;
            }
            body.dark-mode .tuning-section input[type="range"]::-moz-range-thumb {
                background: #007bff;
            }
            body.dark-mode .tuning-value {
                color: #FFD700;
            }

        </style>
    </head>
    <body>
        <div id="logo-container">
            <img id="mainLogo" src="unnamed.jpg" alt="Fantasy SPL Data Center Logo">
        </div>

        <!-- Theme Switch -->
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="darkModeToggle">
                <input type="checkbox" id="darkModeToggle" />
                <span class="slider round"></span>
            </label>
            <em class="theme-label">Dark Mode</em>
        </div>

        <div class="container">
            <h1>Control Room V2</h1> 

            <!-- Authentication Section (visible when logged out) -->
            <div id="authSection">
                <div id="loginForm"> 
                    <h2>Login</h2>
                    <input type="email" id="loginEmail" placeholder="Email Address">
                    <input type="password" id="loginPassword" placeholder="Password">
                    <button id="loginButton">Login</button>
                    <p>Don't have an account? <a href="#" id="showSignupLink">Sign Up</a></p>
                </div>

                <div id="signupForm" style="display: none;"> 
                    <h2>Sign Up</h2>
                    <input type="email" id="signupEmail" placeholder="Email Address">
                    <input type="password" id="signupPassword" placeholder="Password">
                    <input type="password" id="signupConfirmPassword" placeholder="Confirm Password">
                    <!-- Manager ID moved here -->
                    <input type="text" id="signupManagerId" placeholder="Your SPL Manager ID" oninput="this.value = convertArabicToWesternNumerals(this.value)">
                    <button id="signupButton">Sign Up</button>
                    <p>Already have an account? <a href="#" id="showLoginLink">Login</a></p>

                    <!-- Instructions box - now exclusively part of the signup form -->
                    <div id="instructionsBox" class="instructions" style="display: none;"> 
                        <h3>How to get your Manager ID:</h3>
                        <ol>
                            <li>Go to <a href="https://fantasy.spl.com.sa/" target="_blank">https://fantasy.spl.com.sa/</a> from your browser (SPL app does not work to get your ID).</li>
                            <li>Login with your credentials.</li>
                            <li>Click on "Points" in the top menu.</li>
                            <li>Check the address bar and look for the numbers after the word "/entry/". Copy that - it is your ID number.</li>
                        </ol>
                    </div>
                </div>
                
                <div id="authMessageBox" class="message-box"></div> 
            </div>

            <!-- Logged In Content (visible when logged in) -->
            <!-- This container is initially hidden and shown by JS upon successful login -->
            <div id="loggedInContent" class="container" style="display: none;">
                <!-- Hamburger Icon (Menu Toggle) -->
                <i class="fas fa-bars" id="menuToggle"></i>

                <!-- User Info and Logout button removed from here -->
                <hr style="margin: 20px 0; border-color: var(--spl-border-light);">

                <!-- Sidebar Menu -->
                <nav id="sidebarMenu">
                    <!-- Team Name display within sidebar header -->
                    <div id="sidebarHeader">
                        <span id="sidebarTeamName">Your Team</span>
                    </div>
                    <!-- Analyze My Team menu item removed -->
                    <!-- <a href="#" id="menuAnalyzeMyTeam">Analyze My Team</a> -->
                    <a href="#" id="menuMyControlRoom">My Control Room</a>
                    <a href="#" id="menuAdminDashboard" style="display: none;">Admin Dashboard</a> <!-- Hidden by default, shown to admins -->
                    <p id="sidebarManagerIdText">Manager ID: <span id="displayLoggedInManagerId"></span></p>
                    <button id="logoutButton" class="red-button">Logout</button>
                </nav>
                <!-- Overlay to close menu when clicking outside -->
                <div id="overlay"></div>

                <!-- Content areas remain the same -->

                <!-- Initial Logged-in Dashboard Content (EMPTY HOME PAGE) -->
                <div id="initialLoggedInDashboardContent" style="display: none;">
                    <h2>Welcome to Your Control Room!</h2>
                    <p>Select an option from the menu to get started.</p>
                </div>

                <!-- Analyzer Report Content (REMOVED) -->
                <div id="analyzerReportContent" style="display: none;">
                    <p style="text-align: center; color: var(--spl-text-medium); margin-top: 50px;">
                        The "Analyze My Team" feature has been removed.
                    </p>
                </div>

                <!-- My Control Room Content (initially hidden) -->
                <div id="myControlRoomContent" style="display: none;">
                    <h2>My Control Room</h2>
                    
                    <!-- Main FDR Button for My Control Room -->
                    <button id="showFDRButton">FDR</button>

                    <!-- FDR Systems Container (hidden until FDR button is clicked, contains radio buttons, message box, difficulty scale, tuning, and schedule) -->
                    <div id="fdrSystemsContainer" style="display: none;">
                        <p id="controlRoomMessageBox" class="message-box" style="display: none;"></p>
                        <p>Please Choose FDR System</p>

                        <!-- FDR System Selection Radio Buttons -->
                        <div class="fdr-system-selection">
                            <label>
                                <input type="radio" name="fdrSystem" value="overall" id="radioOverallFDR"> Overall FDR
                            </label>
                            <label>
                                <input type="radio" name="fdrSystem" value="homeAway" id="radioHomeAwayFDR"> Home/Away FDR
                            </label>
                            <label>
                                <input type="radio" name="fdrSystem" value="customized" id="radioCustomizedFDR"> Customized FDR
                            </label>
                            <button id="saveFDRSystemButton">Save as My FDR System</button>
                        </div>

                        <!-- Difficulty Scale: Moved here, just right under the FDR System Selection -->
                        <h5 class="fdr-section-title" style="margin-top: 0;">Fixture Difficulty Scale</h5>
                        <div class="fdr-scale">
                            <div class="fdr-level fdr-1">1<span>Very Easy</span></div>
                            <div class="fdr-level fdr-2">2</div>
                            <div class="fdr-level fdr-3">3</div>
                            <div class="fdr-level fdr-4">4</div>
                            <div class="fdr-level fdr-5">5</div>
                            <div class="fdr-level fdr-6">6</div>
                            <div class="fdr-level fdr-7">7<span>Very Hard</span></div>
                        </div>

                        <!-- Tuning Section (minimal design, no header, only rounds slider) -->
                        <div class="tuning-section">
                            <div class="tuning-option">
                                <label for="roundsToShow">Rounds: <span id="roundsToShowValue">5</span></label>
                                <input type="range" id="roundsToShow" min="3" max="10" value="5">
                            </div>
                            <!-- Removed Show Colors and Show Team Ratings checkboxes -->
                        </div>

                        <!-- FDR Display for My Control Room (dynamically shown based on selection, now contains the schedule tables) -->
                        <div id="myControlRoomFDRDisplay" style="display: none;"> <!-- Initially hidden -->
                            <!-- Overall FDR Display Section for Control Room -->
                            <div id="overallFDRSectionControlRoom" style="display: none;">
                                <h5 class="fdr-section-title">Overall Fixture Difficulty Schedule</h5>
                                <div class="schedule-table-container">
                                    <table class="schedule-table" id="overallScheduleTable">
                                        <thead>
                                            <tr>
                                                <th>Team</th>
                                                <!-- Rounds will be dynamically inserted here -->
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Team rows and fixtures will be dynamically inserted here -->
                                        </tbody>
                                        </table>
                            </div>
                        </div>

                            <!-- Home/Away FDR Display Section for Control Room -->
                            <div id="homeAwayFDRSectionControlRoom" style="display: none;">
                                <h5 class="fdr-section-title">Home/Away Fixture Difficulty Schedule</h5>
                                <div class="schedule-table-container">
                                    <table class="schedule-table" id="homeAwayScheduleTable">
                                        <thead>
                                            <tr>
                                                <th>Team</th>
                                                <!-- Rounds will be dynamically inserted here -->
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Team rows and fixtures will be dynamically inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Customized FDR Display Section for Control Room -->
                            <div id="customizedFDRSectionControlRoom" style="display: none;">
                                <h5 class="fdr-section-title">Customized Fixture Difficulty Schedule</h5>
                                <div class="schedule-table-container">
                                    <table class="schedule-table" id="customizedScheduleTable">
                                        <thead>
                                            <tr>
                                                <th>Team</th>
                                                <!-- Rounds will be dynamically inserted here -->
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Team rows and fixtures will be dynamically inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                                <button id="saveCustomFDRButton" class="mt-4">Save Custom Ratings</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Dashboard Content (initially hidden) -->
                <div id="adminDashboardContent" style="display: none;"> 
                    <h2>Admin Dashboard</h2>
                    <div class="admin-dashboard-nav-buttons">
                        <button id="adminUsersButton">Users</button>
                        <button id="adminDataButton">Data</button>
                    </div>
                    <div class="admin-search-section" style="display: none;">
                        <input type="text" id="adminSearchInput" placeholder="Search by Email, SPL ID, or UID">
                        <button id="adminSearchButton">Search User</button>
                    </div>

                    <div id="adminSearchResults" class="admin-edit-section" style="display: none;">
                        <h3>User Found:</h3>
                        <p>User ID: <strong id="adminUserUid">N/A</strong></p>
                        <p>Current Email: <input type="email" id="adminEditEmail"></p>
                        <p>Current SPL Manager ID: <input type="text" id="adminEditSplManagerId" oninput="this.value = convertArabicToWesternNumerals(this.value)"></p>
                        <button id="adminUpdateUserButton">Update User</button>
                    </div>

                    <div id="adminMessage" class="message-box" style="display: none;"></div>

                    <!-- Data Upload Section (Admin Dashboard) -->
                    <div id="dataUploadSection" style="display: none;">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3">Upload League Tables</h3>
                        <div class="mb-3 input-group">
                            <label for="rankingTypeSelect" class="block text-gray-700 text-sm font-bold mb-2">
                                Select Ranking Type for Upload:
                            </label>
                            <select
                                id="rankingTypeSelect"
                                class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline admin-input"
                            >
                                <option value="overall">Overall Ranking</option>
                                <option value="home">Home Ranking</option>
                                <option value="away">Away Ranking</option>
                            </select>
                        </div>
                        <label class="upload-button-label">
                            Upload Excel File
                            <input
                                type="file"
                                accept=".xlsx, .xls"
                                id="excelFileUploadInput"
                                class="hidden"
                            />
                        </label>
                        <p id="excelUploadMessage" class="mt-2 text-sm text-center message-box" style="display: none;"></p>

                        <!-- NEW: API Fetch Status Messages -->
                        <h3 class="text-xl font-semibold text-gray-700 mb-3 mt-8">API Data Status</h3>
                        <p id="apiTeamNamesStatus" class="mt-2 text-sm text-center message-box" style="display: none;"></p>
                        <p id="apiScheduleStatus" class="mt-2 text-sm text-center message-box" style="display: none;"></p>

                        <!-- Display Current Rankings (Admin) -->
                        <div id="currentRankingsDisplayAdmin" class="mt-8">
                            <h4 class="text-lg font-semibold text-gray-700 mb-3 text-center">Current Rankings Data</h4>
                            
                            <!-- Overall FDR Display Section -->
                            <div id="overallFDRSectionAdmin" style="display: none;">
                                <h5 class="text-md font-semibold text-gray-600 mb-2 text-center">Overall Rankings</h5>
                                <div class="fdr-scale">
                                    <div class="fdr-level fdr-1">1<span>Very Easy</span></div>
                                    <div class="fdr-level fdr-2">2</div>
                                    <div class="fdr-level fdr-3">3</div>
                                    <div class="fdr-level fdr-4">4</div>
                                    <div class="fdr-level fdr-5">5</div>
                                    <div class="fdr-level fdr-6">6</div>
                                    <div class="fdr-level fdr-7">7<span>Very Hard</span></div>
                                </div>
                                <div class="fdr-data-grid" id="overallFDRGridAdmin">
                                    <!-- Team FDR items will be dynamically inserted here by JavaScript -->
                                </div>
                            </div>

                            <!-- Home FDR Display Section -->
                            <div id="homeFDRSectionAdmin" style="display: none; margin-top: 30px;">
                                <h5 class="text-md font-semibold text-gray-600 mb-2 text-center">Home Rankings</h5>
                                <div class="fdr-scale">
                                    <div class="fdr-level fdr-1">1<span>Very Easy</span></div>
                                    <div class="fdr-level fdr-2">2</div>
                                    <div class="fdr-level fdr-3">3</div>
                                    <div class="fdr-level fdr-4">4</div>
                                    <div class="fdr-level fdr-5">5</div>
                                    <div class="fdr-level fdr-6">6<span>Very Hard</span></div>
                                </div>
                                <div class="fdr-single-column-grid" id="homeFDRGridAdmin">
                                    <!-- Team FDR items will be dynamically inserted here by JavaScript -->
                                </div>
                            </div>

                            <!-- Away FDR Display Section -->
                            <div id="awayFDRSectionAdmin" style="display: none; margin-top: 30px;">
                                <h5 class="text-md font-semibold text-gray-600 mb-2 text-center">Away Rankings</h5>
                                <div class="fdr-scale">
                                    <div class="fdr-level fdr-1">1<span>Very Easy</span></div>
                                    <div class="fdr-level fdr-2">2</div>
                                    <div class="fdr-level fdr-3">3</div>
                                    <div class="fdr-level fdr-4">4</div>
                                    <div class="fdr-level fdr-5">5</div>
                                    <div class="fdr-level fdr-6">6<span>Very Hard</span></div>
                                </div>
                                <div class="fdr-single-column-grid" id="awayFDRGridAdmin">
                                    <!-- Team FDR items will be dynamically inserted here by JavaScript -->
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script type="module">
            console.log("DEBUG: Script started running."); // Added for initial script load confirmation

            // Import Firebase modules
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
            import { 
                getAuth, 
                createUserWithEmailAndPassword, 
                signInWithEmailAndPassword, 
                sendEmailVerification, 
                onAuthStateChanged, 
                signOut,
                reload 
            } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
            import { 
                getFirestore, 
                doc, 
                setDoc, 
                getDoc,
                collection, 
                query,      
                where,      
                getDocs,    
                serverTimestamp, 
                updateDoc 
            } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


            // --- Your Firebase Configuration ---
            const firebaseConfig = {
                apiKey: "AIzaSyABljnM2tU8eANL6Eblx_howQDPjB3X7VQ", 
                authDomain: "splcontrolroom-c02c0.firebaseapp.com",
                projectId: "splcontrolroom-c02c0",
                storageBucket: "splcontrolroom-c02c0.firebase-storage.app",
                messagingSenderId: "272416971084",
                appId: "1:272416971084:web:57517048926e49720197e9"
            };
            // ------------------------------------

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);


            // --- NEW: API Endpoints as Placeholder Variables (to be set in Netlify Environment) ---
            // These will be replaced by Netlify at build time with the actual values.
            const BOOTSTRAP_STATIC_API_URL = 'https://en.fantasy.spl.com.sa/api/bootstrap-static/';
            const FIXTURES_API_BASE_URL = 'https://en.fantasy.spl.com.sa/api/fixtures/?event='; 
            // -------------------------------------------------------------------------------------


            // --- GLOBAL FLAGS / VARIABLES ---
            let isProcessingAuth = false; 
            
            let currentManagerId = null; 
            let isAdminUser = false; 
            let foundUserForAdminEdit = null; 

            // Store fetched FDR, schedule, and team mapping data globally
            let globalSplRankings = { overall: [], home: [], away: [] };
            // globalSeasonSchedule will now hold parsed schedule data in a more structured way
            let globalSeasonSchedule = {
                teams: [], // List of all full team names
                rounds: [], // List of all round names (e.g., "R1", "R2", "R31")
                fixtures: {} // { "TeamFullName": { "R1": ["Opponent (H/A)", "Opponent2 (H/A)"], ... } }
            };
            // NEW: Map for API-fetched team data
            let globalTeamData = { // Stores id, name, and short_name for each team
                byId: {}, // { "1": { id: 1, name: "Al Ahli", short_name: "AHL" }, ... }
                byFullName: {}, // { "Al Ahli": { id: 1, name: "Al Ahli", short_name: "AHL" }, ... }
                byShortName: {} // { "AHL": { id: 1, name: "Al Ahli", short_name: "AHL" }, ... }
            };


            // Tuning settings
            let roundsToShow = 5; // Default to 5 rounds
            // The following flags are now ignored for schedule rendering, but kept for future use
            let showColors = true; 
            let showTeamRatings = true;


            // --- DOM Element References ---
            const mainLogo = document.getElementById('mainLogo');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const lightModeLogoSrc = 'unnamed.jpg'; 
            const darkModeLogoSrc = 'dark mode logo.png'; 

            // Authentication UI elements
            const authSection = document.getElementById('authSection');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const authMessageBox = document.getElementById('authMessageBox'); 
            const loginEmailInput = document.getElementById('loginEmail');
            const loginPasswordInput = document.getElementById('loginPassword');
            const loginButton = document.getElementById('loginButton');
            const showSignupLink = document.getElementById('showSignupLink'); 
            const signupEmailInput = document.getElementById('signupEmail');
            const signupPasswordInput = document.getElementById('signupPassword');
            const signupConfirmPasswordInput = document.getElementById('signupConfirmPassword');
            const signupManagerIdInput = document.getElementById('signupManagerId'); 
            const signupButton = document.getElementById('signupButton');
            const showLoginLink = document.getElementById('showLoginLink'); 
            const instructionsBox = document.getElementById('instructionsBox'); 


            // Logged-in / Analyzer UI elements
            const loggedInContent = document.getElementById('loggedInContent');
            
            // NEW Menu Elements
            const menuToggle = document.getElementById('menuToggle');
            const sidebarMenu = document.getElementById('sidebarMenu');
            const overlay = document.getElementById('overlay');
            const sidebarTeamName = document.getElementById('sidebarTeamName'); 
            const menuAnalyzeMyTeam = document.getElementById('menuAnalyzeMyTeam'); // REMOVED FEATURE
            const menuMyControlRoom = document.getElementById('menuMyControlRoom');
            const menuAdminDashboard = document.getElementById('menuAdminDashboard'); 
            const sidebarManagerIdText = document.getElementById('sidebarManagerIdText'); 
            const displayLoggedInManagerId = sidebarManagerIdText.querySelector('span'); 
            const logoutButton = document.getElementById('logoutButton'); 
            
            // Content areas to toggle
            const initialLoggedInDashboardContent = document.getElementById('initialLoggedInDashboardContent'); 
            const analyzerReportContent = document.getElementById('analyzerReportContent'); // REMOVED FEATURE
            const myControlRoomContent = document.getElementById('myControlRoomContent'); 
            const adminDashboardContent = document.getElementById('adminDashboardContent'); 

            // General messages/loading indicators
            const loadingMessage = document.getElementById('loadingMessage'); // Not used in this version, but kept for consistency
            const errorMessage = document.getElementById('errorMessage'); // Not used in this version, but kept for consistency

            // Admin Dashboard specific elements
            const adminDashboardNavButtons = document.querySelector('.admin-dashboard-nav-buttons'); 
            const adminUsersButton = document.getElementById('adminUsersButton'); 
            const adminDataButton = document.getElementById('adminDataButton'); 
            const adminSearchSection = document.querySelector('.admin-search-section'); 
            const adminSearchInput = document.getElementById('adminSearchInput');
            const adminSearchButton = document.getElementById('adminSearchButton');
            const adminSearchResults = document.getElementById('adminSearchResults');
            const adminUserUidElem = document.getElementById('adminUserUid');
            const adminEditEmailInput = document.getElementById('adminEditEmail');
            const adminEditSplManagerIdInput = document.getElementById('adminEditSplManagerId');
            const adminUpdateUserButton = document.getElementById('adminUpdateUserButton');
            const adminMessage = document.getElementById('adminMessage');

            // Data Upload Elements (Admin Dashboard)
            const dataUploadSection = document.getElementById('dataUploadSection');
            const rankingTypeSelect = document.getElementById('rankingTypeSelect');
            const excelFileUploadInput = document.getElementById('excelFileUploadInput');
            const excelUploadMessage = document.getElementById('excelUploadMessage');
            // Removed teamNamesFileUploadInput and scheduleFileUploadInput
            // NEW: API Fetch Status Messages for Admin Dashboard
            const apiTeamNamesStatus = document.getElementById('apiTeamNamesStatus');
            const apiScheduleStatus = document.getElementById('apiScheduleStatus');


            const currentRankingsDisplayAdmin = document.getElementById('currentRankingsDisplayAdmin');
            
            // Specific FDR grid containers (Admin Dashboard)
            const overallFDRSectionAdmin = document.getElementById('overallFDRSectionAdmin');
            const overallFDRGridAdmin = document.getElementById('overallFDRGridAdmin');
            const homeFDRSectionAdmin = document.getElementById('homeFDRSectionAdmin');
            const homeFDRGridAdmin = document.getElementById('homeFDRGridAdmin');
            const awayFDRSectionAdmin = document.getElementById('awayFDRSectionAdmin');
            const awayFDRGridAdmin = document.getElementById('awayFDRGridAdmin');

            // Data Display Elements (My Control Room)
            const showFDRButton = document.getElementById('showFDRButton'); 
            const fdrSystemsContainer = document.getElementById('fdrSystemsContainer'); 
            const controlRoomMessageBox = document.getElementById('controlRoomMessageBox');
            const myControlRoomFDRDisplay = document.getElementById('myControlRoomFDRDisplay'); 
            const radioOverallFDR = document.getElementById('radioOverallFDR');
            const radioHomeAwayFDR = document.getElementById('radioHomeAwayFDR'); 
            const radioCustomizedFDR = document.getElementById('radioCustomizedFDR'); 
            const saveFDRSystemButton = document.getElementById('saveFDRSystemButton'); 

            // Tuning elements
            const roundsToShowSlider = document.getElementById('roundsToShow');
            const roundsToShowValueSpan = document.getElementById('roundsToShowValue');
            // Removed Show Colors and Show Team Ratings toggles from JS as well
            // const showColorsToggle = document.getElementById('showColorsToggle');
            // const showTeamRatingsToggle = document.getElementById('showTeamRatingsToggle');

            // Schedule tables for My Control Room
            const overallFDRSectionControlRoom = document.getElementById('overallFDRSectionControlRoom');
            const overallScheduleTable = document.getElementById('overallScheduleTable');
            const homeAwayFDRSectionControlRoom = document.getElementById('homeAwayFDRSectionControlRoom'); 
            const homeAwayScheduleTable = document.getElementById('homeAwayScheduleTable'); 
            const customizedFDRSectionControlRoom = document.getElementById('customizedFDRSectionControlRoom'); 
            const customizedScheduleTable = document.getElementById('customizedScheduleTable'); 
            const saveCustomFDRButton = document.getElementById('saveCustomFDRButton'); 


            // --- Helper Functions ---

            // Function to display messages in the authMessageBox
            function showAuthMessage(message, type = 'info') {
                if (authMessageBox) {
                    authMessageBox.textContent = ''; 
                    authMessageBox.className = `message-box ${type}`; 
                    authMessageBox.textContent = message; 
                    authMessageBox.style.display = 'block'; 
                } else {
                    console.warn("Auth message box element not found.");
                }
            }

            // Function to display messages in the general errorMessage 
            function showGeneralErrorMessage(message, type = 'info') {
                if (errorMessage) {
                    errorMessage.textContent = ''; 
                    errorMessage.className = `error-message ${type}`; 
                    errorMessage.textContent = message; 
                    errorMessage.style.display = 'block'; 
                } else {
                    console.warn("General error message element not found.");
                }
            }

            // Function to display messages specific to Admin Dashboard
            function showAdminMessage(message, type = 'info') {
                if (adminMessage) {
                    adminMessage.textContent = '';
                    adminMessage.className = `message-box ${type}`;
                    adminMessage.textContent = message;
                    adminMessage.style.display = 'block';
                } else {
                    console.warn("Admin message element not found.");
                }
            }

            // Function to display messages specific to Excel Upload (Admin Dashboard)
            function showExcelUploadMessage(message, type = 'info') {
                if (excelUploadMessage) {
                    excelUploadMessage.textContent = '';
                    excelUploadMessage.className = `message-box ${type}`;
                    excelUploadMessage.textContent = message;
                    excelUploadMessage.style.display = 'block';
                } else {
                    console.warn("Excel upload message element not found.");
                }
            }

            // NEW: Function to display messages specific to API Team Names Status (Admin Dashboard)
            function showApiTeamNamesStatus(message, type = 'info') {
                if (apiTeamNamesStatus) {
                    apiTeamNamesStatus.textContent = '';
                    apiTeamNamesStatus.className = `message-box ${type}`;
                    apiTeamNamesStatus.textContent = message;
                    apiTeamNamesStatus.style.display = 'block';
                } else {
                    console.warn("API Team Names Status element not found.");
                }
            }

            // NEW: Function to display messages specific to API Schedule Status (Admin Dashboard)
            function showApiScheduleStatus(message, type = 'info') {
                if (apiScheduleStatus) {
                    apiScheduleStatus.textContent = '';
                    apiScheduleStatus.className = `message-box ${type}`;
                    apiScheduleStatus.textContent = message;
                    apiScheduleStatus.style.display = 'block';
                } else {
                    console.warn("API Schedule Status element not found.");
                }
            }

            // Function to display messages specific to Control Room
            function showControlRoomMessage(message, type = 'info') {
                if (controlRoomMessageBox) {
                    controlRoomMessageBox.textContent = '';
                    controlRoomMessageBox.className = `message-box ${type}`;
                    controlRoomMessageBox.textContent = message;
                    controlRoomMessageBox.style.display = 'block';
                } else {
                    console.warn("Control Room message box element not found.");
                }
            }

            function hideAllContentSections() {
                if (initialLoggedInDashboardContent) initialLoggedInDashboardContent.style.display = 'none'; 
                if (analyzerReportContent) analyzerReportContent.style.display = 'none';
                if (myControlRoomContent) myControlRoomContent.style.display = 'none';
                if (adminDashboardContent) adminDashboardContent.style.display = 'none'; 
                
                // Admin Dashboard specific elements to manage
                if (adminDashboardNavButtons) adminDashboardNavButtons.style.display = 'none'; 
                if (adminSearchSection) adminSearchSection.style.display = 'none'; 
                if (adminSearchResults) adminSearchResults.style.display = 'none'; 
                if (adminMessage) adminMessage.style.display = 'none';      
                
                // Hide data upload specific elements (Admin)
                if (dataUploadSection) dataUploadSection.style.display = 'none';
                if (currentRankingsDisplayAdmin) currentRankingsDisplayAdmin.style.display = 'none';
                if (excelUploadMessage) excelUploadMessage.style.display = 'none';
                // Hide API Status messages when not in data section
                if (apiTeamNamesStatus) apiTeamNamesStatus.style.display = 'none';
                if (apiScheduleStatus) apiScheduleStatus.style.display = 'none';

                if (overallFDRSectionAdmin) overallFDRSectionAdmin.style.display = 'none'; 
                if (homeFDRSectionAdmin) homeFDRSectionAdmin.style.display = 'none';
                if (awayFDRSectionAdmin) awayFDRSectionAdmin.style.display = 'none';

                // Hide Control Room specific elements
                if (showFDRButton) showFDRButton.style.display = 'none'; 
                if (fdrSystemsContainer) fdrSystemsContainer.style.display = 'none'; 
                if (myControlRoomFDRDisplay) myControlRoomFDRDisplay.style.display = 'none'; // Ensure this is hidden
                if (overallFDRSectionControlRoom) overallFDRSectionControlRoom.style.display = 'none'; 
                if (homeAwayFDRSectionControlRoom) homeAwayFDRSectionControlRoom.style.display = 'none'; 
                if (customizedFDRSectionControlRoom) customizedFDRSectionControlRoom.style.display = 'none'; 
                if (controlRoomMessageBox) controlRoomMessageBox.style.display = 'none';


                // General messages/loading indicators (these are not used in current version, but kept)
                // if (loadingMessage) loadingMessage.style.display = 'none';
                // if (errorMessage) errorMessage.style.display = 'none';
                if (authMessageBox) authMessageBox.style.display = 'none'; 
            }

            // Function to clear admin search results and input fields
            function clearAdminSearchAndResults() {
                if (adminSearchInput) adminSearchInput.value = '';
                if (adminUserUidElem) adminUserUidElem.textContent = 'N/A';
                if (adminEditEmailInput) adminEditEmailInput.value = '';
                if (adminEditSplManagerIdInput) adminEditSplManagerIdInput.value = '';
                foundUserForAdminEdit = null;
                if (adminSearchSection) adminSearchSection.style.display = 'none'; 
                if (adminSearchResults) adminSearchResults.style.display = 'none'; 
                if (adminMessage) adminMessage.style.display = 'none';      
            }

            function convertArabicToWesternNumerals(input) {
                const arabicNumerals = ['', '', '', '', '', '', '', '', '', ''];
                const westernNumerals = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
                let convertedInput = input;
                for (let i = 0; i < arabicNumerals.length; i++) {
                    const regex = new RegExp(arabicNumerals[i], 'g');
                    convertedInput = convertedInput.replace(regex, westernNumerals[i]);
                }
                return convertedInput;
            }

            function setTheme(theme) {
                console.log("DEBUG: Setting theme to:", theme); 
                if (theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    if (mainLogo) mainLogo.src = darkModeLogoSrc;
                    if (darkModeToggle) darkModeToggle.checked = true;
                } else {
                    document.body.classList.remove('dark-mode');
                    if (mainLogo) mainLogo.src = lightModeLogoSrc;
                    if (darkModeToggle) darkModeToggle.checked = false;
                }
                localStorage.setItem('theme', theme);
            }

            // --- Authentication Logic ---

            // Handle Signup
            if (signupButton) {
                signupButton.addEventListener('click', async () => {
                    showAuthMessage("Processing...", "info");
                    isProcessingAuth = true; 

                    const email = signupEmailInput.value.trim();
                    const password = signupPasswordInput.value;
                    const confirmPassword = signupConfirmPasswordInput.value;
                    const managerId = convertArabicToWesternNumerals(signupManagerIdInput.value.trim());

                    if (!email || !password || !confirmPassword || !managerId) {
                        showAuthMessage("All fields are required.", "error");
                        isProcessingAuth = false;
                        return;
                    }
                    if (password !== confirmPassword) {
                        showAuthMessage("Passwords do not match.", "error");
                        isProcessingAuth = false; 
                        return;
                    }
                    if (password.length < 6) {
                        showAuthMessage("Password must be at least 6 characters long.", "error");
                        isProcessingAuth = false; 
                        return;
                    }
                    if (!/^\d+$/.test(managerId)) {
                        showAuthMessage("SPL Manager ID is required and must be a valid number.", "error");
                        isProcessingAuth = false; 
                        return;
                    }

                    try {
                        console.log("DEBUG: Attempting to create user with email:", email);
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;
                        console.log("DEBUG: User created successfully. UID:", user.uid, "Email:", user.email);

                        // Save user data to Firestore
                        console.log("DEBUG: Attempting to save user data to Firestore for UID:", user.uid);
                        await setDoc(doc(db, "users", user.uid), {
                            email: user.email,
                            splManagerId: managerId,
                            createdAt: serverTimestamp(),
                            emailVerified: false,
                            preferredFDRSystem: 'overall' // Default preferred FDR system
                        });
                        console.log("DEBUG: User data saved to Firestore with default FDR system.");

                        // Send email verification
                        console.log("DEBUG: Attempting to send email verification for user:", user.email, "UID:", user.uid);
                        try {
                            await sendEmailVerification(user); 
                            console.log("DEBUG: Email verification sent successfully (Firebase API acknowledged request).");
                        } catch (emailError) {
                            console.error("ERROR: Failed to send email verification during signup:", emailError);
                            showAuthMessage(`Account created, but failed to send verification email: ${emailError.message}. Please check your email's spam folder or try logging in after a few minutes to trigger resend.`, "warning");
                        }
                        
                        // Log out the user immediately after signup to force email verification
                        console.log("DEBUG: Signing user out after signup to force verification flow.");
                        await signOut(auth); 
                        console.log("DEBUG: User signed out after signup.");

                        showAuthMessage("Account created! Please verify your email and then log in. If the confirmation e-mail is not in your inbox please check your spam folder", "success");
                        
                        // Clear form fields
                        if (signupEmailInput) signupEmailInput.value = '';
                        if (signupPasswordInput) signupPasswordInput.value = '';
                        if (signupConfirmPasswordInput) signupConfirmPasswordInput.value = '';
                        if (signupManagerIdInput) signupManagerIdInput.value = '';
                        // Switch to login form
                        if (loginForm) loginForm.style.display = 'block'; 
                        if (signupForm) signupForm.style.display = 'none';
                        if (instructionsBox) instructionsBox.style.display = 'none'; // Hide instructions after successful signup

                    } catch (error) {
                        console.error("Signup failed (main try-catch):", error);
                        let friendlyMessage = "Failed to create account. Please try again.";
                        if (error.code === 'auth/email-already-in-use') {
                            friendlyMessage = "That email address is already in use.";
                        } else if (error.code === 'auth/invalid-email') {
                            friendlyMessage = "Please enter a valid email address.";
                        } else if (error.code === 'auth/weak-password') {
                            friendlyMessage = "Password is too weak.";
                        } else {
                            friendlyMessage = `Failed to create account: ${error.message}`; 
                        }
                        showAuthMessage(friendlyMessage, "error");
                    } finally {
                        isProcessingAuth = false; 
                    }
                });
            }

            // Handle Login
            if (loginButton) {
                loginButton.addEventListener('click', async () => {
                    showAuthMessage("Logging in...", "info");
                    isProcessingAuth = true;

                    const email = loginEmailInput.value.trim();
                    const password = loginPasswordInput.value;

                    try {
                        const userCredential = await signInWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;

                        await reload(user); 

                        if (!user.emailVerified) {
                            await signOut(auth); 
                            showAuthMessage("Please verify your email address before logging in.", "info"); 
                            return;
                        }
                        
                        const userDocRef = doc(db, "users", user.uid);
                        const userDocSnap = await getDoc(userDocRef);

                        if (userDocSnap.exists()) {
                            const userData = userDocSnap.data();
                            console.log("User data from Firestore on login:", userData);

                            if (!userData.emailVerified && user.emailVerified) {
                                await updateDoc(userDocRef, { emailVerified: true });
                                userData.emailVerified = true; 
                            }

                            const userManagerId = userData.splManagerId;

                            if (userManagerId && /^\d+$/.test(userManagerId)) {
                                if (displayLoggedInManagerId) displayLoggedInManagerId.textContent = userManagerId;
                                // sidebarTeamName is now just a static "Your Team" or similar, no dynamic user team name
                                
                                if (authSection) authSection.style.display = 'none'; // Hide auth section
                                if (loggedInContent) loggedInContent.style.display = 'block'; // Show the main logged-in container
                                
                                currentManagerId = userManagerId; 

                                const adminDocRef = doc(db, "admins", user.uid);
                                const adminDocSnap = await getDoc(adminDocRef);
                                isAdminUser = adminDocSnap.exists();
                                console.log(`DEBUG AUTH STATE (Login Button): User UID: ${user.uid}, Is Admin: ${isAdminUser}, Admin doc exists: ${adminDocSnap.exists()}`);
                                
                                if (menuAdminDashboard) menuAdminDashboard.style.display = isAdminUser ? 'block' : 'none';
                                console.log(`DEBUG ADMIN MENU ITEM RENDER (Login Button Direct): Admin menu item visibility set to: ${menuAdminDashboard.style.display}`);

                                // Show menu toggle icon
                                if (menuToggle) menuToggle.style.display = 'block';

                                // Show initial logged-in dashboard (empty home page)
                                showContentSection('initialLoggedInDashboard');

                                // Fetch all global data (rankings, schedule, team mappings) once on auth state change
                                await fetchGlobalFDRData();

                            } else {
                                showAuthMessage("No valid SPL Manager ID found for your account. Please contact support.", "error");
                                await signOut(auth); 
                            }
                        } else {
                            showAuthMessage("User data not found. Please contact support.", "error"); 
                            await signOut(auth);
                        }
                        if (loginPasswordInput) loginPasswordInput.value = ''; 

                    } catch (error) {
                        console.error("Login failed:", error);
                        let friendlyMessage = "Login failed. Please check your email and password.";
                        if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                            friendlyMessage = "Invalid email or password.";
                        }
                        showAuthMessage(friendlyMessage, "error"); 
                    } finally {
                        isProcessingAuth = false; 
                    }
                });
            }

            // Handle Logout
            if (logoutButton) {
                logoutButton.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        showAuthMessage("Logged out successfully.", "info"); 
                        isAdminUser = false; 
                        if (menuAdminDashboard) menuAdminDashboard.style.display = 'none';
                        if (menuToggle) menuToggle.style.display = 'none';
                        if (loggedInContent) loggedInContent.style.display = 'none'; 
                        // Restore auth section and login form after logout
                        if (authSection) authSection.style.display = 'block'; 
                        if (loginForm) loginForm.style.display = 'block'; 
                        if (signupForm) signupForm.style.display = 'none';
                        if (instructionsBox) instructionsBox.style.display = 'none';
                        if (sidebarMenu) sidebarMenu.classList.remove('open');
                        if (overlay) overlay.style.display = 'none';
                        if (sidebarTeamName) sidebarTeamName.textContent = 'Your Team'; // Reset to generic
                        if (displayLoggedInManagerId) displayLoggedInManagerId.textContent = '';
                    } catch (error) {
                        console.error("Logout error:", error);
                        showAuthMessage("Failed to logout. Please try again.", "error"); 
                    }
                });
            }

            // Toggle between Login and Signup forms (showSignupLink is from login form to signup form)
            if (showSignupLink) {
                showSignupLink.addEventListener('click', (e) => {
                    console.log("DEBUG: 'Sign Up' link clicked."); 
                    e.preventDefault();
                    if (loginForm) loginForm.style.display = 'none';
                    if (signupForm) signupForm.style.display = 'block'; 
                    if (authMessageBox) authMessageBox.style.display = 'none'; 
                    if (authMessageBox) authMessageBox.textContent = ''; 
                    if (instructionsBox) instructionsBox.style.display = 'block';
                });
            }

            // Toggle between Login and Signup forms (showLoginLink is from signup form to login form)
            if (showLoginLink) {
                showLoginLink.addEventListener('click', (e) => {
                    console.log("DEBUG: 'Login' link clicked."); 
                    e.preventDefault();
                    if (loginForm) loginForm.style.display = 'block'; 
                    if (signupForm) signupForm.style.display = 'none';
                    if (authMessageBox) authMessageBox.style.display = 'none'; 
                    if (authMessageBox) authMessageBox.textContent = ''; 
                    if (instructionsBox) instructionsBox.style.display = 'none';
                });
            }


            // --- Authentication State Listener (Core UI Logic) ---
            onAuthStateChanged(auth, async (user) => {
                console.log("DEBUG: onAuthStateChanged fired. User:", user ? user.uid : "null");

                if (isProcessingAuth) { 
                    console.log("DEBUG: onAuthStateChanged deferred due to active auth process.");
                    return; 
                }

                if (user) {
                    console.log("DEBUG: User detected, checking email verification and data...");
                    await reload(user); 

                    if (user.emailVerified) {
                        console.log("DEBUG: Email verified. Fetching user document...");
                        const userDocRef = doc(db, "users", user.uid);
                        const userDocSnap = await getDoc(userDocRef);

                        if (userDocSnap.exists()) {
                            const userData = userDocSnap.data();
                            console.log("DEBUG: User data from Firestore:", userData);
                            
                            // Update emailVerified status in Firestore if it's false but Firebase auth says true
                            if (!userData.emailVerified && user.emailVerified) {
                                await updateDoc(userDocRef, { emailVerified: true });
                                userData.emailVerified = true; 
                            }

                            const userManagerId = userData.splManagerId;

                            if (userManagerId && /^\d+$/.test(userManagerId)) {
                                console.log("DEBUG: Valid Manager ID found. Displaying logged-in content.");
                                if (displayLoggedInManagerId) displayLoggedInManagerId.textContent = userManagerId;
                                // sidebarTeamName is now just a static "Your Team" or similar, no dynamic user team name
                                
                                if (authSection) authSection.style.display = 'none'; 
                                if (loggedInContent) loggedInContent.style.display = 'block'; 
                                
                                currentManagerId = userManagerId; 

                                const adminDocRef = doc(db, "admins", user.uid);
                                const adminDocSnap = await getDoc(adminDocRef);
                                isAdminUser = adminDocSnap.exists();
                                console.log(`DEBUG AUTH STATE (Login Button): User UID: ${user.uid}, Is Admin: ${isAdminUser}, Admin doc exists: ${adminDocSnap.exists()}`);
                                
                                if (menuAdminDashboard) menuAdminDashboard.style.display = isAdminUser ? 'block' : 'none';
                                console.log(`DEBUG ADMIN MENU ITEM RENDER (onAuthStateChanged): Admin menu item visibility set to: ${menuAdminDashboard.style.display}`);

                                // Show menu toggle icon
                                if (menuToggle) menuToggle.style.display = 'block';

                                // Default to the initial logged-in dashboard (empty home page)
                                showContentSection('initialLoggedInDashboard');

                                // Fetch all global data (rankings, schedule, team mappings) once on auth state change
                                await fetchGlobalFDRData();

                            } else {
                                console.warn("DEBUG: No valid SPL Manager ID found for user. Logging out.");
                                showAuthMessage("No valid SPL Manager ID found for your account. Please contact support or re-signup.", "error");
                                await signOut(auth); 
                                // Ensure auth section is visible after logout
                                if (authSection) authSection.style.display = 'block';
                                if (loginForm) loginForm.style.display = 'block'; 
                                if (signupForm) signupForm.style.display = 'none';
                                if (loggedInContent) loggedInContent.style.display = 'none'; 
                                if (instructionsBox) instructionsBox.style.display = 'none'; 
                            }
                        } else {
                            console.warn("DEBUG: Firestore document for user does not exist. Logging out.");
                            showAuthMessage("User data not found. Please contact support. Logging out.", "error");
                            await signOut(auth); 
                            // Ensure auth section is visible after logout
                            if (authSection) authSection.style.display = 'block';
                            if (loginForm) loginForm.style.display = 'block'; 
                            if (signupForm) signupForm.style.display = 'none';
                            if (loggedInContent) loggedInContent.style.display = 'none'; 
                            if (instructionsBox) instructionsBox.style.display = 'none'; 
                        }
                    } else {
                        console.log("DEBUG: Email not verified. Logging out.");
                        showAuthMessage("Please verify your email address to access the analyzer.", "info");
                        // Ensure auth section is visible
                        if (authSection) authSection.style.display = 'block';
                        if (loginForm) loginForm.style.display = 'block'; 
                        if (signupForm) signupForm.style.display = 'none';
                        if (loggedInContent) loggedInContent.style.display = 'none'; 
                        if (instructionsBox) instructionsBox.style.display = 'none'; 
                    }
                } else {
                    console.log("DEBUG: No user detected. Displaying authentication section.");
                    // User is not logged in
                    if (authSection) authSection.style.display = 'block'; 
                    if (loginForm) loginForm.style.display = 'block'; 
                    if (signupForm) signupForm.style.display = 'none';
                    if (loggedInContent) loggedInContent.style.display = 'none'; 
                    isAdminUser = false; 
                    if (menuAdminDashboard) menuAdminDashboard.style.display = 'none'; 
                    if (menuToggle) menuToggle.style.display = 'none'; 
                    if (instructionsBox) instructionsBox.style.display = 'none'; 
                    if (sidebarMenu) sidebarMenu.classList.remove('open'); 
                    if (overlay) overlay.style.display = 'none'; 
                    if (sidebarTeamName) sidebarTeamName.textContent = 'Your Team'; 
                    if (displayLoggedInManagerId) displayLoggedInManagerId.textContent = ''; 
                }
            });

            /**
             * Manages the display of main content sections based on navigation button clicks.
             * @param {string} sectionId - 'initialLoggedInDashboard', 'analyzerReport', 'controlRoom', or 'adminDashboard'.
             */
            async function showContentSection(sectionId) {
                console.log(`DEBUG: showContentSection called for section: ${sectionId}`);
                hideAllContentSections(); // Hide all content sub-sections first
                
                if (sectionId === 'initialLoggedInDashboard') { 
                    if (initialLoggedInDashboardContent) initialLoggedInDashboardContent.style.display = 'flex';
                } else if (sectionId === 'analyzerReport') {
                    if (analyzerReportContent) analyzerReportContent.style.display = 'block';
                    console.log("DEBUG: Analyzer Report section is now empty.");
                } else if (sectionId === 'controlRoom') {
                    if (myControlRoomContent) myControlRoomContent.style.display = 'block';
                    if (showFDRButton) showFDRButton.style.display = 'block'; // Show the main FDR button
                    // Ensure FDR systems container is hidden until FDR button is clicked
                    if (fdrSystemsContainer) fdrSystemsContainer.style.display = 'none'; 
                    if (myControlRoomFDRDisplay) myControlRoomFDRDisplay.style.display = 'none'; // Ensure this is hidden
                    if (controlRoomMessageBox) controlRoomMessageBox.style.display = 'none'; 
                } else if (sectionId === 'adminDashboard') {
                    if (isAdminUser) { 
                        if (adminDashboardContent) adminDashboardContent.style.display = 'flex'; 
                        if (adminDashboardNavButtons) adminDashboardNavButtons.style.display = 'flex'; 
                        // Default to showing the Users section when Admin Dashboard is first opened
                        if (adminUsersButton) adminUsersButton.click(); 
                        showAdminMessage("Admin Dashboard loaded. Select an option.", "info"); 
                    } else {
                        console.warn("Attempted to access Admin Dashboard without admin privileges.");
                        showGeneralErrorMessage("Access Denied: You do not have administrator privileges.", "error"); 
                    }
                }
            }

            // --- Admin Dashboard Logic ---

            // Helper function to search by UID
            async function searchUserByUid(uid) {
                console.log(`DEBUG: Attempting search by UID: ${uid}`);
                try {
                    const userDocRef = doc(db, "users", uid);
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        console.log("DEBUG: User found by UID:", docSnap.data());
                        return { id: docSnap.id, ...docSnap.data() };
                    }
                    console.log("DEBUG: No user found for UID:", uid);
                    return null;
                } catch (error) {
                    console.error("ERROR: Failed to search user by UID:", error.code, error.message);
                    return null;
                }
            }

            // Helper function to search by Email
            async function searchUserByEmail(email) {
                // Basic regex to validate email format before querying
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    console.log(`DEBUG: Not a valid email format for search: ${email}`);
                    return null;
                }
                console.log(`DEBUG: Attempting search by Email: ${email}`);
                try {
                    const q = query(collection(db, "users"), where("email", "==", email));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        console.log("DEBUG: User found by Email:", querySnapshot.docs[0].data());
                        return { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
                    }
                    console.log("DEBUG: No user found for email:", email);
                    return null;
                } catch (error) {
                    console.error("ERROR: Failed to search user by Email:", error.code, error.message);
                    return null;
                }
            }

            // Helper function to search by SPL Manager ID
            async function searchUserBySplManagerId(splManagerId) {
                const convertedSplId = convertArabicToWesternNumerals(splManagerId);
                // Ensure it's purely numeric after conversion
                if (!/^\d+$/.test(convertedSplId)) {
                    console.log(`DEBUG: Not a valid numeric SPL Manager ID after conversion: ${splManagerId} -> ${convertedSplId}`);
                    return null;
                }
                console.log(`DEBUG: Attempting search by SPL Manager ID: ${convertedSplId}`);
                try {
                    const q = query(collection(db, "users"), where("splManagerId", "==", convertedSplId));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        console.log("DEBUG: User found by SPL Manager ID:", querySnapshot.docs[0].data());
                        return { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
                    }
                    console.log("DEBUG: No user found for SPL Manager ID:", convertedSplId);
                    return null;
                } catch (error) {
                    console.error("ERROR: Failed to search user by SPL Manager ID:", error.code, error.message);
                    return null;
                }
            }

            if (adminSearchButton) {
                adminSearchButton.addEventListener('click', async () => {
                    showAdminMessage("Searching...", "info");
                    if (adminSearchResults) adminSearchResults.style.display = 'none'; 
                    foundUserForAdminEdit = null; 

                    const searchTerm = adminSearchInput.value.trim();
                    if (!searchTerm) {
                        showAdminMessage("Please enter a search term (Email, SPL ID, or UID).", "error");
                        return;
                    }
                    
                    let userFoundData = null;

                    userFoundData = await searchUserByUid(searchTerm);

                    if (!userFoundData && searchTerm.includes('@')) { 
                        userFoundData = await searchUserByEmail(searchTerm);
                    }

                    if (!userFoundData && /^\d+$/.test(searchTerm)) {
                        userFoundData = await searchUserBySplManagerId(searchTerm);
                    }
                    
                    if (userFoundData) {
                        foundUserForAdminEdit = userFoundData; 
                        if (adminUserUidElem) adminUserUidElem.textContent = userFoundData.id;
                        if (adminEditEmailInput) adminEditEmailInput.value = userFoundData.email || '';
                        if (adminEditSplManagerIdInput) adminEditSplManagerIdInput.value = userFoundData.splManagerId || '';
                        if (adminSearchResults) adminSearchResults.style.display = 'flex'; 
                        showAdminMessage("User found successfully.", "success");
                    } else {
                        showAdminMessage("User not found. Please check the search term or if the user exists.", "error");
                        if (adminSearchResults) adminSearchResults.style.display = 'none'; 
                    }
                });
            }

            if (adminSearchInput) {
                adminSearchInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault(); 
                        if (adminSearchButton) adminSearchButton.click(); 
                    }
                });
            }


            if (adminUpdateUserButton) {
                adminUpdateUserButton.addEventListener('click', async () => {
                    if (!foundUserForAdminEdit) {
                        showAdminMessage("No user selected for update. Please search for a user first.", "error");
                        return;
                    }

                    showAdminMessage("Updating user...", "info");

                    const newEmail = adminEditEmailInput.value.trim();
                    const newSplManagerId = convertArabicToWesternNumerals(adminEditSplManagerIdInput.value.trim()); 
                    const userToUpdateUid = foundUserForAdminEdit.id;

                    if (!newEmail || !newSplManagerId) {
                        showAdminMessage("Email and SPL Manager ID cannot be empty.", "error");
                        return;
                    }
                    if (!/^\d+$/.test(newSplManagerId)) {
                        showAdminMessage("SPL Manager ID must be a valid number.", "error");
                        return;
                    }

                    try {
                        const userDocRef = doc(db, "users", userToUpdateUid);
                        await updateDoc(userDocRef, {
                            email: newEmail,
                            splManagerId: newSplManagerId 
                        });
                        showAdminMessage("User updated successfully!", "success");
                        if (adminSearchInput) adminSearchInput.value = userToUpdateUid; 
                        if (adminSearchButton) await adminSearchButton.click(); 
                    } catch (error) {
                        console.error("Admin update failed:", error);
                        let friendlyMessage = "Failed to update user. Please try again.";
                        if (error.code === 'permission-denied') {
                            friendlyMessage = "Permission denied. You might not have the necessary admin rights or the security rules prevented the update.";
                        } else if (error.code === 'invalid-argument') {
                            friendlyMessage = "Invalid data provided. Please check the email format or SPL Manager ID.";
                        }
                        showAdminMessage(`Update failed: ${friendlyMessage} Details: ${error.message}`, "error");
                    }
                });
            }

            // Admin Dashboard Sub-Navigation Logic
            if (adminUsersButton) {
                adminUsersButton.addEventListener('click', () => {
                    if (adminSearchSection) adminSearchSection.style.display = 'flex'; 
                    if (adminSearchResults) adminSearchResults.style.display = 'none'; 
                    if (adminMessage) adminMessage.style.display = 'none'; 
                    if (dataUploadSection) dataUploadSection.style.display = 'none'; 
                    if (currentRankingsDisplayAdmin) currentRankingsDisplayAdmin.style.display = 'none'; 
                    if (overallFDRSectionAdmin) overallFDRSectionAdmin.style.display = 'none'; 
                    if (homeFDRSectionAdmin) homeFDRSectionAdmin.style.display = 'none';
                    if (awayFDRSectionAdmin) awayFDRSectionAdmin.style.display = 'none';
                    // Hide API status messages when switching to users tab
                    if (apiTeamNamesStatus) apiTeamNamesStatus.style.display = 'none';
                    if (apiScheduleStatus) apiScheduleStatus.style.display = 'none';
                    showAdminMessage("Enter user details to search.", "info");
                });
            }

            if (adminDataButton) {
                adminDataButton.addEventListener('click', async () => { // Made async to await API fetches
                    if (adminSearchSection) adminSearchSection.style.display = 'none'; 
                    if (adminSearchResults) adminSearchResults.style.display = 'none'; 
                    if (adminMessage) adminMessage.style.display = 'none'; 
                    if (dataUploadSection) dataUploadSection.style.display = 'block'; 
                    if (currentRankingsDisplayAdmin) currentRankingsDisplayAdmin.style.display = 'block'; 
                    showExcelUploadMessage("Upload your league table Excel file here.", "info");
                    // Show API Status messages when in data section
                    if (apiTeamNamesStatus) apiTeamNamesStatus.style.display = 'block';
                    if (apiScheduleStatus) apiScheduleStatus.style.display = 'block';

                    // Call fetchGlobalFDRData to re-fetch all data including API data
                    await fetchGlobalFDRData();

                    // Update API status messages after fetching
                    if (Object.keys(globalTeamData.byId).length > 0) {
                        showApiTeamNamesStatus(`Team Names (from API) fetched successfully. Found ${Object.keys(globalTeamData.byId).length} teams.`, "success");
                    } else {
                        showApiTeamNamesStatus("Team Names (from API) could not be fetched or data is empty. Check API connection and Netlify environment variables.", "error");
                    }

                    if (Object.keys(globalSeasonSchedule.fixtures).length > 0 && globalSeasonSchedule.rounds.length > 0) {
                        showApiScheduleStatus(`Season Schedule (from API) fetched successfully. Found ${globalSeasonSchedule.rounds.length} rounds.`, "success");
                    } else {
                        showApiScheduleStatus("Season Schedule (from API) could not be fetched or data is empty. Check API connection and Netlify environment variables.", "error");
                    }

                    // Re-render rankings for Admin Dashboard
                    fetchAndRenderRankings(excelUploadMessage, overallFDRGridAdmin, homeFDRGridAdmin, awayFDRGridAdmin, overallFDRSectionAdmin, homeFDRSectionAdmin, awayFDRSectionAdmin, currentRankingsDisplayAdmin);
                });
            }


            // --- Excel File Upload Logic (Admin Dashboard) ---
            if (excelFileUploadInput) {
                excelFileUploadInput.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (!file) {
                        showExcelUploadMessage('No file selected.', "error");
                        return;
                    }

                    if (typeof window.XLSX === 'undefined') {
                        showExcelUploadMessage('Excel library (XLSX.js) not loaded. Please try refreshing the page.', "error");
                        console.error("window.XLSX is not defined. Excel library not loaded.");
                        return;
                    }

                    showExcelUploadMessage('Uploading and processing Excel file...', "info");

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' }); 

                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonRows = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); 

                            if (jsonRows.length < 2) {
                                showExcelUploadMessage('Excel file is empty or missing data rows.', "error");
                                return;
                            }

                            const headerRow = jsonRows[0].map(h => String(h).trim().toLowerCase());
                            
                            const selectedRankingType = rankingTypeSelect.value; 
                            let expectedHeaders;
                            let fdrColumnName1, fdrColumnName2; 
                            let fdrColumnNameSingle; 

                            if (selectedRankingType === 'overall') {
                                expectedHeaders = {
                                    rank: ['rank', 'ranking number'],
                                    team: ['team', 'team name'],
                                    fdrHome: ['fdr home', 'home fdr', 'fdr rating home'], 
                                    fdrAway: ['fdr away', 'away fdr', 'fdr rating away']  
                                };
                                fdrColumnName1 = 'fdrHome';
                                fdrColumnName2 = 'fdrAway';
                            } else if (selectedRankingType === 'home') {
                                expectedHeaders = {
                                    rank: ['rank', 'ranking number'],
                                    team: ['team', 'team name'],
                                    fdrAway: ['fdr away', 'away fdr', 'fdr rating away'] 
                                };
                                fdrColumnNameSingle = 'fdrAway';
                            } else if (selectedRankingType === 'away') {
                                expectedHeaders = {
                                    rank: ['rank', 'ranking number'],
                                    team: ['team', 'team name'],
                                    fdrHome: ['fdr home', 'home fdr', 'fdr rating home'] 
                                };
                                fdrColumnNameSingle = 'fdrHome';
                            } else {
                                showExcelUploadMessage('Invalid ranking type selected.', "error");
                                return;
                            }

                            const getColumnIndex = (headers, aliases) => {
                                for (const alias of aliases) {
                                    const index = headers.indexOf(alias);
                                    if (index !== -1) return index;
                                }
                                return -1;
                            };

                            const rankIndex = getColumnIndex(headerRow, expectedHeaders.rank);
                            const teamIndex = getColumnIndex(headerRow, expectedHeaders.team);

                            let fdrCol1Index = -1;
                            let fdrCol2Index = -1;
                            let fdrColSingleIndex = -1;

                            if (selectedRankingType === 'overall') {
                                fdrCol1Index = getColumnIndex(headerRow, expectedHeaders.fdrHome);
                                fdrCol2Index = getColumnIndex(headerRow, expectedHeaders.fdrAway);
                                if (rankIndex === -1 || teamIndex === -1 || fdrCol1Index === -1 || fdrCol2Index === -1) {
                                    showExcelUploadMessage('Invalid Excel headers for Overall Ranking. Expected "Rank", "Team", "FDR Home", and "FDR Away".', "error");
                                    return;
                                }
                            } else {
                                fdrColSingleIndex = getColumnIndex(headerRow, expectedHeaders[fdrColumnNameSingle]);
                                if (rankIndex === -1 || teamIndex === -1 || fdrColSingleIndex === -1) {
                                    showExcelUploadMessage(`Invalid Excel headers for ${selectedRankingType.charAt(0).toUpperCase() + selectedRankingType.slice(1)} Ranking. Expected "Rank", "Team", and "FDR ${fdrColumnNameSingle === 'fdrHome' ? 'Home' : 'Away'}".`, "error");
                                    return;
                                }
                            }

                            const parsedRankings = [];
                            for (let i = 1; i < jsonRows.length; i++) {
                                const row = jsonRows[i];
                                const team = String(row[teamIndex]).trim();
                                const rank = parseInt(row[rankIndex], 10);
                                let fdrValue1, fdrValue2;

                                let isValid = false;

                                if (selectedRankingType === 'overall') {
                                    fdrValue1 = parseInt(row[fdrCol1Index], 10);
                                    fdrValue2 = parseInt(row[fdrCol2Index], 10);
                                    if (!isNaN(rank) && team && !isNaN(fdrValue1) && !isNaN(fdrValue2) &&
                                        fdrValue1 >=1 && fdrValue1 <= 7 && fdrValue2 >= 1 && fdrValue2 <= 7) {
                                        parsedRankings.push({ rank, team, fdrHome: fdrValue1, fdrAway: fdrValue2 });
                                        isValid = true;
                                    }
                                } else {
                                    fdrValue1 = parseInt(row[fdrColSingleIndex], 10);
                                    if (!isNaN(rank) && team && !isNaN(fdrValue1) &&
                                        fdrValue1 >=1 && fdrValue1 <= 6) { 
                                        if (selectedRankingType === 'home') {
                                            parsedRankings.push({ rank, team, fdrAway: fdrValue1 }); 
                                        } else { // selectedRankingType === 'away'
                                            parsedRankings.push({ rank, team, fdrHome: fdrValue1 }); 
                                        }
                                        isValid = true;
                                    }
                                }

                                if (!isValid) {
                                    console.warn(`Skipping row ${i+1} due to invalid data or FDR out of range (1-7 for Overall, 1-6 for Home/Away): Row Data:`, row);
                                }
                            }

                            if (parsedRankings.length === 0) {
                                showExcelUploadMessage('No valid ranking data found in the Excel file after parsing. Ensure all columns are present and FDRs are in the correct range (1-7 for Overall, 1-6 for Home/Away).', "error");
                                return;
                            }

                            const seasonId = "2025-2026"; 
                            const splRankingsDocRef = doc(db, 'splRankings', seasonId); 

                            // No need to merge, just set the specific ranking type
                            await setDoc(splRankingsDocRef, {
                                season: seasonId,
                                lastUpdated: serverTimestamp(),
                                [selectedRankingType]: parsedRankings 
                            }, { merge: true }); // Use merge: true to avoid overwriting other ranking types

                            showExcelUploadMessage(`Successfully uploaded ${selectedRankingType} rankings from Excel!`, "success");
                            event.target.value = null; 
                            // Re-fetch all global data after upload (including API data)
                            await fetchGlobalFDRData();
                            // Re-render rankings for Admin Dashboard
                            fetchAndRenderRankings(excelUploadMessage, overallFDRGridAdmin, homeFDRGridAdmin, awayFDRGridAdmin, overallFDRSectionAdmin, homeFDRSectionAdmin, awayFDRSectionAdmin, currentRankingsDisplayAdmin);
                        } catch (error) {
                            console.error('Error processing Excel file or uploading to Firestore:', error);
                            showExcelUploadMessage(`Failed to process Excel or upload: ${error.message}. Please check file format and console for details.`, "error");
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });
            }

            /**
             * Fetches all necessary global FDR data (rankings, schedule, and team mappings) from Firestore
             * and stores them in global variables.
             */
            async function fetchGlobalFDRData() {
                console.log("DEBUG_FETCH: Fetching global data...");
                const seasonId = "2025-2026";
                const splRankingsDocRef = doc(db, 'splRankings', seasonId);

                try {
                    // --- Fetch Team Data from API (bootstrap-static) via Netlify Proxy ---
                    showApiTeamNamesStatus("Fetching team names from API...", "info");
                    // Call the Netlify Function proxy
                    const bootstrapProxyResponse = await fetch(`/api/spl-proxy?url=${encodeURIComponent(BOOTSTRAP_STATIC_API_URL)}`);
                    
                    if (!bootstrapProxyResponse.ok) {
                        throw new Error(`HTTP error! status: ${bootstrapProxyResponse.status} from proxy for ${BOOTSTRAP_STATIC_API_URL}`);
                    }
                    const bootstrapData = await bootstrapProxyResponse.json();
                    console.log("DEBUG_FETCH: Raw bootstrap-static API data (via proxy):", bootstrapData);

                    globalTeamData = { byId: {}, byFullName: {}, byShortName: {} };
                    if (bootstrapData && bootstrapData.teams && bootstrapData.teams.length > 0) {
                        bootstrapData.teams.forEach(team => {
                            const teamId = team.id;
                            const teamFullName = team.name;
                            // The 'short_name' field is present in the API response (e.g., "ARS" for Arsenal in FPL, or "HIL" for Al Hilal)
                            const teamShortName = team.short_name; 
                            
                            globalTeamData.byId[teamId] = { id: teamId, name: teamFullName, short_name: teamShortName };
                            globalTeamData.byFullName[teamFullName] = { id: teamId, name: teamFullName, short_name: teamShortName };
                            globalTeamData.byShortName[teamShortName] = { id: teamId, name: teamFullName, short_name: teamShortName };
                        });
                        showApiTeamNamesStatus(`Team Names (from API) fetched successfully. Found ${Object.keys(globalTeamData.byId).length} teams.`, "success");
                        console.log("DEBUG_FETCH: Fetched global Team Data:", globalTeamData);
                    } else {
                        showApiTeamNamesStatus("Team Names (from API) could not be fetched or data is empty. Check API connection and Netlify environment variables.", "error");
                        console.warn("WARNING_FETCH: No Team data found in bootstrap-static API response.");
                    }


                    // --- Fetch Schedule Data from API (fixtures) via Netlify Proxy ---
                    showApiScheduleStatus("Fetching season schedule from API...", "info");
                    globalSeasonSchedule = { teams: [], rounds: [], fixtures: {} }; // Reset
                    const maxRound = 34; // Total rounds in SPL

                    // Fetch all rounds concurrently via the proxy
                    const fixtureFetchPromises = [];
                    for (let round = 1; round <= maxRound; round++) {
                        fixtureFetchPromises.push(
                            fetch(`/api/spl-proxy?url=${encodeURIComponent(`${FIXTURES_API_BASE_URL}${round}`)}`)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`HTTP error! status: ${response.status} from proxy for round ${round}`);
                                    }
                                    return response.json();
                                })
                                .then(data => ({ round, data }))
                                .catch(error => {
                                    console.error(`ERROR_FETCH: Failed to fetch fixtures for round ${round} via proxy:`, error);
                                    return { round, data: null, error: error }; // Return null data on error
                                })
                        );
                    }

                    const allFixturesData = await Promise.all(fixtureFetchPromises);
                    console.log("DEBUG_FETCH: All fixtures data fetched (raw via proxy):", allFixturesData);

                    // Process fetched fixtures
                    const processedFixtures = {}; // Temp object to build the schedule
                    const allTeamNamesInSchedule = new Set();
                    const allRoundNamesInSchedule = new Set();

                    allFixturesData.forEach(({ round, data, error }) => {
                        if (data && data.length > 0) {
                            const roundName = `R${round}`;
                            allRoundNamesInSchedule.add(roundName); // Add to set of rounds

                            data.forEach(fixture => {
                                // IMPORTANT FIX: Only process fixture if its 'event' matches the current 'round'
                                // This prevents fixtures from other rounds being incorrectly aggregated.
                                if (fixture.event === round) {
                                    const homeTeamId = fixture.team_h;
                                    const awayTeamId = fixture.team_a;
                                    const homeTeamFullName = globalTeamData.byId[homeTeamId]?.name;
                                    const homeTeamShortName = globalTeamData.byId[homeTeamId]?.short_name; 
                                    const awayTeamFullName = globalTeamData.byId[awayTeamId]?.name;
                                    const awayTeamShortName = globalTeamData.byId[awayTeamId]?.short_name; 

                                    if (homeTeamFullName && awayTeamFullName && homeTeamShortName && awayTeamShortName) {
                                        allTeamNamesInSchedule.add(homeTeamFullName);
                                        allTeamNamesInSchedule.add(awayTeamFullName);

                                        // Initialize the team's round array if it doesn't exist
                                        if (!processedFixtures[homeTeamFullName]) processedFixtures[homeTeamFullName] = {};
                                        if (!processedFixtures[homeTeamFullName][roundName]) processedFixtures[homeTeamFullName][roundName] = [];
                                        processedFixtures[homeTeamFullName][roundName].push(`${awayTeamShortName} `); 

                                        // Initialize the team's round array if it doesn't exist
                                        if (!processedFixtures[awayTeamFullName]) processedFixtures[awayTeamFullName] = {};
                                        if (!processedFixtures[awayTeamFullName][roundName]) processedFixtures[awayTeamFullName][roundName] = [];
                                        processedFixtures[awayTeamFullName][roundName].push(`${homeTeamShortName} `); 
                                    } else {
                                        console.warn(`WARNING_FETCH: Skipping fixture in round ${round} due to missing team data: Home ID ${homeTeamId} (${homeTeamFullName}), Away ID ${awayTeamId} (${awayTeamFullName}). Raw fixture:`, fixture); 
                                    }
                                } else {
                                    console.warn(`WARNING_FETCH: Fixture event (${fixture.event}) does not match current processing round (${round}). Skipping. Fixture:`, fixture);
                                }
                            });
                        } else if (!error) {
                            console.log(`DEBUG_FETCH: No fixture data for round ${round}. This might be a blank round.`);
                            // Ensure all teams have an empty array for this round if it's blank, so the table renders correctly.
                            // This is important for teams that have a blank round, but might have fixtures in other rounds.
                            const allKnownTeams = Object.values(globalTeamData.byFullName).map(team => team.name);
                            const roundName = `R${round}`;
                            allKnownTeams.forEach(teamFullName => {
                                if (!processedFixtures[teamFullName]) processedFixtures[teamFullName] = {};
                                if (!processedFixtures[teamFullName][roundName]) {
                                    processedFixtures[teamFullName][roundName] = []; // Ensure empty array for blank rounds
                                }
                            });
                            allRoundNamesInSchedule.add(roundName); // Still add the round name even if blank
                        }
                    });

                    globalSeasonSchedule.fixtures = processedFixtures;
                    globalSeasonSchedule.teams = Array.from(allTeamNamesInSchedule).sort(); // Sort teams alphabetically
                    globalSeasonSchedule.rounds = Array.from(allRoundNamesInSchedule).sort((a, b) => {
                        // Sort rounds numerically (R1, R2, ..., R34)
                        const numA = parseInt(a.substring(1));
                        const numB = parseInt(b.substring(1));
                        return numA - numB;
                    });

                    if (Object.keys(globalSeasonSchedule.fixtures).length > 0) {
                        showApiScheduleStatus(`Season Schedule (from API) fetched successfully. Found ${globalSeasonSchedule.rounds.length} rounds and ${globalSeasonSchedule.teams.length} teams.`, "success");
                        console.log("DEBUG_FETCH: Fetched global Season Schedule (fixtures):", globalSeasonSchedule.fixtures);
                        console.log("DEBUG_FETCH: Fetched global Season Schedule (teams):", globalSeasonSchedule.teams);
                        console.log("DEBUG_FETCH: Fetched global Season Schedule (rounds):", globalSeasonSchedule.rounds);
                    } else {
                        showApiScheduleStatus("Season Schedule (from API) could not be fetched or data is empty. Check API connection and Netlify environment variables.", "error");
                        console.warn("WARNING_FETCH: No Season Schedule data found from API.");
                    }


                    // --- Fetch SPL Rankings from Firestore (remains user-uploaded) ---
                    const rankingsSnap = await getDoc(splRankingsDocRef); // Fetch after API data for consistency
                    console.log("DEBUG_FETCH: Raw rankingsSnap.data() (from Firestore):", rankingsSnap.data());
                    if (rankingsSnap.exists() && rankingsSnap.data()) {
                        const data = rankingsSnap.data();
                        globalSplRankings.overall = data.overall || [];
                        globalSplRankings.home = data.home || [];
                        globalSplRankings.away = data.away || [];
                        console.log("DEBUG_FETCH: Fetched global SPL Rankings (from Firestore):", globalSplRankings);
                    } else {
                        console.warn("WARNING_FETCH: No SPL Rankings data found in Firestore or data is empty. Please upload via Admin Dashboard.");
                        globalSplRankings = { overall: [], home: [], away: [] };
                    }

                } catch (error) {
                    console.error("ERROR_FETCH: Error fetching global FDR data from APIs or Firestore:", error);
                    showGeneralErrorMessage(`Failed to load global data: ${error.message}. Please check console for details.`);
                    showApiTeamNamesStatus(`Error fetching Team Names: ${error.message}`, "error");
                    showApiScheduleStatus(`Error fetching Schedule: ${error.message}`, "error");
                }
            }

            /**
             * Helper function to get the FDR value for a given team, opponent, and home/away status.
             * This function is kept for future use but is currently not called by renderScheduleTable.
             * @param {string} teamFullName - The full name of the team whose FDR is being calculated.
             * @param {string} opponentFullName - The full name of the opponent.
             * @param {boolean} isHomeGame - True if it's a home game for `teamFullName`, false for away.
             * @param {string} fdrType - The type of FDR to use ('overall', 'homeAway').
             * @returns {number | string} The FDR value or 'N/A' if not found.
             */
            function getFDRValue(teamFullName, opponentFullName, isHomeGame, fdrType) {
                let fdrValue = 'N/A';

                // Ensure rankings data is available
                if (!globalSplRankings || (!globalSplRankings.overall.length && !globalSplRankings.home.length && !globalSplRankings.away.length)) {
                    console.warn("WARNING_FDR_CALC: globalSplRankings is empty or not fully loaded in getFDRValue.");
                    return 'N/A';
                }

                // Find the opponent's ranking data
                const opponentOverallData = globalSplRankings.overall.find(item => item.team === opponentFullName);
                const opponentHomeData = globalSplRankings.home.find(item => item.team === opponentFullName);
                const opponentAwayData = globalSplRankings.away.find(item => item.team === opponentFullName);


                if (fdrType === 'overall') {
                    if (opponentOverallData) {
                        // For overall FDR, we look at the opponent's home FDR if we are away, and opponent's away FDR if we are home.
                        // This represents the difficulty *they* pose to us in that specific venue.
                        fdrValue = isHomeGame ? opponentOverallData.fdrAway : opponentOverallData.fdrHome; 
                    } else {
                        console.warn(`WARNING_FDR_CALC: Opponent overall data not found for ${opponentFullName}.`);
                    }
                } else if (fdrType === 'homeAway') {
                    if (isHomeGame) { // If our team is home, we look at the opponent's AWAY rating (difficulty for THEM when THEY are away)
                        if (opponentAwayData) { 
                            fdrValue = opponentAwayData.fdrAway;
                        } else {
                            console.warn(`WARNING_FDR_CALC: Opponent away data not found for ${opponentFullName}.`);
                        }
                    } else { // If our team is away, we look at the opponent's HOME rating (difficulty for THEM when THEY are home)
                        if (opponentHomeData) { 
                            fdrValue = opponentHomeData.fdrHome;
                        } else {
                            console.warn(`WARNING_FDR_CALC: Opponent home data not found for ${opponentFullName}.`);
                        }
                    }
                }
                return fdrValue;
            }


            /**
             * Renders the schedule table for the My Control Room FDR feature.
             * This function has been completely rewritten to ensure correct rendering.
             * @param {HTMLElement} tableElement - The <table> element to render into.
             * @param {string} fdrType - The type of FDR to apply ('overall', 'homeAway', 'customized').
             * @param {Object} customRatings - Object containing custom ratings for 'customized' type.
             */
            function renderScheduleTable(tableElement, fdrType, customRatings = {}) {
                console.log(`DEBUG_RENDER_REWRITE: renderScheduleTable called for FDR Type: ${fdrType}, Rounds to show: ${roundsToShow}`);
                tableElement.innerHTML = ''; // Clear existing table content

                if (!globalSeasonSchedule || !globalSeasonSchedule.fixtures || Object.keys(globalSeasonSchedule.fixtures).length === 0 || !globalSeasonSchedule.teams || globalSeasonSchedule.teams.length === 0 || !globalSeasonSchedule.rounds || globalSeasonSchedule.rounds.length === 0) {
                    console.warn("WARNING_RENDER_REWRITE: No complete season schedule data available for rendering.");
                    tableElement.innerHTML = '<tbody><tr><td colspan="100%" style="text-align:center; padding: 20px; color: var(--spl-text-medium);">No season schedule data available. Please ensure schedule data is fetched from API.</td></tr></tbody>';
                    return;
                }
                
                const teamsToDisplay = globalSeasonSchedule.teams;
                const allRounds = globalSeasonSchedule.rounds;
                const roundsToRender = allRounds.slice(0, roundsToShow); // Use the tuning setting
                console.log("DEBUG_RENDER_REWRITE: Teams to display in table:", teamsToDisplay);
                console.log("DEBUG_RENDER_REWRITE: All rounds from globalSeasonSchedule.rounds:", allRounds);
                console.log("DEBUG_RENDER_REWRITE: Rounds to render (based on slider):", roundsToRender);


                // Create table header (Rounds)
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                const teamHeader = document.createElement('th');
                teamHeader.textContent = 'Team';
                headerRow.appendChild(teamHeader);

                roundsToRender.forEach(round => {
                    const th = document.createElement('th');
                    th.textContent = round;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                tableElement.appendChild(thead);

                // Create table body (Teams and their fixtures)
                const tbody = document.createElement('tbody');
                teamsToDisplay.forEach(teamFullName => {
                    const row = document.createElement('tr');
                    const teamCell = document.createElement('td');
                    teamCell.textContent = teamFullName;
                    row.appendChild(teamCell);

                    // Get the fixtures object for the current team (e.g., { R1: [...], R2: [...] })
                    const teamFixtures = globalSeasonSchedule.fixtures[teamFullName] || {};
                    console.log(`DEBUG_RENDER_REWRITE_TEAM_FIXTURES: Team: ${teamFullName}, Fixtures for this team:`, teamFixtures);


                    roundsToRender.forEach(round => {
                        const fixtureCell = document.createElement('td');
                        fixtureCell.className = 'fixture-cell'; 
                        fixtureCell.innerHTML = ''; // Explicitly clear content for each cell

                        // Retrieve the specific array of fixtures for this team and this round
                        // Use a direct lookup and ensure it's an array, defaulting to empty array
                        const fixturesForThisRound = teamFixtures[round] || [];
                        console.log(`DEBUG_RENDER_REWRITE_FIXTURES_IN_ROUND: For ${teamFullName} in ${round}, fixturesForThisRound:`, fixturesForThisRound);

                        if (fixturesForThisRound.length > 0) {
                            fixturesForThisRound.forEach((fixtureString, index) => {
                                const fixtureDisplayItem = document.createElement('div'); // Create a NEW div for each fixture
                                fixtureDisplayItem.className = `fixture-item-display`; 

                                const match = fixtureString.match(/(.+?)\s*(|)?$/); 
                                let opponentShortCode = fixtureString; 
                                let homeAwayEmoji = ''; 

                                if (match && match[1]) { 
                                    opponentShortCode = match[1].trim();
                                    homeAwayEmoji = match[2] || ''; 
                                } else {
                                     console.warn(`WARNING_RENDER_REWRITE: Fixture string '${fixtureString}' for team '${teamFullName}' in round '${round}' was not in expected "Short Code /" format. Displaying as raw. Match result:`, match);
                                }
                                
                                fixtureDisplayItem.textContent = `${opponentShortCode} ${homeAwayEmoji}`; 
                                fixtureCell.appendChild(fixtureDisplayItem);

                                // For customized, still provide input fields for future use
                                if (fdrType === 'customized') {
                                    const fixtureKey = `${teamFullName}-${round}-${index}`; 
                                    const inputElement = document.createElement('input');
                                    inputElement.type = 'number';
                                    inputElement.min = '1';
                                    inputElement.max = '7';
                                    inputElement.value = customRatings[fixtureKey] || ''; 
                                    inputElement.dataset.fixtureId = fixtureKey;
                                    inputElement.oninput = function() {
                                        this.value = Math.max(1, Math.min(7, parseInt(this.value) || ''));
                                    };
                                    fixtureCell.appendChild(inputElement);
                                }
                            });
                        } else {
                            fixtureCell.textContent = ''; // Ensure blank cells are explicitly empty
                        }
                        row.appendChild(fixtureCell);
                    });
                    tbody.appendChild(row);
                });
                tableElement.appendChild(tbody);
            }


            /**
             * Fetches and renders current rankings from Firestore into specified grid/list elements.
             * This function is now generalized to serve both Admin Dashboard and My Control Room.
             * @param {HTMLElement} messageBox - The message box element to display status messages.
             * @param {HTMLElement} overallGridOrList - The grid/list element for overall FDR (Admin: grid, Control Room: table).
             * @param {HTMLElement} homeGridOrList - The grid/list element for home FDR (Admin: grid, Control Room: table).
             * @param {HTMLElement} awayGridOrList - The grid/list element for away FDR (Admin: grid, Control Room: table).
             * @param {HTMLElement} overallSection - The section container for overall FDR.
             * @param {HTMLElement} homeSection - The section container for home FDR.
             * @param {HTMLElement} HTMLElement - The section container for away FDR.
             * @param {HTMLElement} displayContainer - The main display container for rankings (e.g., currentRankingsDisplayAdmin or myControlRoomFDRDisplay).
             * @param {string | null} selectedFdrSystem - The currently selected FDR system ('overall', 'homeAway', 'customized') for Control Room, or null for Admin.
             */
            async function fetchAndRenderRankings(messageBox, overallGridOrList, homeGridOrList, awayGridOrList, overallSection, homeSection, awaySection, displayContainer, selectedFdrSystem = null) {
                messageBox.textContent = '';
                messageBox.style.display = 'block';
                messageBox.className = 'message-box info';
                messageBox.textContent = 'Loading FDR data...';

                // Clear all grids/lists and hide sections initially
                if (overallGridOrList) overallGridOrList.innerHTML = '';
                if (homeGridOrList) homeGridOrList.innerHTML = '';
                if (awayGridOrList) awayGridOrList.innerHTML = '';
                if (overallSection) overallSection.style.display = 'none';
                if (homeSection) homeSection.style.display = 'none';
                if (awaySection) awaySection.style.display = 'none';
                // displayContainer (myControlRoomFDRDisplay) is now always visible when myControlRoomContent is active
                // if (displayContainer) displayContainer.style.display = 'block'; // This line was causing the premature display

                // Ensure global data is fetched before rendering
                // This is crucial for both Admin and Control Room to have the latest data
                // fetchGlobalFDRData is now called once on auth state change or admin data button click
                // So, we assume global data is already populated here.

                let hasDataToDisplay = false;

                // --- Render for Admin Dashboard (show all data) ---
                if (!selectedFdrSystem) { // If selectedFdrSystem is null, it means we're in Admin Dashboard
                    // Render Overall Rankings (Admin)
                    if (globalSplRankings.overall.length > 0) {
                        globalSplRankings.overall.sort((a, b) => {
                            // Sort by average FDR (fdrHome + fdrAway) / 2
                            const avgFDR_A = (a.fdrHome + a.fdrAway) / 2;
                            const avgFDR_B = (b.fdrHome + b.fdrAway) / 2;
                            return avgFDR_B - avgFDR_A; // Higher average FDR first
                        });

                        globalSplRankings.overall.forEach(item => {
                            const awayItem = document.createElement('div');
                            awayItem.className = `fdr-grid-item fdr-${item.fdrAway}`;
                            awayItem.innerHTML = `${item.team} `;
                            if (overallGridOrList) overallGridOrList.appendChild(awayItem);

                            const homeItem = document.createElement('div');
                            homeItem.className = `fdr-grid-item fdr-${item.fdrHome}`;
                            homeItem.innerHTML = `${item.team} `;
                            if (overallGridOrList) overallGridOrList.appendChild(homeItem);
                        });
                        if (overallSection) overallSection.style.display = 'block';
                        hasDataToDisplay = true;
                    } else {
                        if (overallGridOrList) overallGridOrList.innerHTML = '<div style="grid-column: 1 / -1; text-align:center; padding: 20px; color: var(--spl-text-medium);">No Overall rankings data available.</div>';
                    }

                    // Render Home Rankings (Admin)
                    if (globalSplRankings.home.length > 0) {
                        globalSplRankings.home.sort((a, b) => b.fdrAway - a.fdrAway); // Sort by Away FDR for Home rankings

                        globalSplRankings.home.forEach(item => {
                            const teamName = item.team;
                            const fdrAway = item.fdrAway; 
                            
                            const teamItem = document.createElement('div');
                            teamItem.className = `fdr-grid-item fdr-${fdrAway}`;
                            teamItem.innerHTML = `${teamName} `; 
                            if (homeGridOrList) homeGridOrList.appendChild(teamItem);
                        });
                        if (homeSection) homeSection.style.display = 'block';
                        hasDataToDisplay = true;
                    } else {
                        if (homeGridOrList) homeGridOrList.innerHTML = '<div style="grid-column: 1 / -1; text-align:center; padding: 20px; color: var(--spl-text-medium);">No Home rankings data available.</div>';
                    }

                    // Render Away Rankings (Admin)
                    if (globalSplRankings.away.length > 0) {
                        globalSplRankings.away.sort((a, b) => b.fdrHome - a.fdrHome); // Sort by Home FDR for Away rankings

                        globalSplRankings.away.forEach(item => {
                            const teamName = item.team;
                            const fdrHome = item.fdrHome; 

                            const teamItem = document.createElement('div');
                            teamItem.className = `fdr-grid-item fdr-${fdrHome}`;
                            teamItem.innerHTML = `${teamName} `; 
                            if (awayGridOrList) awayGridOrList.appendChild(teamItem);
                        });
                        if (awaySection) awaySection.style.display = 'block';
                        hasDataToDisplay = true;
                    } else {
                        if (awayGridOrList) awayGridOrList.innerHTML = '<div style="grid-column: 1 / -1; text-align:center; padding: 20px; color: var(--spl-text-medium);">No Away rankings data available.</div>';
                    }
                } 
                // --- Render for My Control Room (full league schedule) ---
                else {
                    // Ensure overall, homeAway, and customized sections are hidden initially for Control Room
                    if (overallFDRSectionControlRoom) overallFDRSectionControlRoom.style.display = 'none';
                    if (homeAwayFDRSectionControlRoom) homeAwayFDRSectionControlRoom.style.display = 'none';
                    if (customizedFDRSectionControlRoom) customizedFDRSectionControlRoom.style.display = 'none';

                    // myControlRoomFDRDisplay is the parent of the schedule tables, it should be visible when an FDR system is selected
                    if (myControlRoomFDRDisplay) myControlRoomFDRDisplay.style.display = 'block';

                    if (selectedFdrSystem === 'overall') { // Corrected variable name here
                        if (overallFDRSectionControlRoom) overallFDRSectionControlRoom.style.display = 'block';
                        renderScheduleTable(overallScheduleTable, 'overall');
                        // showControlRoomMessage("Displaying Overall FDR Schedule.", "info");
                    } else if (selectedFdrSystem === 'homeAway') { // Corrected variable name here
                        if (homeAwayFDRSectionControlRoom) homeAwayFDRSectionControlRoom.style.display = 'block';
                        renderScheduleTable(homeAwayScheduleTable, 'homeAway');
                        // showControlRoomMessage("Displaying Home/Away FDR Schedule.", "info");
                    } else if (selectedFdrSystem === 'customized') { // Corrected variable name here
                        if (customizedFDRSectionControlRoom) customizedFDRSectionControlRoom.style.display = 'block';
                        // Fetch custom ratings for the current user
                        const user = auth.currentUser;
                        let customRatings = {};
                        if (user) {
                            const customFDRDocRef = doc(db, "users", user.uid, "customFDR", "ratings");
                            const customFDRDocSnap = await getDoc(customFDRDocRef);
                            if (customFDRDocSnap.exists()) {
                                customRatings = customFDRDocSnap.data();
                            }
                        }
                        renderScheduleTable(customizedScheduleTable, 'customized', customRatings);
                        // showControlRoomMessage("Displaying Customized FDR Schedule. You can edit ratings.", "info");
                    } else {
                        console.warn(`WARNING: Unknown FDR system selected: ${selectedFdrSystem}`); // Keep this log for debugging
                        showControlRoomMessage("Please select a valid FDR system.", "error");
                    }
                }

                if (hasDataToDisplay) {
                    messageBox.className = 'message-box success';
                    messageBox.textContent = 'FDR data loaded.';
                } else {
                    messageBox.className = 'message-box info';
                    messageBox.textContent = 'No relevant FDR data found for display. Please ensure league data is uploaded via Admin Dashboard, and API data is fetched.';
                }
            }

            /**
             * Fetches the user's preferred FDR system from Firestore and sets the radio button.
             * Then, displays the corresponding FDR system.
             */
            async function loadAndSetPreferredFDRSystem() {
                const user = auth.currentUser;
                if (!user) {
                    showControlRoomMessage("You must be logged in to view FDR systems.", "error");
                    return;
                }

                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(userDocRef);
                    let preferredSystem = 'overall'; // Default if not found

                    if (docSnap.exists() && docSnap.data().preferredFDRSystem) { 
                        preferredSystem = docSnap.data().preferredFDRSystem; 
                    }
                    
                    // Set the radio button based on preferredSystem
                    const radioToSelect = document.querySelector(`input[name="fdrSystem"][value="${preferredSystem}"]`);
                    if (radioToSelect) {
                        radioToSelect.checked = true;
                    } else {
                        // Fallback to overall if saved preference is invalid or missing
                        if (radioOverallFDR) radioOverallFDR.checked = true;
                        preferredSystem = 'overall';
                    }
                    
                    displaySelectedFDRSystem(preferredSystem); // Display the loaded/default system

                } catch (error) {
                    console.error("Error loading preferred FDR system:", error);
                    showControlRoomMessage("Failed to load your preferred FDR system. Defaulting to Overall.", "error");
                    // Fallback to overall if loading fails
                    if (radioOverallFDR) radioOverallFDR.checked = true;
                    displaySelectedFDRSystem('overall');
                }
            }

            /**
             * Saves the customized FDR ratings to the user's Firestore document.
             */
            if (saveCustomFDRButton) {
                saveCustomFDRButton.addEventListener('click', async () => {
                    const user = auth.currentUser;
                    if (!user) {
                        showControlRoomMessage("You must be logged in to save custom ratings.", "error");
                        return;
                    }

                    const customRatings = {};
                    const customInputs = customizedScheduleTable.querySelectorAll('input[type="number"]');
                    let isValid = true;

                    customInputs.forEach(input => {
                        const fixtureId = input.dataset.fixtureId;
                        const value = parseInt(input.value, 10);
                        if (isNaN(value) || value < 1 || value > 7) {
                            isValid = false;
                            showControlRoomMessage(`Invalid rating for fixture ${fixtureId}. Ratings must be between 1 and 7.`, "error");
                            // Stop processing further inputs if one is invalid
                            return; 
                        }
                        customRatings[fixtureId] = value;
                    });

                    if (!isValid) return; // Exit if any input was invalid

                    try {
                        const customFDRDocRef = doc(db, "users", user.uid, "customFDR", "ratings");
                        await setDoc(customFDRDocRef, customRatings, { merge: true });
                        showControlRoomMessage("Custom FDR ratings saved successfully!", "success");
                    } catch (error) {
                        console.error("Error saving custom FDR ratings:", error);
                        showControlRoomMessage(`Failed to save custom ratings: ${error.message}`, "error");
                    }
                });
            }

            /**
             * Central function to display the user's team FDR based on selected system.
             * This will be called on Control Room load and radio button changes.
             * @param {string | null} systemType - The system to display ('overall', 'homeAway', 'customized').
             */
            async function displaySelectedFDRSystem(systemType = null) {
                let selectedSystem = systemType;
                if (!selectedSystem) {
                    // Ensure a default is set if no radio button is checked (e.g., first load)
                    selectedSystem = document.querySelector('input[name="fdrSystem"]:checked')?.value || 'overall';
                }

                // Ensure the correct radio button is checked
                const radioToSelect = document.querySelector(`input[name="fdrSystem"][value="${selectedSystem}"]`);
                if (radioToSelect) {
                    radioToSelect.checked = true;
                }

                // Hide all FDR sections for Control Room before rendering the selected one
                if (overallFDRSectionControlRoom) overallFDRSectionControlRoom.style.display = 'none';
                if (homeAwayFDRSectionControlRoom) homeAwayFDRSectionControlRoom.style.display = 'none';
                if (customizedFDRSectionControlRoom) customizedFDRSectionControlRoom.style.display = 'none';

                // myControlRoomFDRDisplay is the parent of the schedule tables, it should be visible when an FDR system is selected
                if (myControlRoomFDRDisplay) myControlRoomFDRDisplay.style.display = 'block';

                if (selectedSystem === 'overall') { // Corrected variable name here
                    if (overallFDRSectionControlRoom) overallFDRSectionControlRoom.style.display = 'block';
                    renderScheduleTable(overallScheduleTable, 'overall');
                    // showControlRoomMessage("Displaying Overall FDR Schedule.", "info");
                } else if (selectedSystem === 'homeAway') { // Corrected variable name here
                    if (homeAwayFDRSectionControlRoom) homeAwayFDRSectionControlRoom.style.display = 'block';
                    renderScheduleTable(homeAwayScheduleTable, 'homeAway');
                    // showControlRoomMessage("Displaying Home/Away FDR Schedule.", "info");
                } else if (selectedSystem === 'customized') { // Corrected variable name here
                    if (customizedFDRSectionControlRoom) customizedFDRSectionControlRoom.style.display = 'block';
                    // Fetch custom ratings for the current user
                    const user = auth.currentUser;
                    let customRatings = {};
                    if (user) {
                        const customFDRDocRef = doc(db, "users", user.uid, "customFDR", "ratings");
                        const customFDRDocSnap = await getDoc(customFDRDocRef);
                        if (customFDRDocSnap.exists()) {
                            customRatings = customFDRDocSnap.data();
                        }
                    }
                    renderScheduleTable(customizedScheduleTable, 'customized', customRatings);
                    // showControlRoomMessage("Displaying Customized FDR Schedule. You can edit ratings.", "info");
                } else {
                    console.warn(`WARNING: Unknown FDR system selected: ${selectedSystem}`); // Keep this log for debugging
                    showControlRoomMessage("Please select a valid FDR system.", "error");
                }
            }

            // Add event listeners for FDR system radio buttons in Control Room
            document.querySelectorAll('input[name="fdrSystem"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    displaySelectedFDRSystem(radio.value);
                });
            });

            // Event listener for the main "FDR" button in My Control Room
            if (showFDRButton) {
                showFDRButton.addEventListener('click', () => {
                    if (fdrSystemsContainer) fdrSystemsContainer.style.display = 'flex'; // Show the systems container
                    loadAndSetPreferredFDRSystem(); // Load and display the preferred system
                });
            }

            // NEW: Event listener for "Save as My FDR System" button
            if (saveFDRSystemButton) {
                saveFDRSystemButton.addEventListener('click', async () => {
                    const user = auth.currentUser;
                    if (!user) {
                        showControlRoomMessage("You must be logged in to save your preferred FDR system.", "error");
                        return;
                    }

                    const selectedSystem = document.querySelector('input[name="fdrSystem"]:checked')?.value;
                    if (!selectedSystem) {
                        showControlRoomMessage("Please select an FDR system to save.", "warning");
                        return;
                    }

                    try {
                        const userDocRef = doc(db, "users", user.uid);
                        await updateDoc(userDocRef, {
                            preferredFDRSystem: selectedSystem
                        });
                        showControlRoomMessage(`Your preferred FDR system (${selectedSystem.charAt(0).toUpperCase() + selectedSystem.slice(1)}) has been saved!`, "success");
                    } catch (error) {
                        console.error("Error saving preferred FDR system:", error);
                        showControlRoomMessage(`Failed to save preferred FDR system: ${error.message}`, "error");
                    }
                });
            }

            // Tuning section event listeners
            if (roundsToShowSlider) {
                roundsToShowSlider.addEventListener('input', (e) => {
                    roundsToShow = parseInt(e.target.value, 10);
                    if (roundsToShowValueSpan) roundsToShowValueSpan.textContent = roundsToShow;
                    // Re-render the currently active FDR system to reflect the new roundsToShow
                    const selectedSystem = document.querySelector('input[name="fdrSystem"]:checked')?.value;
                    if (selectedSystem) {
                        displaySelectedFDRSystem(selectedSystem);
                    }
                });
            }

            // --- Initial Load & Theme & Event Listeners ---
            document.addEventListener('DOMContentLoaded', () => {
                console.log("DEBUG: DOMContentLoaded fired.");

                // Explicitly set initial display state for main sections based on current auth state
                // This is crucial to prevent a blank page before onAuthStateChanged fully resolves
                if (auth.currentUser) { 
                    console.log("DEBUG: DOMContentLoaded: User already logged in, showing loggedInContent.");
                    if (loggedInContent) loggedInContent.style.display = 'block';
                    if (authSection) authSection.style.display = 'none';
                    // Initially show the welcome dashboard, not My Control Room directly
                    showContentSection('initialLoggedInDashboard'); 
                } else { 
                    console.log("DEBUG: DOMContentLoaded: No user logged in, showing authSection.");
                    if (authSection) authSection.style.display = 'block';
                    if (loginForm) loginForm.style.display = 'block'; 
                    if (signupForm) signupForm.style.display = 'none';
                    if (loggedInContent) loggedInContent.style.display = 'none';
                }
                if (instructionsBox) instructionsBox.style.display = 'none';

                if (darkModeToggle) {
                    console.log("DEBUG: darkModeToggle element found.");
                    const savedTheme = localStorage.getItem('theme');
                    if (savedTheme) {
                        setTheme(savedTheme);
                    } else {
                        setTheme('light'); 
                    }

                    darkModeToggle.addEventListener('change', (e) => {
                        console.log("DEBUG: Dark Mode Toggle 'change' event fired. Checked:", e.target.checked);
                        setTheme(e.target.checked ? 'dark' : 'light');
                    });
                } else {
                    console.error("ERROR: Dark mode toggle element not found!");
                }

                // --- Menu Toggle Logic ---
                if (menuToggle && sidebarMenu && overlay) {
                    menuToggle.addEventListener('click', () => {
                        sidebarMenu.classList.toggle('open');
                        overlay.style.display = sidebarMenu.classList.contains('open') ? 'block' : 'none';
                    });

                    overlay.addEventListener('click', () => {
                        sidebarMenu.classList.remove('open');
                        overlay.style.display = 'none';
                    });
                } else {
                    console.error("ERROR: Menu toggle or sidebar elements not found!");
                }

                // --- Menu Item Click Listeners ---
                if (menuMyControlRoom) {
                    menuMyControlRoom.addEventListener('click', (e) => {
                        e.preventDefault();
                        showContentSection('controlRoom');
                        sidebarMenu.classList.remove('open');
                        overlay.style.display = 'none';
                    });
                }
                if (menuAdminDashboard) {
                    menuAdminDashboard.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.trace("DEBUG: Admin Dashboard menu item clicked!"); 
                        showContentSection('adminDashboard');
                        sidebarMenu.classList.remove('open');
                        overlay.style.display = 'none';
                    });
                }

                // Initialize tuning slider value display
                if (roundsToShowSlider && roundsToShowValueSpan) {
                    roundsToShowValueSpan.textContent = roundsToShowSlider.value;
                }
            });
        </script>
    </body>
    </html>
