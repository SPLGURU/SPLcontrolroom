    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
        <title>Control Room V2</title>
        <!-- Firebase SDK - Core -->
        <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
        <!-- Firebase SDK - Auth -->
        <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
        <!-- Firebase SDK - Firestore -->
        <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!-- html2canvas library for capturing screenshots -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> 
        <!-- NEW: gif.js library for GIF encoding -->
        <script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>
        
        <!-- NEW: XLSX.js library for reading Excel files (still needed for FDR uploads) -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Oswald:wght@400;700&display=swap" rel="stylesheet">
        <!-- Font Awesome for Hamburger Icon -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <style id="main-styles">
            /* Base colors for light mode (current default) */
            :root {
                --spl-light-bg: #F8F9FA;
                --spl-container-bg: #FFFFFF;
                --spl-table-bg: #E0E4E8;
                --spl-table-header-bg: #B3D9FF;
                --spl-table-row-even: #D6DBE0;
                --spl-table-row-hover: #C7CCD1;
                --spl-text-dark: #212529;
                --spl-text-medium: #495057;
                --spl-primary-accent: #034667;
                --spl-accent-green: #28A745;
                --spl-accent-red: #DC3545;
                --spl-border-light: #CED4DA;
                --spl-shadow: rgba(0, 0, 0, 0.1);
            }

            /* Dark mode specific variables */
            body.dark-mode {
                --spl-light-bg: #034667; /* User requested background */
                --spl-container-bg: #1a3e5c; /* Darker blue for cards/containers */
                --spl-table-bg: #0d283c; /* Even darker blue for tables */
                --spl-table-header-bg: #0a1c2a; /* Very dark blue/black for table headers */
                --spl-table-row-even: #123045; /* Dark blue for even rows */
                --spl-table-row-hover: #1f4f7a; /* Lighter dark blue on hover */
                --spl-text-dark: #F8F9FA; /* Light text */
                --spl-text-medium: #CED4DA; /* Lighter medium text */
                --spl-primary-accent: #007bff; /* Brighter blue for accent */
                /* Green and Red accents remain the same for clarity */
                --spl-border-light: #495057; /* Darker border */
                --spl-shadow: rgba(255, 255, 255, 0.1); /* Light shadow for dark mode */
            }

            body {
                font-family: 'Roboto', sans-serif;
                background-color: var(--spl-light-bg);
                color: var(--spl-text-dark);
                margin: 0;
                padding: 20px;
                line-height: 1.6;
                display: flex;
                flex-direction: column;
                align-items: center;
                min-height: 100vh;
                box-sizing: border-box;
                transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for theme change */
            }

            #logo-container {
                text-align: center;
                margin-bottom: 20px; /* Space below the logo */
                width: 100%;
            }

            #logo-container img {
                max-width: 300px; /* Adjust as needed for PC size */
                height: auto;
                display: block; /* Remove extra space below image */
                margin: 0 auto; /* Center the image */
                transition: src 0.3s ease; /* Smooth transition for logo change */
            }

            /* Theme switch styles */
            .theme-switch-wrapper {
                display: flex;
                align-items: center;
                justify-content: center; /* Center the switch */
                margin-bottom: 20px;
                gap: 10px;
                color: var(--spl-text-dark); /* Ensure label text changes with theme */
                font-size: 0.95em;
                width: 100%;
                max-width: 1200px;
            }
            .theme-switch {
                position: relative;
                display: inline-block;
                width: 45px;
                height: 25px;
            }
            .theme-switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                -webkit-transition: .4s;
                transition: .4s;
            }
            .slider:before {
                position: absolute;
                content: "";
                height: 18px;
                width: 18px;
                left: 4px;
                bottom: 4px;
                background-color: white;
                -webkit-transition: .4s;
                transition: .4s;
            }
            input:checked + .slider {
                background-color: var(--spl-primary-accent);
            }
            input:focus + .slider {
                box-shadow: 0 0 1px var(--spl-primary-accent);
            }
            input:checked + .slider:before {
                -webkit-transform: translateX(20px);
                -ms-transform: translateX(20px);
                transform: translateX(20px);
            }
            /* Rounded sliders */
            .slider.round {
                border-radius: 25px;
            }
            .slider.round:before {
                border-radius: 50%;
            }
            /* Adjust switch background color for dark mode */
            body.dark-mode .theme-switch .slider {
                background-color: #555;
            }
            body.dark-mode input:checked + .slider {
                background-color: var(--spl-primary-accent);
            }
            body.dark-mode .theme-label {
                color: var(--spl-text-dark);
            }


            .container {
                background-color: var(--spl-container-bg);
                border-radius: 12px;
                box-shadow: 0 6px 12px var(--spl-shadow);
                padding: 30px;
                margin-bottom: 20px;
                width: 100%;
                max-width: 1200px;
                box-sizing: border-box;
                transition: background-color 0.3s ease, box-shadow 0.3s ease;
            }

            h1, h2, h3 {
                font-family: 'Oswald', sans-serif;
                color: var(--spl-primary-accent);
                text-align: center;
                margin-top: 0;
                margin-bottom: 20px;
                transition: color 0.3s ease;
            }
            
            .input-section {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 15px;
                margin-bottom: 30px;
            }

            /* --- Login/Signup Forms Styling --- */
            #authSection { 
                display: flex;
                flex-direction: column;
                align-items: center; 
                width: 100%; 
            }

            #loginForm, #signupForm {
                display: flex;
                flex-direction: column;
                align-items: center; 
                gap: 15px; 
                width: 100%; 
                max-width: 400px; 
                margin: 0 auto; 
                padding-bottom: 15px; 
                box-sizing: border-box; 
            }

            /* Input fields within login/signup forms */
            #loginForm input[type="email"],
            #loginForm input[type="password"],
            #signupForm input[type="email"],
            #signupForm input[type="password"],
            #signupForm input[type="text"] {
                display: block; 
                width: 100%; 
                max-width: 300px; 
                margin: 0 auto; 
                padding: 10px 12px; 
                border: 1px solid #ced4da; 
                border-radius: 4px; 
                font-size: 1em;
                box-sizing: border-box;
                text-align: left; 
                background-color: var(--spl-container-bg);
                color: var(--spl-text-dark);
                transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;

                -moz-appearance: textfield;
            }
            /* Webkit browsers (Chrome, Safari, Edge) for hiding arrows */
            .input-section input::-webkit-outer-spin-button,
            .input-section input::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            /* Buttons within login/signup forms */
            #loginForm button,
            #signupForm button {
                display: block; 
                width: 100%; 
                max-width: 300px; 
                margin: 0 auto; 
                background-color: #007bff; 
                color: white;
                padding: 10px 20px; 
                border: none;
                border-radius: 4px; 
                font-size: 1.1em;
                cursor: pointer;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); 
            }

            #loginForm button:hover,
            #signupForm button:hover {
                background-color: #0056b3; 
                transform: translateY(-1px); 
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
            }
            
            /* Centering the "Don't have an account?" and "Already have an account?" texts */
            #loginForm p,
            #signupForm p {
                text-align: center; 
                width: 100%; 
                max-width: 300px; 
                margin: 10px auto; 
                color: var(--spl-text-dark); 
                transition: color 0.3s ease; 
            }

            #loginForm p a,
            #signupForm p a {
                color: var(--spl-primary-accent); 
                text-decoration: none;
                font-weight: bold;
                transition: color 0.3s ease;
            }

            #loginForm p a:hover,
            #signupForm p a:hover {
                text-decoration: underline;
            }
            /* --- End Login/Signup Forms Styling --- */


            .input-section label {
                font-weight: bold;
                color: var(--spl-text-medium);
                font-size: 1.1em;
                transition: color 0.3s ease;
            }
            
            /* General input and button styles (for non-auth forms, if any) */
            .input-section input[type="text"],
            .input-section input[type="email"],
            .input-section input[type="password"] {
                padding: 12px 15px;
                border: 1px solid var(--spl-border-light);
                border-radius: 8px;
                font-size: 1em;
                box-sizing: border-box;
                text-align: center;
                background-color: var(--spl-container-bg);
                color: var(--spl-text-dark);
                transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            }

            .input-section button {
                background-color: var(--spl-primary-accent);
                color: white;
                padding: 12px 25px;
                border: none;
                border-radius: 8px;
                font-size: 1.1em;
                cursor: pointer;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
                box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
                display: block;
                margin: 0 auto;
            }
            .input-section button:hover {
                background-color: #0056b3;
                transform: translateY(-2px);
            }


            /* --- NEW MENU STYLES --- */
            #menuToggle {
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1001;
                cursor: pointer;
                font-size: 2em;
                color: var(--spl-primary-accent);
                transition: color 0.3s ease;
                display: none;
            }
            body.dark-mode #menuToggle {
                color: #fff;
            }

            #sidebarMenu {
                position: fixed;
                top: 0;
                left: -300px;
                width: 280px;
                height: 100%;
                background-color: var(--spl-container-bg);
                box-shadow: 3px 0 10px rgba(0, 0, 0, 0.2);
                z-index: 1000;
                transition: left 0.3s ease-in-out;
                padding-top: 20px;
                display: flex;
                flex-direction: column;
                gap: 10px;
                box-sizing: border-box;
            }
            body.dark-mode #sidebarMenu {
                background-color: var(--spl-container-bg);
            }

            #sidebarMenu.open {
                left: 0;
            }

            #sidebarMenu a {
                padding: 15px 25px;
                text-decoration: none;
                color: var(--spl-text-dark);
                font-size: 1.1em;
                display: block;
                transition: background-color 0.2s ease, color 0.2s ease;
                border-left: 5px solid transparent;
            }
            #sidebarMenu a:hover {
                background-color: var(--spl-table-row-hover);
                color: var(--spl-primary-accent);
            }
            body.dark-mode #sidebarMenu a {
                color: var(--spl-text-dark);
            }
            body.dark-mode #sidebarMenu a:hover {
                background-color: var(--spl-table-row-hover);
                color: var(--spl-primary-accent);
            }

            /* Red button style for Logout */
            .red-button {
                background-color: #DC3545 !important;
                color: white !important;
                padding: 10px 20px !important;
                border: none !important;
                border-radius: 4px !important;
                font-size: 1.1em !important;
                cursor: pointer !important;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease !important;
                box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2) !important;
                display: block;
                width: calc(100% - 50px);
                margin: 10px auto;
            }
            .red-button:hover {
                background-color: #c82333 !important;
                transform: translateY(-1px) !important;
                box-shadow: 0 4px 8px rgba(220, 53, 69, 0.25);
            }
            body.dark-mode .red-button {
                background-color: #f44336 !important;
                box-shadow: 0 44px 8px rgba(244, 67, 54, 0.2) !important;
            }
            body.dark-mode .red-button:hover {
                background-color: #d32f2f !important;
            }

            /* Sidebar Header for Team Name */
            #sidebarHeader {
                padding: 15px 25px 10px;
                font-family: 'Oswald', sans-serif;
                color: var(--spl-primary-accent);
                font-size: 1.2em;
                font-weight: bold;
                border-bottom: 1px solid var(--spl-border-light);
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
            }
            body.dark-mode #sidebarHeader {
                color: var(--spl-text-dark);
                border-bottom-color: var(--spl-border-light);
            }

            #sidebarTeamName {
                color: var(--spl-primary-accent);
                display: block; 
                margin-top: 5px; 
            }
            body.dark-mode #sidebarTeamName {
                color: #FFD700;
            }

            /* Manager ID Text in Sidebar */
            #sidebarManagerIdText {
                padding: 10px 25px;
                font-size: 0.95em;
                color: var(--spl-text-medium);
                margin-top: 10px;
                margin-bottom: 10px;
                text-align: center;
                border-top: 1px solid var(--spl-border-light);
                padding-top: 15px;
            }
            body.dark-mode #sidebarManagerIdText {
                color: var(--spl-text-medium);
                border-top-color: var(--spl-border-light);
            }


            /* This is the overlay when menu is open */
            #overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                display: none;
            }
            /* --- END NEW MENU STYLES --- */


            /* --- Admin Dashboard Specific Styles --- */
            #adminDashboardContent {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 20px;
                padding: 20px;
                margin-top: 20px;
                border-radius: 12px;
                background-color: var(--spl-container-bg); 
                box-shadow: 0 4px 8px var(--spl-shadow);
                width: 100%;
                max-width: 600px;
                box-sizing: border-box;
                min-height: 200px;
                margin-left: auto;
                margin-right: auto;
            }
            body.dark-mode #adminDashboardContent {
                background-color: var(--spl-container-bg);
            }

            #adminDashboardContent h2 {
                color: var(--spl-primary-accent);
                margin-bottom: 15px;
            }

            .admin-search-section, .admin-edit-section {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .admin-search-section input[type="text"],
            .admin-edit-section input[type="email"],
            .admin-edit-section input[type="text"] {
                width: 100%;
                max-width: 350px;
                padding: 10px 12px;
                border: 1px solid var(--spl-border-light);
                border-radius: 6px;
                font-size: 1em;
                background-color: var(--spl-table-bg); 
                color: var(--spl-text-dark);
                box-sizing: border-box;
                text-align: center;
            }

            .admin-search-section button,
            .admin-edit-section button {
                background-color: #6c757d; 
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                font-size: 1em;
                cursor: pointer;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                width: 100%;
                max-width: 350px;
            }
            .admin-search-section button:hover,
            .admin-edit-section button:hover {
                background-color: #5a6268;
                transform: translateY(-1px);
            }
            body.dark-mode .admin-search-section button,
            body.dark-mode .admin-edit-section button {
                background-color: #6f42c1; 
                box-shadow: 0 4px 8px rgba(111, 66, 193, 0.2);
            }
            body.dark-mode .admin-search-section button:hover,
            body.dark-mode .admin-edit-section button:hover {
                background-color: #5e35b1;
            }

            #adminSearchResults p {
                font-size: 1em;
                color: var(--spl-text-dark);
                margin-bottom: 5px;
                text-align: center;
                width: 100%;
            }
            #adminSearchResults strong {
                color: var(--spl-primary-accent);
            }

            /* Separate message box for admin actions */
            #adminMessage {
                text-align: center;
                padding: 10px;
                border-radius: 6px;
                margin-top: 10px;
                font-weight: bold;
                background-color: #d1ecf1;
                color: #0c5460;
                width: 100%;
                max-width: 350px;
                box-sizing: border-box;
                display: none;
            }
            body.dark-mode #adminMessage {
                background-color: #1f3d54;
                color: #b0e0e6;
            }
            /* New Admin Dashboard internal navigation buttons */
            .admin-dashboard-nav-buttons {
                display: flex;
                justify-content: center;
                gap: 15px;
                width: 100%;
                margin-bottom: 20px;
            }
            .admin-dashboard-nav-buttons button {
                background-color: var(--spl-primary-accent);
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                font-size: 1em;
                cursor: pointer;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                min-width: 120px;
            }
            .admin-dashboard-nav-buttons button:hover {
                background-color: #0056b3;
                transform: translateY(-1px);
            }
            body.dark-mode .admin-dashboard-nav-buttons button {
                background-color: #007bff;
            }
            body.dark-mode .admin-dashboard-nav-buttons button:hover {
                background-color: #0056b3;
            }
            /* --- End Admin Dashboard Specific Styles --- */


            .message-box { 
                text-align: center;
                padding: 15px;
                border-radius: 8px;
                margin-top: 15px;
                font-weight: bold;
                display: none; 
            }
            .message-box.success { background-color: #d4edda; color: #155724; }
            .message-box.error { background-color: #f8d7da; color: #721c24; }
            .message-box.info { background-color: #d1ecf1; color: #0c5460; }
            .message-box.warning { background-color: #fff3cd; color: #856404; } 


            .loading-message, .error-message { 
                text-align: center;
                padding: 20px;
                border-radius: 8px;
                margin-top: 20px;
                font-weight: bold;
                transition: background-color 0.3s ease, color 0.3s ease; 
            }

            .loading-message {
                background-color: #e0f7fa;
                color: #007BFF;
            }

            .error-message {
                background-color: #ffe0e6;
                color: #DC3545;
                border: 1px solid #DC3545;
            }

            /* Responsive Adjustments */
            @media (max-width: 950px) {
                body {
                    padding: 15px;
                }

                .container {
                    padding: 20px;
                }

                /* inputs and buttons inside specific forms */
                #loginForm input[type="text"],
                #loginForm input[type="email"],
                #loginForm input[type="password"],
                #signupForm input[type="text"],
                #signupForm input[type="email"],
                #signupForm input[type="password"],
                #loginForm button,
                #signupForm button {
                    font-size: 0.95em;
                    padding: 10px 20px;
                }
            }

            @media (max-width: 480px) {
                h1 {
                    font-size: 1.8em;
                }
                h2 {
                    font-size: 1.4em;
                }
                .input-section {
                    gap: 10px;
                }
            }

            .instructions {
                background-color: #e9ecef;
                border-left: 5px solid var(--spl-primary-accent);
                padding: 15px 20px;
                margin-top: 20px;
                border-radius: 8px;
                font-size: 0.95em;
                color: var(--spl-text-dark);
                line-height: 1.5;
                width: 100%;
                max-width: 600px;
                box-sizing: border-box;
                text-align: left;
                transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
            }
            .instructions h3 {
                color: var(--spl-primary-accent);
                margin-top: 0;
                margin-bottom: 10px;
                text-align: left;
                transition: color 0.3s ease;
            }
            .instructions ol {
                margin-left: 20px;
                padding-left: 0;
            }
            .instructions li {
                margin-bottom: 8px;
            }
            .instructions a {
                color: var(--spl-primary-accent);
                text-decoration: none;
                font-weight: bold;
                transition: color 0.3s ease;
            }
            .instructions a:hover {
                text-decoration: underline;
            }

            /* Dark mode specific styles for the instructions box text */
            body.dark-mode .instructions {
                background-color: var(--spl-light-bg);
                border-left-color: var(--spl-primary-accent);
                color: var(--spl-text-dark);
            }
            body.dark-mode .instructions h3,
            body.dark-mode .instructions a {
                color: #FFD700;
            }

            /* FDR Difficulty Scale Colors */
            .fdr-scale {
                display: flex;
                justify-content: center;
                align-items: center;
                margin-bottom: 20px; /* Adjusted margin */
                font-weight: bold;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                width: 100%; /* Ensure it takes full width of its container */
                max-width: 700px; /* Limit max width for readability */
                margin-left: auto;
                margin-right: auto;
            }
            .fdr-level {
                padding: 8px 12px;
                text-align: center;
                color: black;
                flex-grow: 1;
                min-width: 50px;
                transition: background-color 0.3s ease, color 0.3s ease;
            }
            .fdr-level span {
                display: block;
                font-size: 0.8em;
                margin-top: 2px;
            }

            /* Specific FDR Colors */
            .fdr-1 { background-color: #00B050; color: white; }
            .fdr-2 { background-color: #92D050; color: black; }
            .fdr-3 { background-color: #FFFF00; color: black; }
            .fdr-4 { background-color: #FFC000; color: black; }
            .fdr-5 { background-color: #FF0000; color: white; }
            .fdr-6 { background-color: #C00000; color: white; }
            .fdr-7 { background-color: #800000; color: white; }
            
            /* Dark Mode Adjustments for FDR Colors */
            body.dark-mode .fdr-level {
                color: white;
            }
            body.dark-mode .fdr-2, body.dark-mode .fdr-3, body.dark-mode .fdr-4 {
                color: black;
            }
            body.dark-mode .fdr-1 { background-color: #008037; }
            body.dark-mode .fdr-2 { background-color: #6B9F3B; }
            body.dark-mode .fdr-3 { background-color: #B3B300; }
            body.dark-mode .fdr-4 { background-color: #B38600; }
            body.dark-mode .fdr-5 { background-color: #B30000; }
            body.dark-mode .fdr-6 { background-color: #800000; }
            body.dark-mode .fdr-7 { background-color: #530000; }

            /* Styles for the two-column FDR display (Overall) */
            .fdr-data-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0;
                border: 1px solid var(--spl-border-light);
                border-radius: 8px;
                overflow: hidden;
                box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
            }
            body.dark-mode .fdr-data-grid {
                border-color: rgba(255,255,255,0.1);
                box-shadow: inset 0 0 5px rgba(255,255,255,0.05);
            }

            /* Styles for single-column FDR display (Home/Away) */
            .fdr-single-column-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0;
                border: 1px solid var(--spl-border-light);
                border-radius: 8px;
                overflow: hidden;
                box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
            }
            body.dark-mode .fdr-single-column-grid {
                border-color: rgba(255,255,255,0.1);
                box-shadow: inset 0 0 5px rgba(255,255,255,0.05);
            }

            .fdr-grid-item {
                padding: 10px 15px;
                text-align: center;
                font-weight: bold;
                font-size: 0.95em;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 5px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                color: black;
                min-height: 45px;
                box-sizing: border-box;
                border-bottom: 1px solid var(--spl-border-light);
                transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            }
            body.dark-mode .fdr-grid-item {
                color: white;
                border-bottom-color: rgba(255,255,255,0.1);
            }

            /* Vertical separator for the left column items (only applies to two-column grids) */
            .fdr-data-grid .fdr-grid-item:nth-child(2n-1) {
                border-right: 1px solid var(--spl-border-light);
                transition: border-color 0.3s ease;
            }
            body.dark-mode .fdr-data-grid .fdr-grid-item:nth-child(2n-1) {
                border-right-color: rgba(255,255,255,0.1);
            }

            /* Remove bottom border for items in the last "row" (last two items for 2-col, last item for 1-col) */
            .fdr-data-grid > :nth-last-child(-n + 2) { 
                border-bottom: none;
            }
            .fdr-single-column-grid > :last-child {
                border-bottom: none;
            }
            /* Style for the upload button label to make it look like a button */
            .upload-button-label {
                display: inline-block;
                background-color: var(--spl-primary-accent);
                color: white;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 1em;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                margin-top: 10px;
            }

            .upload-button-label:hover {
                background-color: #0056b3;
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            }

            .upload-button-label input[type="file"] {
                display: none;
            }
            /* Responsive adjustments for the new grid */
            @media (max-width: 480px) {
                .fdr-grid-item {
                    font-size: 0.8em;
                    padding: 8px 10px;
                    min-height: 35px;
                }
            }

            /* Styles for the FDR system selection in My Control Room */
            .fdr-system-selection {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin-bottom: 20px;
                flex-wrap: wrap; /* Allow wrapping on smaller screens */
            }

            .fdr-system-selection label {
                display: flex;
                align-items: center;
                cursor: pointer;
                font-weight: bold;
                color: var(--spl-text-dark);
                transition: color 0.3s ease;
            }

            .fdr-system-selection input[type="radio"] {
                margin-right: 8px;
                accent-color: var(--spl-primary-accent); /* Style the radio button itself */
                transform: scale(1.2); /* Make radio buttons slightly larger */
            }

            .fdr-system-selection button {
                background-color: var(--spl-primary-accent);
                color: white;
                padding: 8px 15px;
                border: none;
                border-radius: 6px;
                font-size: 0.9em;
                cursor: pointer;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .fdr-system-selection button:hover {
                background-color: #0056b3;
                transform: translateY(-1px);
            }
            body.dark-mode .fdr-system-selection label {
                color: var(--spl-text-dark);
            }
            body.dark-mode .fdr-system-selection button {
                background-color: #007bff;
            }
            body.dark-mode .fdr-system-selection button:hover {
                background-color: #0056b3;
            }

            /* Styles for individual fixture display */
            .fixture-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 15px;
                border-bottom: 1px solid var(--spl-border-light);
                background-color: var(--spl-container-bg);
                transition: background-color 0.3s ease;
            }
            .fixture-item:last-child {
                border-bottom: none;
            }
            .fixture-item span {
                font-weight: bold;
                color: var(--spl-text-dark);
            }
            .fixture-item .fdr-value {
                padding: 5px 10px;
                border-radius: 5px;
                font-weight: bold;
                color: white; /* Default for FDR colors */
                min-width: 40px;
                text-align: center;
            }

            body.dark-mode .fixture-item {
                background-color: var(--spl-container-bg);
                border-bottom-color: rgba(255,255,255,0.1);
            }
            body.dark-mode .fixture-item span {
                color: var(--spl-text-dark);
            }

            /* Container for fixtures list */
            .fixtures-list-container {
                border: 1px solid var(--spl-border-light);
                border-radius: 8px;
                overflow: hidden;
                box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
                margin-top: 20px;
                max-width: 400px; /* Limit width for readability */
                width: 100%;
                margin-left: auto;
                margin-right: auto;
            }
            body.dark-mode .fixtures-list-container {
                border-color: rgba(255,255,255,0.1);
                box-shadow: inset 0 0 5px rgba(255,255,255,0.05);
            }

            .fdr-section-title {
                text-align: center;
                font-size: 1.1em;
                font-weight: bold;
                color: var(--spl-primary-accent);
                margin-top: 25px;
                margin-bottom: 15px;
            }
            body.dark-mode .fdr-section-title {
                color: #FFD700;
            }

            /* Styles for Customized FDR inputs */
            .custom-fdr-input-group {
                display: flex;
                flex-direction: column; /* Stack opponent and input */
                justify-content: center; /* Center content vertically */
                align-items: center; /* Center content horizontally */
                padding: 5px; /* Reduced padding */
                border-bottom: 1px solid var(--spl-border-light);
                background-color: var(--spl-container-bg);
                transition: background-color 0.3s ease;
                min-height: 60px; /* Ensure enough height for stacked elements */
            }
            .custom-fdr-input-group:last-child {
                border-bottom: none;
            }
            .custom-fdr-input-group span {
                font-weight: bold;
                color: var(--spl-text-dark);
                text-align: center;
                margin-bottom: 5px; /* Space between opponent name and input */
            }
            .custom-fdr-input-group input[type="number"] {
                width: 50px; /* Slightly smaller input */
                padding: 3px; /* Reduced padding */
                border: 1px solid var(--spl-border-light);
                border-radius: 4px;
                text-align: center;
                font-size: 0.8em; /* Smaller font size */
                background-color: var(--spl-table-bg);
                color: var(--spl-text-dark);
            }
            .custom-fdr-input-group input[type="number"]:focus {
                outline: none;
                border-color: var(--spl-primary-accent);
                box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
            }
            body.dark-mode .custom-fdr-input-group {
                background-color: var(--spl-container-bg);
                border-bottom-color: rgba(255,255,255,0.1);
            }
            body.dark-mode .custom-fdr-input-group span {
                color: var(--spl-text-dark);
            }
            body.dark-mode .custom-fdr-input-group input[type="number"] {
                background-color: var(--spl-table-bg);
                color: var(--spl-text-dark);
                border-color: var(--spl-border-light);
            }

            /* Styling for the main FDR button in My Control Room */
            #showFDRButton {
                display: block;
                margin: 20px auto; /* Center the button */
                background-color: var(--spl-primary-accent);
                color: white;
                padding: 15px 30px;
                border: none;
                border-radius: 8px;
                font-size: 1.2em;
                cursor: pointer;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
                box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
                max-width: fit-content; /* Adjust width to content */
            }
            #showFDRButton:hover {
                background-color: #0056b3;
                transform: translateY(-2px);
                box-shadow: 0 6px 12px rgba(0, 123, 255, 0.3);
            }
            body.dark-mode #showFDRButton {
                background-color: #007bff;
            }
            body.dark-mode #showFDRButton:hover {
                background-color: #0056b3;
            }

            #fdrSystemsContainer {
                display: none; /* Hidden by default, shown when FDR button is clicked */
                flex-direction: column;
                align-items: center;
                gap: 20px;
                margin-top: 20px;
                padding: 20px;
                border-radius: 12px;
                background-color: var(--spl-container-bg);
                box-shadow: 0 4px 8px var(--spl-shadow);
                width: 100%;
                max-width: 1200px; /* Increased max-width to accommodate schedule table */
                box-sizing: border-box;
                margin-left: auto;
                margin-right: auto;
            }
            #fdrSystemsContainer p {
                text-align: center;
                font-size: 1.1em;
                color: var(--spl-text-dark);
                margin-bottom: 10px;
            }

            /* New: Welcome Dashboard content */
            #initialLoggedInDashboardContent {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 200px;
                text-align: center;
                padding: 20px;
                color: var(--spl-text-dark);
            }
            #initialLoggedInDashboardContent h2 {
                color: var(--spl-primary-accent);
            }

            /* Schedule display styles */
            .schedule-table-container {
                width: 100%;
                overflow-x: auto; /* Allows horizontal scrolling for large tables */
                margin-top: 20px; /* Adjusted margin */
                border: 1px solid var(--spl-border-light);
                border-radius: 8px;
                box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
                background-color: var(--spl-container-bg);
            }
            body.dark-mode .schedule-table-container {
                border-color: rgba(255,255,255,0.1);
                box-shadow: inset 0 0 5px rgba(255,255,255,0.05);
            }

            .schedule-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 0.9em;
                min-width: 600px; /* Ensure table doesn't get too squished */
            }

            .schedule-table th, .schedule-table td {
                border: 1px solid var(--spl-border-light);
                padding: 8px 12px;
                text-align: center;
                white-space: nowrap; /* Prevent wrapping in cells */
                transition: background-color 0.3s ease, border-color 0.3s ease;
            }

            .schedule-table th {
                background-color: var(--spl-table-header-bg);
                color: var(--spl-text-dark);
                font-weight: bold;
                position: sticky;
                top: 0; /* Keeps header visible on scroll */
                z-index: 10;
            }
            body.dark-mode .schedule-table th {
                background-color: var(--spl-table-header-bg);
                color: var(--spl-text-dark);
            }

            .schedule-table tr:nth-child(even) {
                background-color: var(--spl-table-row-even);
            }
            body.dark-mode .schedule-table tr:nth-child(even) {
                background-color: var(--spl-table-row-even);
            }

            .schedule-table tr:hover {
                background-color: var(--spl-table-row-hover);
            }
            body.dark-mode .schedule-table tr:hover {
                background-color: var(--spl-table-row-hover);
            }

            .schedule-table td {
                color: var(--spl-text-dark);
            }
            body.dark-mode .schedule-table td {
                color: var(--spl-text-dark);
            }

            /* Specific styling for fixture cells */
            .fixture-cell {
                display: flex;
                flex-direction: column; /* Stack multiple fixtures */
                align-items: center;
                justify-content: center;
                gap: 5px;
                font-weight: bold;
                padding: 5px 8px;
                border-radius: 4px;
                min-width: 60px; /* Ensure enough space for opponent + FDR */
            }
            .fixture-item-display {
                display: flex;
                align-items: center;
                gap: 5px;
                padding: 2px 5px;
                border-radius: 3px;
                font-size: 0.85em; /* Smaller font for individual fixture in a cell */
                white-space: nowrap;
                /* No background-color or color for FDR here anymore */
            }
        </style>
    </head>
    <body>
        <!-- Firebase Configuration (will be injected by Netlify build) -->
        <script>
            // Global API URLs (will be injected by Netlify build)
            const BOOTSTRAP_STATIC_API_URL = "___BOOTSTRAP_STATIC_API_URL_PLACEHOLDER___";
            const FIXTURES_API_BASE_URL = "___FIXTURES_API_BASE_URL_PLACEHOLDER___";
        </script>

        <!-- Hamburger Menu Icon -->
        <div id="menuToggle"><i class="fas fa-bars"></i></div>

        <!-- Sidebar Menu -->
        <div id="sidebarMenu">
            <div id="sidebarHeader">
                Welcome, <span id="sidebarTeamName"></span>!
                <span id="sidebarManagerIdText"></span>
            </div>
            <a href="#" id="menuMyControlRoom">My Control Room</a>
            <a href="#" id="menuAdminDashboard">Admin Dashboard</a>
            <button id="logoutButton" class="red-button">Logout</button>
        </div>

        <!-- Overlay for when the sidebar is open -->
        <div id="overlay"></div>

        <div id="logo-container">
            <img id="appLogo" src="unnamed.jpg" alt="App Logo">
        </div>

        <div class="theme-switch-wrapper">
            <label class="theme-label">Light Mode</label>
            <label class="theme-switch">
                <input type="checkbox" id="themeSwitch">
                <span class="slider round"></span>
            </label>
            <label class="theme-label">Dark Mode</label>
        </div>

        <!-- Authentication Section -->
        <div id="authSection" class="container">
            <h1>Welcome to Control Room V2</h1>
            <div id="loginForm">
                <h2>Login</h2>
                <input type="email" id="loginEmail" placeholder="Email" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button id="loginButton">Login</button>
                <p>Don't have an account? <a href="#" id="showSignup">Sign Up</a></p>
            </div>

            <div id="signupForm" style="display: none;">
                <h2>Sign Up</h2>
                <input type="text" id="signupTeamName" placeholder="Team Name" required>
                <input type="email" id="signupEmail" placeholder="Email" required>
                <input type="password" id="signupPassword" placeholder="Password" required>
                <button id="signupButton">Sign Up</button>
                <p>Already have an account? <a href="#" id="showLogin">Login</a></p>
            </div>
            <div id="authMessageBox" class="message-box" style="display: none;"></div>
        </div>

        <!-- Initial Logged In Dashboard Content -->
        <div id="initialLoggedInDashboardContent" class="container" style="display: none;">
            <h2>Welcome to your Control Room!</h2>
            <p>Use the menu on the left to navigate.</p>
        </div>

        <!-- My Control Room Section -->
        <div id="controlRoomContent" class="container" style="display: none;">
            <h1>My Control Room</h1>

            <div class="input-section">
                <label for="managerIdInput">Enter Manager ID:</label>
                <input type="number" id="managerIdInput" placeholder="e.g., 12345" required>
                <button id="fetchDataButton">Fetch My Data</button>
                <div id="controlRoomMessageBox" class="message-box" style="display: none;"></div>
            </div>

            <div class="instructions">
                <h3>How to use:</h3>
                <ol>
                    <li>Enter your Fantasy SPL Manager ID (you can find it in your team's URL on the Fantasy SPL website).</li>
                    <li>Click "Fetch My Data" to load your team's statistics and analyze your performance.</li>
                    <li>Use the "FDR" button to display the Fixture Difficulty Rating schedule.</li>
                </ol>
            </div>

            <!-- Manager Stats Display -->
            <div id="managerStats" style="display: none;">
                <h2>Manager Statistics for <span id="displayManagerName"></span></h2>
                <p><strong>Overall Rank:</strong> <span id="overallRank"></span></p>
                <p><strong>Total Points:</strong> <span id="totalPoints"></span></p>
                <p><strong>Gameweek Points:</strong> <span id="gameweekPoints"></span></p>
                <p><strong>Gameweek Rank:</strong> <span id="gameweekRank"></span></p>
                <p><strong>Average Points for 1st Place:</strong> <span id="averagePointsFor1stPlace"></span></p>
                <p><strong>Best Round:</strong> <span id="bestRound"></span></p>
                <p><strong>Worst Round:</strong> <span id="worstRound"></span></p>
                <p><strong>Green Arrows:</strong> <span id="greenArrowsCount"></span></p>
                <p><strong>Red Arrows:</strong> <span id="redArrowsCount"></span></p>

                <h3>Top 3 Captains (Total Points from Captaincy)</h3>
                <ul id="top3CaptainsList"></ul>

                <h3>Best Players (Points per Game)</h3>
                <ul id="bestPlayersList"></ul>

                <h3>Worst Players (Points per Game)</h3>
                <ul id="worstPlayersList"></ul>

                <h3>Top 5 Missed Points (Players on Bench)</h3>
                <ul id="top5MissedPointsList"></ul>

                <h3>Transfers Overview</h3>
                <p><strong>Total Transfers:</strong> <span id="totalTransfersCount"></span></p>
                <p><strong>Total Hits Taken:</strong> <span id="totalHitsPoints"></span></p>

                <h3>Top 5 Profitable Transfers (Points Gained)</h3>
                <ul id="top5ProfitableTransfersList"></ul>

                <h3>Top 5 Loss-Making Transfers (Points Lost)</h3>
                <ul id="top5LossMakingTransfersList"></ul>

                <button id="screenshotButton">Take Screenshot</button>
                <button id="gifButton">Generate GIF (Last 5 GWs)</button>
                <div id="screenshotMessage" class="message-box" style="display: none;"></div>
                <div id="gifMessage" class="message-box" style="display: none;"></div>
                <img id="screenshotPreview" style="max-width: 100%; margin-top: 20px; display: none;" alt="Screenshot Preview">
                <img id="gifPreview" style="max-width: 100%; margin-top: 20px; display: none;" alt="GIF Preview">
            </div>

            <!-- FDR Section -->
            <div id="fdrSection">
                <h2>FDR</h2>
                <div class="fdr-system-selection">
                    <p>Please Choose FDR System:</p>
                    <label>
                        <input type="radio" name="fdrSystem" value="overall" id="radioOverallFDR" checked> Overall FDR
                    </label>
                    <label>
                        <input type="radio" name="fdrSystem" value="homeAway" id="radioHomeAwayFDR"> Home/Away FDR
                    </label>
                    <label>
                        <input type="radio" name="fdrSystem" value="customized" id="radioCustomizedFDR"> Customized FDR
                    </label>
                    <button id="saveCustomFDRButton" style="display: none;">Save My FDR System</button>
                    <input type="file" id="uploadFDRFile" accept=".xlsx, .xls" style="display: none;">
                    <label for="uploadFDRFile" class="upload-button-label" id="uploadFDRLabel" style="display: none;">Upload FDR File</label>
                </div>

                <div class="fdr-scale">
                    <div class="fdr-level fdr-1">1<span>Very Easy</span></div>
                    <div class="fdr-level fdr-2">2</div>
                    <div class="fdr-level fdr-3">3</div>
                    <div class="fdr-level fdr-4">4</div>
                    <div class="fdr-level fdr-5">5<span>Very Hard</span></div>
                    <div class="fdr-level fdr-6">6</div>
                    <div class="fdr-level fdr-7">7</div>
                </div>

                <div class="input-section">
                    <label for="roundsToShowSlider">Rounds:</label>
                    <input type="range" id="roundsToShowSlider" min="1" max="5" value="5">
                    <span id="roundsToShowValueSpan">5</span>
                </div>

                <h3 class="fdr-section-title">Overall Fixture Difficulty Schedule</h3>
                <div id="overallFDRDisplay" class="schedule-table-container">
                    <!-- Overall FDR schedule table will be rendered here -->
                </div>

                <h3 class="fdr-section-title" style="display: none;">Home/Away Fixture Difficulty Schedule</h3>
                <div id="homeAwayFDRDisplay" class="fixtures-list-container" style="display: none;">
                    <!-- Home/Away FDR schedule will be rendered here -->
                </div>

                <h3 class="fdr-section-title" style="display: none;">Customized Fixture Difficulty Inputs</h3>
                <div id="customizedFDRInputs" class="fixtures-list-container" style="display: none;">
                    <!-- Customized FDR input fields will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Admin Dashboard Section -->
        <div id="adminDashboardContent" class="container" style="display: none;">
            <h2>Admin Dashboard</h2>

            <div class="admin-dashboard-nav-buttons">
                <button id="showAdminSearchUser">Search User</button>
                <button id="showAdminUploadFDR">Upload Global FDR</button>
            </div>

            <!-- Admin Search User Section -->
            <div id="adminSearchUserSection">
                <h3>Search User by Email or Manager ID</h3>
                <div class="admin-search-section">
                    <input type="text" id="adminSearchInput" placeholder="User Email or Manager ID">
                    <button id="adminSearchButton">Search User</button>
                </div>
                <div id="adminSearchResults"></div>
                <div id="adminEditUserSection" class="admin-edit-section" style="display: none;">
                    <h3>Edit User Role</h3>
                    <p><strong>User ID:</strong> <span id="adminEditUserId"></span></p>
                    <p><strong>Current Role:</strong> <span id="adminEditCurrentRole"></span></p>
                    <label for="adminNewRole">New Role:</label>
                    <select id="adminNewRole">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                    <button id="adminUpdateRoleButton">Update Role</button>
                    <button id="adminDeleteUserButton" class="red-button">Delete User</button>
                </div>
            </div>

            <!-- Admin Upload Global FDR Section -->
            <div id="adminUploadFDRSection" style="display: none;">
                <h3>Upload Global Fixture Difficulty Rating (FDR)</h3>
                <p>Upload an Excel file (.xlsx, .xls) containing the global FDR data.</p>
                <input type="file" id="globalFDRFileUpload" accept=".xlsx, .xls" style="display: none;">
                <label for="globalFDRFileUpload" class="upload-button-label">Upload Global FDR File</label>
                <button id="processGlobalFDRButton" style="display: none;">Process and Save Global FDR</button>
            </div>
            <div id="adminMessage" class="message-box" style="display: none;"></div>
        </div>

        <script type="module">
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
            import { 
                getAuth, 
                signInWithEmailAndPassword, 
                createUserWithEmailAndPassword, 
                signOut, 
                onAuthStateChanged,
                signInWithCustomToken,
                signInAnonymously
            } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
            import { 
                getFirestore, 
                doc, 
                getDoc, 
                setDoc, 
                collection, 
                query, 
                where, 
                getDocs, 
                updateDoc,
                deleteDoc 
            } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

            // Access global config provided by the environment
            // Ensure __firebase_config is parsed correctly, providing a fallback for safety
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'); 

            // Firebase App initialization - Declared and initialized globally once
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // Global variables for data (ensure these are reset or managed properly on logout/new user)
            let currentUserId = null;
            let currentTeamName = null;
            let currentManagerId = null;
            let globalSeasonSchedule = null; // Stores the fetched/uploaded FDR data
            let teamNames = {}; // Stores team ID to short name mapping
            let currentFDRType = 'overall'; // Default FDR type
            let isAuthReady = false; // Flag to indicate if auth state has been checked

            // --- DOM Elements ---
            const authSection = document.getElementById('authSection');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');
            const loginButton = document.getElementById('loginButton');
            const showSignup = document.getElementById('showSignup');
            const signupTeamName = document.getElementById('signupTeamName');
            const signupEmail = document.getElementById('signupEmail');
            const signupPassword = document.getElementById('signupPassword');
            const signupButton = document.getElementById('signupButton');
            const showLogin = document.getElementById('showLogin');
            const authMessageBox = document.getElementById('authMessageBox');

            const initialLoggedInDashboardContent = document.getElementById('initialLoggedInDashboardContent');
            const controlRoomContent = document.getElementById('controlRoomContent');
            const adminDashboardContent = document.getElementById('adminDashboardContent');

            const menuToggle = document.getElementById('menuToggle');
            const sidebarMenu = document.getElementById('sidebarMenu');
            const overlay = document.getElementById('overlay');
            const logoutButton = document.getElementById('logoutButton');
            const menuMyControlRoom = document.getElementById('menuMyControlRoom');
            const menuAdminDashboard = document.getElementById('menuAdminDashboard');
            const sidebarTeamName = document.getElementById('sidebarTeamName');
            const sidebarManagerIdText = document.getElementById('sidebarManagerIdText');

            const managerIdInput = document.getElementById('managerIdInput');
            const fetchDataButton = document.getElementById('fetchDataButton');
            const controlRoomMessageBox = document.getElementById('controlRoomMessageBox');
            const managerStatsDiv = document.getElementById('managerStats');
            const displayManagerName = document.getElementById('displayManagerName');
            const overallRankSpan = document.getElementById('overallRank');
            const totalPointsSpan = document.getElementById('totalPoints');
            const gameweekPointsSpan = document.getElementById('gameweekPoints');
            const gameweekRankSpan = document.getElementById('gameweekRank');
            const averagePointsFor1stPlaceSpan = document.getElementById('averagePointsFor1stPlace');
            const top3CaptainsList = document.getElementById('top3CaptainsList');
            const bestPlayersList = document.getElementById('bestPlayersList');
            const worstPlayersList = document.getElementById('worstPlayersList');
            const top5MissedPointsList = document.getElementById('top5MissedPointsList');
            const totalTransfersCountSpan = document.getElementById('totalTransfersCount');
            const totalHitsPointsSpan = document.getElementById('totalHitsPoints');
            const top5ProfitableTransfersList = document.getElementById('top5ProfitableTransfersList');
            const top5LossMakingTransfersList = document.getElementById('top5LossMakingTransfersList');
            const bestRoundSpan = document.getElementById('bestRound');
            const worstRoundSpan = document.getElementById('worstRound');
            const greenArrowsCountSpan = document.getElementById('greenArrowsCount');
            const redArrowsCountSpan = document.getElementById('redArrowsCount');

            const screenshotButton = document.getElementById('screenshotButton');
            const gifButton = document.getElementById('gifButton');
            const screenshotMessage = document.getElementById('screenshotMessage');
            const gifMessage = document.getElementById('gifMessage');
            const screenshotPreview = document.getElementById('screenshotPreview');
            const gifPreview = document.getElementById('gifPreview');

            const fdrSection = document.getElementById('fdrSection');
            const radioOverallFDR = document.getElementById('radioOverallFDR');
            const radioHomeAwayFDR = document.getElementById('radioHomeAwayFDR');
            const radioCustomizedFDR = document.getElementById('radioCustomizedFDR');
            const saveCustomFDRButton = document.getElementById('saveCustomFDRButton');
            const uploadFDRFile = document.getElementById('uploadFDRFile');
            const uploadFDRLabel = document.getElementById('uploadFDRLabel');
            const roundsToShowSlider = document.getElementById('roundsToShowSlider');
            const roundsToShowValueSpan = document.getElementById('roundsToShowValueSpan');
            const overallFDRDisplay = document.getElementById('overallFDRDisplay');
            const homeAwayFDRDisplay = document.getElementById('homeAwayFDRDisplay');
            const customizedFDRInputs = document.getElementById('customizedFDRInputs');

            const adminSearchUserButton = document.getElementById('showAdminSearchUser');
            const adminUploadFDRButton = document.getElementById('showAdminUploadFDR');
            const adminSearchUserSection = document.getElementById('adminSearchUserSection');
            const adminUploadFDRSection = document.getElementById('adminUploadFDRSection');
            const adminSearchInput = document.getElementById('adminSearchInput');
            const adminSearchButton = document.getElementById('adminSearchButton');
            const adminSearchResults = document.getElementById('adminSearchResults');
            const adminEditUserSection = document.getElementById('adminEditUserSection');
            const adminEditUserId = document.getElementById('adminEditUserId');
            const adminEditCurrentRole = document.getElementById('adminEditCurrentRole');
            const adminNewRole = document.getElementById('adminNewRole');
            const adminUpdateRoleButton = document.getElementById('adminUpdateRoleButton');
            const adminDeleteUserButton = document.getElementById('adminDeleteUserButton');
            const globalFDRFileUpload = document.getElementById('globalFDRFileUpload');
            const processGlobalFDRButton = document.getElementById('processGlobalFDRButton');
            const adminMessage = document.getElementById('adminMessage');

            const appLogo = document.getElementById('appLogo');
            const themeSwitch = document.getElementById('themeSwitch');

            // --- Utility Functions ---

            /**
             * Displays a message in a designated message box.
             * @param {HTMLElement} messageBoxElement - The HTML element to display the message in.
             * @param {string} message - The message text.
             * @param {string} type - The type of message ('success', 'error', 'info', 'warning').
             * @param {number} duration - How long the message should be displayed in milliseconds.
             */
            function showMessage(messageBoxElement, message, type, duration = 5000) {
                messageBoxElement.textContent = message;
                messageBoxElement.className = `message-box ${type}`;
                messageBoxElement.style.display = 'block';
                setTimeout(() => {
                    messageBoxElement.style.display = 'none';
                }, duration);
            }

            /**
             * Hides all content sections and displays the requested one.
             * @param {string} sectionId - The ID of the section to display ('auth', 'initialLoggedInDashboard', 'controlRoom', 'adminDashboard').
             */
            function showContentSection(sectionId) {
                authSection.style.display = 'none';
                initialLoggedInDashboardContent.style.display = 'none';
                controlRoomContent.style.display = 'none';
                adminDashboardContent.style.display = 'none';

                if (sectionId === 'auth') {
                    authSection.style.display = 'block';
                } else if (sectionId === 'initialLoggedInDashboard') {
                    initialLoggedInDashboardContent.style.display = 'flex';
                } else if (sectionId === 'controlRoom') {
                    controlRoomContent.style.display = 'block';
                } else if (sectionId === 'adminDashboard') {
                    adminDashboardContent.style.display = 'flex'; // Use flex for admin dashboard
                    showAdminSection('searchUser'); // Default to search user section
                }
            }

            /**
             * Shows a specific sub-section within the Admin Dashboard.
             * @param {string} section - 'searchUser' or 'uploadFDR'.
             */
            function showAdminSection(section) {
                adminSearchUserSection.style.display = 'none';
                adminUploadFDRSection.style.display = 'none';
                adminEditUserSection.style.display = 'none'; // Hide edit section when switching

                if (section === 'searchUser') {
                    adminSearchUserSection.style.display = 'block';
                } else if (section === 'uploadFDR') {
                    adminUploadFDRSection.style.display = 'block';
                }
                adminMessage.style.display = 'none'; // Clear any admin messages
            }

            /**
             * Toggles the theme between light and dark mode.
             */
            function toggleTheme() {
                document.body.classList.toggle('dark-mode', themeSwitch.checked);
                localStorage.setItem('theme', themeSwitch.checked ? 'dark' : 'light');
                updateLogo();
            }

            /**
             * Updates the logo based on the current theme.
             */
            function updateLogo() {
                if (document.body.classList.contains('dark-mode')) {
                    appLogo.src = 'dark mode logo.jpg'; // Path to your dark mode logo
                } else {
                    appLogo.src = 'unnamed.jpg'; // Path to your light mode logo
                }
            }

            /**
             * Fetches data from a Netlify proxy function.
             * @param {string} endpoint - The API endpoint (e.g., 'bootstrap-static', 'fixtures').
             * @param {string} params - Query parameters for the endpoint.
             * @returns {Promise<Object>} - The JSON response from the API.
             */
            async function fetchFromNetlifyProxy(endpoint, params = '') {
                const proxyUrl = `/.netlify/functions/spl-proxy?url=${encodeURIComponent(endpoint + params)}`;
                console.log(`Fetching from proxy: ${proxyUrl}`);
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Proxy fetch failed: ${response.status} - ${errorData.error || response.statusText}`);
                }
                return response.json();
            }

            /**
             * Fetches manager data using the Netlify function.
             * @param {string} managerId - The manager's ID.
             * @returns {Promise<Object>} - The manager's data.
             */
            async function fetchManagerData(managerId) {
                const url = `/.netlify/functions/fetch-spl-data?managerId=${managerId}`;
                console.log(`Fetching manager data from: ${url}`);
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to fetch manager data: ${response.status} - ${errorData.error || response.statusText}`);
                }
                return response.json();
            }

            /**
             * Fetches the global FDR data from Firestore.
             * @returns {Promise<Object|null>} The global season schedule object, or null if not found.
             */
            async function fetchGlobalFDRData() {
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const docRef = doc(db, `artifacts/${appId}/public/data/globalFDR`, 'seasonSchedule');
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        console.log("Global FDR data fetched from Firestore:", docSnap.data());
                        return docSnap.data();
                    } else {
                        console.log("No global FDR data found in Firestore.");
                        return null;
                    }
                } catch (error) {
                    console.error("Error fetching global FDR data:", error);
                    showMessage(controlRoomMessageBox, `Error loading global FDR: ${error.message}`, 'error');
                    return null;
                }
            }

            /**
             * Saves the global FDR data to Firestore.
             * @param {Object} data - The global season schedule data to save.
             */
            async function saveGlobalFDRData(data) {
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const docRef = doc(db, `artifacts/${appId}/public/data/globalFDR`, 'seasonSchedule');
                    await setDoc(docRef, data);
                    console.log("Global FDR data saved to Firestore successfully.");
                    showMessage(adminMessage, "Global FDR data saved successfully!", "success");
                } catch (error) {
                    console.error("Error saving global FDR data:", error);
                    showMessage(adminMessage, `Error saving global FDR: ${error.message}`, 'error');
                }
            }

            /**
             * Renders the FDR schedule table.
             * @param {Object} scheduleData - The schedule data (globalSeasonSchedule).
             * @param {string} type - 'overall', 'homeAway', or 'customized'.
             * @param {number} roundsToShow - Number of rounds to display.
             */
            function renderScheduleTable(scheduleData, type, roundsToShow) {
                console.log(`DEBUG_RENDER: Rendering schedule table for type: ${type}, roundsToShow: ${roundsToShow}`);
                console.log('DEBUG_RENDER: Schedule Data:', scheduleData);

                if (!scheduleData || !scheduleData.fixtures || Object.keys(scheduleData.fixtures).length === 0) {
                    overallFDRDisplay.innerHTML = '<p>No schedule data available.</p>';
                    return;
                }

                const teams = Object.keys(scheduleData.fixtures).sort();
                const table = document.createElement('table');
                table.classList.add('schedule-table');

                // Create table header
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                const teamHeader = document.createElement('th');
                teamHeader.textContent = 'Team';
                headerRow.appendChild(teamHeader);

                for (let i = 1; i <= roundsToShow; i++) {
                    const roundHeader = document.createElement('th');
                    roundHeader.textContent = `R${i}`;
                    headerRow.appendChild(roundHeader);
                }
                thead.appendChild(headerRow);
                table.appendChild(thead);

                // Create table body
                const tbody = document.createElement('tbody');
                teams.forEach(teamId => {
                    const teamRow = document.createElement('tr');
                    const teamNameCell = document.createElement('td');
                    teamNameCell.textContent = teamNames[teamId] || `Team ${teamId}`; // Use full team name
                    teamRow.appendChild(teamNameCell);

                    for (let i = 1; i <= roundsToShow; i++) {
                        const roundKey = `R${i}`;
                        const fixtureCell = document.createElement('td');
                        fixtureCell.classList.add('fixture-cell');

                        // Get fixtures for the current team and round
                        const fixturesInRound = scheduleData.fixtures[teamId]?.[roundKey] || [];
                        console.log(`DEBUG_RENDER: Processing round ${roundKey} for team ${teamNames[teamId] || teamId}:`, fixturesInRound);

                        if (fixturesInRound.length > 0) {
                            fixturesInRound.forEach(fixtureString => {
                                // Example fixtureString: "OKH  (1)" or "NAS  (3)"
                                // We need to parse this to get opponent and FDR value
                                const match = fixtureString.match(/^(.*?)\s*(|)?\s*\((\d+)\)$/);
                                let opponentShortName = fixtureString;
                                let homeAway = '';
                                let fdrValue = '';

                                if (match) {
                                    opponentShortName = match[1].trim();
                                    homeAway = match[2] || '';
                                    fdrValue = match[3];
                                } else {
                                    // Fallback if regex doesn't match, try to extract just the opponent name
                                    const simpleMatch = fixtureString.match(/^(.*?)\s*(|)?/);
                                    if (simpleMatch) {
                                        opponentShortName = simpleMatch[1].trim();
                                        homeAway = simpleMatch[2] || '';
                                    }
                                    // If FDR is not found, it will remain empty.
                                }

                                const fixtureDisplayItem = document.createElement('div');
                                fixtureDisplayItem.classList.add('fixture-item-display');
                                // Add FDR class for styling, but no background color
                                if (fdrValue) {
                                    fixtureDisplayItem.classList.add(`fdr-${fdrValue}`);
                                }
                                
                                fixtureDisplayItem.textContent = `${opponentShortName} ${homeAway}`;
                                // If you want to show FDR value inside the cell, you can add it here:
                                // fixtureDisplayItem.textContent += ` (${fdrValue})`;

                                fixtureCell.appendChild(fixtureDisplayItem);
                            });
                        } else {
                            fixtureCell.textContent = '-'; // No fixture for this round
                        }
                        teamRow.appendChild(fixtureCell);
                    }
                    tbody.appendChild(teamRow);
                });
                table.appendChild(tbody);
                overallFDRDisplay.innerHTML = ''; // Clear previous content
                overallFDRDisplay.appendChild(table);
            }


            /**
             * Renders the home/away FDR list.
             * @param {Object} scheduleData - The schedule data (globalSeasonSchedule).
             */
            function renderHomeAwayFDR(scheduleData) {
                if (!scheduleData || !scheduleData.homeAwayFixtures || Object.keys(scheduleData.homeAwayFixtures).length === 0) {
                    homeAwayFDRDisplay.innerHTML = '<p>No Home/Away FDR data available.</p>';
                    return;
                }

                homeAwayFDRDisplay.innerHTML = ''; // Clear previous content
                const teams = Object.keys(scheduleData.homeAwayFixtures).sort();

                teams.forEach(teamId => {
                    const teamName = teamNames[teamId] || `Team ${teamId}`;
                    const teamHeader = document.createElement('div');
                    teamHeader.classList.add('fdr-section-title');
                    teamHeader.textContent = teamName;
                    homeAwayFDRDisplay.appendChild(teamHeader);

                    const teamFixturesContainer = document.createElement('div');
                    teamFixturesContainer.classList.add('fixtures-list-container');

                    const teamFixtures = scheduleData.homeAwayFixtures[teamId];
                    if (teamFixtures) {
                        Object.keys(teamFixtures).sort((a, b) => parseInt(a.replace('R', '')) - parseInt(b.replace('R', ''))).forEach(roundKey => {
                            teamFixtures[roundKey].forEach(fixture => {
                                const fixtureItem = document.createElement('div');
                                fixtureItem.classList.add('fixture-item');
                                fixtureItem.innerHTML = `<span>${roundKey}: ${fixture.opponent} ${fixture.homeAway}</span> <div class="fdr-value fdr-${fixture.fdr}">${fixture.fdr}</div>`;
                                teamFixturesContainer.appendChild(fixtureItem);
                            });
                        });
                    } else {
                        const noData = document.createElement('div');
                        noData.classList.add('fixture-item');
                        noData.textContent = 'No fixtures.';
                        teamFixturesContainer.appendChild(noData);
                    }
                    homeAwayFDRDisplay.appendChild(teamFixturesContainer);
                });
            }

            /**
             * Renders the customized FDR input fields.
             * @param {Object} scheduleData - The schedule data (globalSeasonSchedule).
             */
            function renderCustomizedFDRInputs(scheduleData) {
                if (!scheduleData || !scheduleData.overallFixtures || Object.keys(scheduleData.overallFixtures).length === 0) {
                    customizedFDRInputs.innerHTML = '<p>No base FDR data to customize. Please upload a global FDR first.</p>';
                    saveCustomFDRButton.style.display = 'none';
                    return;
                }

                customizedFDRInputs.innerHTML = ''; // Clear previous content
                saveCustomFDRButton.style.display = 'block'; // Show save button for custom FDR

                const teams = Object.keys(scheduleData.overallFixtures).sort();

                teams.forEach(teamId => {
                    const teamName = teamNames[teamId] || `Team ${teamId}`;
                    const teamHeader = document.createElement('div');
                    teamHeader.classList.add('fdr-section-title');
                    teamHeader.textContent = teamName;
                    customizedFDRInputs.appendChild(teamHeader);

                    const teamInputsContainer = document.createElement('div');
                    teamInputsContainer.classList.add('fixtures-list-container');

                    const teamFixtures = scheduleData.overallFixtures[teamId];
                    if (teamFixtures) {
                        Object.keys(teamFixtures).sort((a, b) => parseInt(a.replace('R', '')) - parseInt(b.replace('R', ''))).forEach(roundKey => {
                            teamFixtures[roundKey].forEach(fixture => {
                                const inputGroup = document.createElement('div');
                                inputGroup.classList.add('custom-fdr-input-group');
                                inputGroup.innerHTML = `
                                    <span>${roundKey}: ${fixture.opponent} ${fixture.homeAway}</span>
                                    <input type="number" min="1" max="7" value="${fixture.fdr}" 
                                        data-team-id="${teamId}" data-round-key="${roundKey}" 
                                        data-opponent="${fixture.opponent}" data-home-away="${fixture.homeAway}">
                                `;
                                teamInputsContainer.appendChild(inputGroup);
                            });
                        });
                    } else {
                        const noData = document.createElement('div');
                        noData.classList.add('fixture-item');
                        noData.textContent = 'No fixtures.';
                        teamInputsContainer.appendChild(noData);
                    }
                    customizedFDRInputs.appendChild(teamInputsContainer);
                });
            }


            /**
             * Handles the FDR system radio button change.
             */
            function handleFDRSystemChange() {
                currentFDRType = document.querySelector('input[name="fdrSystem"]:checked').value;
                console.log("FDR System changed to:", currentFDRType);
                
                overallFDRDisplay.style.display = 'none';
                homeAwayFDRDisplay.style.display = 'none';
                customizedFDRInputs.style.display = 'none';
                saveCustomFDRButton.style.display = 'none';
                uploadFDRLabel.style.display = 'none';
                processGlobalFDRButton.style.display = 'none'; // Hide process button for user FDR

                if (globalSeasonSchedule) {
                    if (currentFDRType === 'overall') {
                        overallFDRDisplay.style.display = 'block';
                        renderScheduleTable(globalSeasonSchedule, 'overall', parseInt(roundsToShowSlider.value));
                    } else if (currentFDRType === 'homeAway') {
                        homeAwayFDRDisplay.style.display = 'block';
                        renderHomeAwayFDR(globalSeasonSchedule);
                    } else if (currentFDRType === 'customized') {
                        customizedFDRInputs.style.display = 'block';
                        saveCustomFDRButton.style.display = 'block';
                        uploadFDRLabel.style.display = 'inline-block'; // Show upload for customized
                        renderCustomizedFDRInputs(globalSeasonSchedule);
                    }
                } else {
                    showMessage(controlRoomMessageBox, "Please upload or fetch global FDR data first.", "info");
                }
            }

            /**
             * Processes the uploaded Excel file for Global FDR.
             * @param {File} file - The Excel file.
             */
            async function processUploadedGlobalFDR(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                            console.log("Uploaded Excel JSON:", json);

                            if (json.length < 2) {
                                throw new Error("Excel file is empty or has insufficient rows.");
                            }

                            // Assuming the first row is headers: Team, R1, R2, ...
                            const headers = json[0];
                            const teamColumnIndex = headers.indexOf('Team');
                            if (teamColumnIndex === -1) {
                                throw new Error("Excel file must contain a 'Team' column.");
                            }

                            const newGlobalSeasonSchedule = {
                                fixtures: {},
                                homeAwayFixtures: {},
                                overallFixtures: {} // For customized FDR base
                            };
                            const newTeamNames = {}; // To store team ID to short name mapping

                            for (let i = 1; i < json.length; i++) {
                                const row = json[i];
                                const teamShortName = row[teamColumnIndex];
                                if (!teamShortName) continue; // Skip empty rows

                                // Generate a simple team ID (e.g., first 3 letters uppercase)
                                const teamId = teamShortName.substring(0, 3).toUpperCase();
                                newTeamNames[teamId] = teamShortName;

                                newGlobalSeasonSchedule.fixtures[teamId] = {};
                                newGlobalSeasonSchedule.homeAwayFixtures[teamId] = {};
                                newGlobalSeasonSchedule.overallFixtures[teamId] = {};

                                for (let j = 1; j < headers.length; j++) {
                                    const roundKey = headers[j]; // e.g., "R1", "R2"
                                    const fixtureData = row[j]; // e.g., "OKH  (1)"

                                    if (fixtureData) {
                                        // For the main 'fixtures' table (Overall FDR)
                                        if (!newGlobalSeasonSchedule.fixtures[teamId][roundKey]) {
                                            newGlobalSeasonSchedule.fixtures[teamId][roundKey] = [];
                                        }
                                        newGlobalSeasonSchedule.fixtures[teamId][roundKey].push(fixtureData);

                                        // For Home/Away and Customized FDR, we need to parse more
                                        const match = fixtureData.match(/^(.*?)\s*(|)?\s*\((\d+)\)$/);
                                        if (match) {
                                            const opponent = match[1].trim();
                                            const homeAway = match[2] === '' ? 'Home' : (match[2] === '' ? 'Away' : '');
                                            const fdr = parseInt(match[3]);

                                            if (!newGlobalSeasonSchedule.homeAwayFixtures[teamId][roundKey]) {
                                                newGlobalSeasonSchedule.homeAwayFixtures[teamId][roundKey] = [];
                                            }
                                            newGlobalSeasonSchedule.homeAwayFixtures[teamId][roundKey].push({ opponent, homeAway, fdr });

                                            if (!newGlobalSeasonSchedule.overallFixtures[teamId][roundKey]) {
                                                newGlobalSeasonSchedule.overallFixtures[teamId][roundKey] = [];
                                            }
                                            newGlobalSeasonSchedule.overallFixtures[teamId][roundKey].push({ opponent, homeAway, fdr });

                                        } else {
                                            console.warn(`Could not parse fixture data: ${fixtureData} for team ${teamShortName}, round ${roundKey}`);
                                            // Add a fallback for unparseable data to avoid breaking
                                            if (!newGlobalSeasonSchedule.homeAwayFixtures[teamId][roundKey]) {
                                                newGlobalSeasonSchedule.homeAwayFixtures[teamId][roundKey] = [];
                                            }
                                            newGlobalSeasonSchedule.homeAwayFixtures[teamId][roundKey].push({ opponent: fixtureData, homeAway: '', fdr: 0 }); // Default FDR 0

                                            if (!newGlobalSeasonSchedule.overallFixtures[teamId][roundKey]) {
                                                newGlobalSeasonSchedule.overallFixtures[teamId][roundKey] = [];
                                            }
                                            newGlobalSeasonSchedule.overallFixtures[teamId][roundKey].push({ opponent: fixtureData, homeAway: '', fdr: 0 }); // Default FDR 0
                                        }
                                    }
                                }
                            }
                            resolve({ schedule: newGlobalSeasonSchedule, names: newTeamNames });
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = (error) => reject(error);
                    reader.readAsArrayBuffer(file);
                });
            }

            // --- Event Listeners ---

            // Authentication listeners
            showSignup.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                authMessageBox.style.display = 'none';
            });

            showLogin.addEventListener('click', (e) => {
                e.preventDefault();
                signupForm.style.display = 'none';
                loginForm.style.display = 'block';
                authMessageBox.style.display = 'none';
            });

            loginButton.addEventListener('click', async () => {
                const email = loginEmail.value;
                const password = loginPassword.value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage(authMessageBox, "Logged in successfully!", "success");
                    // onAuthStateChanged will handle UI update
                } catch (error) {
                    console.error("Login error:", error);
                    showMessage(authMessageBox, `Login failed: ${error.message}`, "error");
                }
            });

            signupButton.addEventListener('click', async () => {
                const teamName = signupTeamName.value;
                const email = signupEmail.value;
                const password = signupPassword.value;

                if (!teamName || !email || !password) {
                    showMessage(authMessageBox, "Please fill in all fields.", "warning");
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    await setDoc(doc(db, "users", user.uid), {
                        teamName: teamName,
                        email: email,
                        role: "user", // Default role
                        managerId: null // Manager ID will be set later
                    });
                    showMessage(authMessageBox, "Account created successfully! You can now log in.", "success");
                    signupForm.style.display = 'none';
                    loginForm.style.display = 'block';
                } catch (error) {
                    console.error("Signup error:", error);
                    showMessage(authMessageBox, `Signup failed: ${error.message}`, "error");
                }
            });

            logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    showMessage(authMessageBox, "Logged out successfully!", "success");
                    currentUserId = null;
                    currentTeamName = null;
                    currentManagerId = null;
                    globalSeasonSchedule = null;
                    teamNames = {};
                    // onAuthStateChanged will handle UI update
                } catch (error) {
                    console.error("Logout error:", error);
                    showMessage(authMessageBox, `Logout failed: ${error.message}`, "error");
                }
            });

            // Auth state change listener
            onAuthStateChanged(auth, async (user) => {
                isAuthReady = true; // Auth state has been checked
                if (user) {
                    currentUserId = user.uid;
                    console.log("User logged in:", user.uid);

                    // Fetch user data from Firestore
                    const userDocRef = doc(db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);

                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        currentTeamName = userData.teamName;
                        currentManagerId = userData.managerId;
                        sidebarTeamName.textContent = currentTeamName;
                        sidebarManagerIdText.textContent = currentManagerId ? `ID: ${currentManagerId}` : 'ID: Not set';
                        
                        // Show menu toggle on mobile
                        if (window.innerWidth <= 768) {
                            menuToggle.style.display = 'block';
                        }
                        
                        // Check user role and show appropriate menu items
                        if (userData.role === 'admin') {
                            menuAdminDashboard.style.display = 'block';
                        } else {
                            menuAdminDashboard.style.display = 'none';
                        }

                        // Try to fetch global FDR data on login
                        globalSeasonSchedule = await fetchGlobalFDRData();
                        if (globalSeasonSchedule && globalSeasonSchedule.teamNames) {
                            teamNames = globalSeasonSchedule.teamNames;
                        } else {
                            console.warn("No global FDR or team names found on login.");
                        }

                        // If manager ID is set, pre-fill and show control room, otherwise show initial dashboard
                        if (currentManagerId) {
                            managerIdInput.value = currentManagerId;
                            showContentSection('controlRoom');
                            // Optionally, automatically fetch data if managerId exists
                            // fetchDataButton.click(); 
                        } else {
                            showContentSection('initialLoggedInDashboard');
                        }

                    } else {
                        // User document not found, something is wrong or new user created via console
                        console.warn("User document not found for UID:", user.uid);
                        showMessage(authMessageBox, "User profile not found. Please try logging in again or contact support.", "error");
                        await signOut(auth); // Force logout
                    }
                } else {
                    currentUserId = null;
                    currentTeamName = null;
                    currentManagerId = null;
                    sidebarTeamName.textContent = '';
                    sidebarManagerIdText.textContent = '';
                    menuAdminDashboard.style.display = 'none';
                    menuToggle.style.display = 'none'; // Hide menu toggle when logged out
                    showContentSection('auth');
                    console.log("User logged out.");
                }
            });

            // Initial anonymous sign-in or custom token sign-in
            window.addEventListener('load', async () => {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Firebase initial sign-in error:", error);
                    showMessage(authMessageBox, `Authentication failed: ${error.message}`, "error");
                }

                // Apply saved theme preference
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    themeSwitch.checked = true;
                    document.body.classList.add('dark-mode');
                } else {
                    themeSwitch.checked = false;
                    document.body.classList.remove('dark-mode');
                }
                updateLogo(); // Set initial logo based on theme
            });


            // Menu toggle listeners
            menuToggle.addEventListener('click', () => {
                sidebarMenu.classList.add('open');
                overlay.style.display = 'block';
            });

            overlay.addEventListener('click', () => {
                sidebarMenu.classList.remove('open');
                overlay.style.display = 'none';
            });

            // Menu Item Click Listeners
            menuMyControlRoom.addEventListener('click', (e) => {
                e.preventDefault();
                showContentSection('controlRoom');
                sidebarMenu.classList.remove('open');
                overlay.style.display = 'none';
            });

            menuAdminDashboard.addEventListener('click', (e) => {
                e.preventDefault();
                showContentSection('adminDashboard');
                sidebarMenu.classList.remove('open');
                overlay.style.display = 'none';
            });

            // Theme switch listener
            themeSwitch.addEventListener('change', toggleTheme);

            // Fetch Data Button (My Control Room)
            fetchDataButton.addEventListener('click', async () => {
                const managerId = managerIdInput.value;
                if (!managerId) {
                    showMessage(controlRoomMessageBox, "Please enter a Manager ID.", "warning");
                    return;
                }

                showMessage(controlRoomMessageBox, "Fetching data, please wait...", "info", 0); // Indefinite message
                managerStatsDiv.style.display = 'none'; // Hide previous stats
                screenshotPreview.style.display = 'none'; // Hide screenshot
                gifPreview.style.display = 'none'; // Hide GIF

                try {
                    const data = await fetchManagerData(managerId);
                    console.log("Fetched Manager Data:", data);

                    // Update UI with fetched data
                    displayManagerName.textContent = data.managerName || 'N/A';
                    overallRankSpan.textContent = data.overallRank || 'N/A';
                    totalPointsSpan.textContent = data.totalPoints || 'N/A';
                    gameweekPointsSpan.textContent = data.gameweekPoints || 'N/A';
                    gameweekRankSpan.textContent = data.gameweekRank || 'N/A';
                    averagePointsFor1stPlaceSpan.textContent = data.averagePointsFor1stPlace ? data.averagePointsFor1stPlace.toFixed(2) : 'N/A';
                    bestRoundSpan.textContent = data.bestRound || 'N/A';
                    worstRoundSpan.textContent = data.worstRound || 'N/A';
                    greenArrowsCountSpan.textContent = data.greenArrowsCount || 0;
                    redArrowsCountSpan.textContent = data.redArrowsCount || 0;
                    totalTransfersCountSpan.textContent = data.totalTransfersCount || 0;
                    totalHitsPointsSpan.textContent = data.totalHitsPoints || 0;

                    // Render lists
                    const renderList = (ulElement, items, propertyName) => {
                        ulElement.innerHTML = '';
                        if (items && items.length > 0) {
                            items.forEach(item => {
                                const li = document.createElement('li');
                                li.textContent = item[propertyName] || 'N/A';
                                ulElement.appendChild(li);
                            });
                        } else {
                            const li = document.createElement('li');
                            li.textContent = 'No data available.';
                            ulElement.appendChild(li);
                        }
                    };

                    renderList(top3CaptainsList, data.top3Captains, 'name');
                    renderList(bestPlayersList, data.bestPlayers, 'name');
                    renderList(worstPlayersList, data.worstPlayers, 'name');
                    renderList(top5MissedPointsList, data.top5MissedPoints, 'name');
                    renderList(top5ProfitableTransfersList, data.top5ProfitableTransfers, 'description');
                    renderList(top5LossMakingTransfersList, data.top5LossMakingTransfers, 'description');

                    managerStatsDiv.style.display = 'block';
                    showMessage(controlRoomMessageBox, "Data fetched successfully!", "success");

                    // Save manager ID to user's Firestore document
                    if (currentUserId) {
                        const userDocRef = doc(db, "users", currentUserId);
                        await updateDoc(userDocRef, { managerId: managerId });
                        currentManagerId = managerId; // Update global variable
                        sidebarManagerIdText.textContent = `ID: ${currentManagerId}`;
                        console.log("Manager ID saved to Firestore.");
                    }

                    // Re-render FDR schedule if available
                    if (globalSeasonSchedule) {
                        handleFDRSystemChange(); // Re-render based on current type
                    } else {
                        // Fetch global FDR data if not already loaded
                        globalSeasonSchedule = await fetchGlobalFDRData();
                        if (globalSeasonSchedule) {
                            teamNames = globalSeasonSchedule.teamNames;
                            handleFDRSystemChange();
                        }
                    }

                } catch (error) {
                    console.error("Error fetching manager data:", error);
                    showMessage(controlRoomMessageBox, `Error fetching data: ${error.message}. Please ensure the Manager ID is correct and try again.`, "error");
                    managerStatsDiv.style.display = 'none';
                }
            });

            // Screenshot and GIF generation
            screenshotButton.addEventListener('click', async () => {
                screenshotPreview.style.display = 'none';
                screenshotMessage.style.display = 'none';
                showMessage(screenshotMessage, "Generating screenshot...", "info", 0);

                try {
                    const canvas = await html2canvas(managerStatsDiv);
                    screenshotPreview.src = canvas.toDataURL('image/png');
                    screenshotPreview.style.display = 'block';
                    showMessage(screenshotMessage, "Screenshot generated successfully!", "success");
                } catch (error) {
                    console.error("Error generating screenshot:", error);
                    showMessage(screenshotMessage, `Failed to generate screenshot: ${error.message}`, "error");
                }
            });

            gifButton.addEventListener('click', async () => {
                gifPreview.style.display = 'none';
                gifMessage.style.display = 'none';
                showMessage(gifMessage, "Generating GIF (this may take a moment)...", "info", 0);

                try {
                    // Fetch data for the last 5 gameweeks
                    const currentGameweek = parseInt(gameweekPointsSpan.textContent); // Assuming this is current GW
                    if (isNaN(currentGameweek) || currentGameweek < 5) {
                        showMessage(gifMessage, "Not enough gameweek data to generate GIF (need at least 5 GWs).", "warning");
                        return;
                    }

                    const gif = new GIF({
                        workers: 2,
                        quality: 10,
                        width: managerStatsDiv.offsetWidth,
                        height: managerStatsDiv.offsetHeight,
                        workerScript: 'https://unpkg.com/gif.js@0.2.0/dist/gif.worker.js'
                    });

                    for (let i = 4; i >= 0; i--) { // Last 5 gameweeks
                        const gw = currentGameweek - i;
                        if (gw <= 0) continue; // Ensure gameweek is valid

                        showMessage(gifMessage, `Fetching data for GW ${gw}...`, "info", 0);
                        const gwData = await fetchManagerData(managerIdInput.value); // Re-fetch for specific GW if API supported, or simulate change
                        // For a real GIF, you'd need an API that lets you fetch past GW data.
                        // For this example, we'll just use the current data for all frames,
                        // or you can modify the UI to show changing data if you have it.
                        
                        // Temporarily update UI for screenshot
                        overallRankSpan.textContent = gwData.overallRank - (i * 100); // Simulate rank change
                        gameweekPointsSpan.textContent = gwData.gameweekPoints + (i * 5); // Simulate points change
                        
                        const canvas = await html2canvas(managerStatsDiv);
                        gif.addFrame(canvas.getContext('2d'), { delay: 1000 }); // 1 second per frame
                    }

                    gif.on('finished', function(blob) {
                        gifPreview.src = URL.createObjectURL(blob);
                        gifPreview.style.display = 'block';
                        showMessage(gifMessage, "GIF generated successfully!", "success");
                        // Reset UI after GIF generation
                        fetchDataButton.click(); 
                    });

                    gif.render();

                } catch (error) {
                    console.error("Error generating GIF:", error);
                    showMessage(gifMessage, `Failed to generate GIF: ${error.message}`, "error");
                }
            });

            // FDR System Radio Button Listeners
            radioOverallFDR.addEventListener('change', handleFDRSystemChange);
            radioHomeAwayFDR.addEventListener('change', handleFDRSystemChange);
            radioCustomizedFDR.addEventListener('change', handleFDRSystemChange);

            // Rounds to Show Slider Listener
            roundsToShowSlider.addEventListener('input', () => {
                roundsToShowValueSpan.textContent = roundsToShowSlider.value;
                if (globalSeasonSchedule && currentFDRType === 'overall') {
                    renderScheduleTable(globalSeasonSchedule, 'overall', parseInt(roundsToShowSlider.value));
                }
            });

            // Save Custom FDR Button
            saveCustomFDRButton.addEventListener('click', async () => {
                if (!currentUserId) {
                    showMessage(controlRoomMessageBox, "Please log in to save your custom FDR.", "warning");
                    return;
                }

                showMessage(controlRoomMessageBox, "Saving custom FDR...", "info", 0);

                const customFixtures = {};
                const inputElements = customizedFDRInputs.querySelectorAll('input[type="number"]');
                inputElements.forEach(input => {
                    const teamId = input.dataset.teamId;
                    const roundKey = input.dataset.roundKey;
                    const opponent = input.dataset.opponent;
                    const homeAway = input.dataset.homeAway;
                    const fdr = parseInt(input.value);

                    if (!customFixtures[teamId]) {
                        customFixtures[teamId] = {};
                    }
                    if (!customFixtures[teamId][roundKey]) {
                        customFixtures[teamId][roundKey] = [];
                    }
                    customFixtures[teamId][roundKey].push({ opponent, homeAway, fdr });
                });

                try {
                    const userDocRef = doc(db, "users", currentUserId);
                    await updateDoc(userDocRef, {
                        customFDR: customFixtures
                    });
                    showMessage(controlRoomMessageBox, "Custom FDR saved successfully!", "success");
                } catch (error) {
                    console.error("Error saving custom FDR:", error);
                    showMessage(controlRoomMessageBox, `Error saving custom FDR: ${error.message}`, "error");
                }
            });

            // Upload FDR File (for customized FDR)
            uploadFDRFile.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (file) {
                    showMessage(controlRoomMessageBox, "Processing uploaded FDR file...", "info", 0);
                    try {
                        const { schedule, names } = await processUploadedGlobalFDR(file);
                        // Update global FDR and team names for immediate use
                        globalSeasonSchedule = schedule;
                        teamNames = names;
                        // Re-render customized inputs with new data
                        renderCustomizedFDRInputs(globalSeasonSchedule);
                        showMessage(controlRoomMessageBox, "FDR file processed. Customize and Save!", "success");
                    } catch (error) {
                        console.error("Error processing uploaded FDR file:", error);
                        showMessage(controlRoomMessageBox, `Error processing file: ${error.message}`, "error");
                    }
                }
            });

            // Admin Dashboard Listeners
            adminSearchUserButton.addEventListener('click', () => showAdminSection('searchUser'));
            adminUploadFDRButton.addEventListener('click', () => showAdminSection('uploadFDR'));

            adminSearchButton.addEventListener('click', async () => {
                const searchTerm = adminSearchInput.value.trim();
                if (!searchTerm) {
                    showMessage(adminMessage, "Please enter an email or manager ID to search.", "warning");
                    return;
                }
                adminSearchResults.innerHTML = '';
                adminEditUserSection.style.display = 'none';
                showMessage(adminMessage, "Searching...", "info", 0);

                try {
                    let q;
                    // Check if search term is a number (potential manager ID)
                    if (!isNaN(searchTerm) && searchTerm !== '') {
                        q = query(collection(db, "users"), where("managerId", "==", parseInt(searchTerm)));
                    } else {
                        q = query(collection(db, "users"), where("email", "==", searchTerm));
                    }
                    
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) {
                        showMessage(adminMessage, "No user found with that email or manager ID.", "warning");
                        return;
                    }

                    querySnapshot.forEach(docSnap => {
                        const userData = docSnap.data();
                        const p = document.createElement('p');
                        p.innerHTML = `<strong>User Found:</strong> ${userData.teamName} (${userData.email}) - Role: ${userData.role}`;
                        adminSearchResults.appendChild(p);

                        adminEditUserId.textContent = docSnap.id;
                        adminEditCurrentRole.textContent = userData.role;
                        adminNewRole.value = userData.role; // Pre-select current role
                        adminEditUserSection.style.display = 'block';
                        showMessage(adminMessage, "User found.", "success");
                    });

                } catch (error) {
                    console.error("Admin search error:", error);
                    showMessage(adminMessage, `Search failed: ${error.message}`, "error");
                }
            });

            adminUpdateRoleButton.addEventListener('click', async () => {
                const userIdToUpdate = adminEditUserId.textContent;
                const newRole = adminNewRole.value;

                if (!userIdToUpdate || !newRole) {
                    showMessage(adminMessage, "Error: User ID or new role missing.", "error");
                    return;
                }

                // Prevent changing your own role to avoid locking yourself out
                if (userIdToUpdate === currentUserId) { // Removed the newRole !== 'admin' check to allow demoting yourself if needed
                    showMessage(adminMessage, "You are attempting to change your own role. Proceed with caution.", "warning");
                }

                showMessage(adminMessage, "Updating user role...", "info", 0);
                try {
                    const userDocRef = doc(db, "users", userIdToUpdate);
                    await updateDoc(userDocRef, { role: newRole });
                    showMessage(adminMessage, `User role updated to ${newRole} successfully!`, "success");
                    adminEditCurrentRole.textContent = newRole; // Update displayed role
                } catch (error) {
                    console.error("Admin update role error:", error);
                    showMessage(adminMessage, `Failed to update role: ${error.message}`, "error");
                }
            });

            adminDeleteUserButton.addEventListener('click', async () => {
                const userIdToDelete = adminEditUserId.textContent;
                if (!userIdToDelete) {
                    showMessage(adminMessage, "Error: User ID missing for deletion.", "error");
                    return;
                }

                // Prevent deleting your own account
                if (userIdToDelete === currentUserId) {
                    showMessage(adminMessage, "You cannot delete your own account.", "warning");
                    return;
                }

                // Use a custom modal for confirmation instead of alert/confirm
                const confirmDelete = window.confirm("Are you sure you want to delete this user? This action cannot be undone.");
                if (!confirmDelete) {
                    showMessage(adminMessage, "User deletion cancelled.", "info");
                    return;
                }

                showMessage(adminMessage, "Deleting user...", "info", 0);
                try {
                    await deleteDoc(doc(db, "users", userIdToDelete));
                    showMessage(adminMessage, "User deleted successfully!", "success");
                    adminSearchResults.innerHTML = '';
                    adminEditUserSection.style.display = 'none';
                    adminSearchInput.value = ''; // Clear search input
                }
                catch (error) {
                    console.error("Admin delete user error:", error);
                    showMessage(adminMessage, `Failed to delete user: ${error.message}`, "error");
                }
            });

            // Global FDR Upload (Admin Dashboard)
            globalFDRFileUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    showMessage(adminMessage, `File selected: ${file.name}. Click 'Process and Save Global FDR' to proceed.`, "info");
                    processGlobalFDRButton.style.display = 'block';
                } else {
                    processGlobalFDRButton.style.display = 'none';
                    adminMessage.style.display = 'none';
                }
            });

            processGlobalFDRButton.addEventListener('click', async () => {
                const file = globalFDRFileUpload.files[0];
                if (!file) {
                    showMessage(adminMessage, "Please select an Excel file first.", "warning");
                    return;
                }

                showMessage(adminMessage, "Processing and saving global FDR data...", "info", 0);
                try {
                    const { schedule, names } = await processUploadedGlobalFDR(file);
                    await saveGlobalFDRData({ ...schedule, teamNames: names }); // Save both schedule and team names
                    globalSeasonSchedule = schedule; // Update global variable
                    teamNames = names; // Update global variable
                    showMessage(adminMessage, "Global FDR data uploaded and saved successfully!", "success");
                    globalFDRFileUpload.value = ''; // Clear file input
                    processGlobalFDRButton.style.display = 'none';
                } catch (error) {
                    console.error("Error processing/saving global FDR:", error);
                    showMessage(adminMessage, `Error: ${error.message}`, "error");
                }
            });

            // Initialize tuning slider value display
            if (roundsToShowSlider && roundsToShowValueSpan) {
                roundsToShowValueSpan.textContent = roundsToShowSlider.value;
            }
        </script>
    </body>
    </html>
