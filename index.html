<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Control Room V2</title>
    <!-- Firebase SDK - Core -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <!-- Firebase SDK - Auth -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
    <!-- Firebase SDK - Firestore -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2canvas library for capturing screenshots -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> 
    <!-- NEW: gif.js library for GIF encoding -->
    <script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>
    
    <!-- NEW: XLSX.js library for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Oswald:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Styles */
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background-color: #004d40; /* Dark Teal */
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        header .logo {
            font-family: 'Oswald', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: #e0f2f1; /* Light Teal */
            display: flex;
            align-items: center;
        }

        header .logo img {
            height: 40px;
            margin-right: 10px;
            border-radius: 5px;
        }

        /* Hamburger Menu */
        .hamburger {
            display: none; /* Hidden by default, shown on mobile */
            flex-direction: column;
            cursor: pointer;
            padding: 5px;
        }

        .hamburger .bar {
            width: 25px;
            height: 3px;
            background-color: white;
            margin: 4px 0;
            transition: 0.4s;
        }

        /* Sidebar Menu */
        .sidebar-menu {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1001;
            top: 0;
            left: 0;
            background-color: #004d40; /* Dark Teal */
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
        }

        .sidebar-menu.open {
            width: 250px;
        }

        .sidebar-menu a {
            padding: 15px 25px;
            text-decoration: none;
            font-size: 20px;
            color: #e0f2f1;
            display: block;
            transition: 0.3s;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-menu a:hover {
            background-color: #00796b; /* Medium Teal */
            color: white;
        }

        .sidebar-menu .close-btn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
            color: white;
        }

        /* Overlay for mobile menu */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }

        /* Main Content Sections */
        .content-section {
            display: none; /* All content sections are hidden by default */
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .content-section h2 {
            color: #004d40;
            font-family: 'Oswald', sans-serif;
            font-size: 24px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0f2f1;
            padding-bottom: 10px;
        }

        /* Form Styling */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 700;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* Ensures padding doesn't increase width */
        }

        .btn {
            background-color: #00796b; /* Medium Teal */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background-color: #004d40; /* Dark Teal */
        }

        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Specific Content Styling */
        #analyzerReportContent {
            text-align: center;
        }

        #analyzerReportContent .chart-container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        #managerStatsDiv {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            text-align: left;
        }

        #managerStatsDiv div {
            background-color: #e0f2f1; /* Light Teal */
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        #managerStatsDiv h4 {
            color: #004d40;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 18px;
        }

        #managerStatsDiv p {
            margin: 5px 0;
            font-size: 14px;
        }

        .stat-value {
            font-weight: bold;
            color: #00796b;
        }

        .message-box {
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }

        .message-box.info {
            background-color: #e3f2fd; /* Light Blue */
            color: #2196f3; /* Blue */
        }

        .message-box.success {
            background-color: #e8f5e9; /* Light Green */
            color: #4caf50; /* Green */
        }

        .message-box.error {
            background-color: #ffebee; /* Light Red */
            color: #f44336; /* Red */
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00796b;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Admin Dashboard */
        #adminDashboardContent .admin-button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        #adminDashboardContent .admin-button {
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        #adminDashboardContent .admin-button:hover {
            background-color: #45a049;
        }

        #adminDashboardContent .admin-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #adminDashboardContent .admin-input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #adminSearchResults ul {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #fdfdfd;
        }

        #adminSearchResults li {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #adminSearchResults li:last-child {
            border-bottom: none;
        }

        #adminSearchResults li:hover {
            background-color: #f0f0f0;
        }

        #adminSearchResults .manager-id {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #666;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header {
                padding: 10px 15px;
            }

            header .logo {
                font-size: 24px;
            }

            .hamburger {
                display: flex;
            }

            .main-nav {
                display: none; /* Hide desktop nav */
            }

            .sidebar-menu.open {
                width: 100%; /* Full width on small screens */
            }

            .content-section {
                padding: 15px;
            }

            #managerStatsDiv {
                grid-template-columns: 1fr; /* Stack on mobile */
            }
        }

        /* Dark Mode */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        body.dark-mode header {
            background-color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        body.dark-mode header .logo {
            color: #bb86fc; /* Purple accent */
        }

        body.dark-mode .sidebar-menu {
            background-color: #333;
            box-shadow: 2px 0 5px rgba(0,0,0,0.4);
        }

        body.dark-mode .sidebar-menu a {
            color: #e0e0e0;
            border-bottom-color: rgba(255,255,255,0.05);
        }

        body.dark-mode .sidebar-menu a:hover {
            background-color: #444;
            color: #bb86fc;
        }

        body.dark-mode .content-section {
            background-color: #2a2a2a;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        body.dark-mode .content-section h2 {
            color: #bb86fc;
            border-bottom-color: #444;
        }

        body.dark-mode .form-group label {
            color: #c0c0c0;
        }

        body.dark-mode .form-group input[type="text"],
        body.dark-mode .form-group input[type="number"],
        body.dark-mode .form-group input[type="email"],
        body.dark-mode .form-group input[type="password"],
        body.dark-mode .form-group select {
            background-color: #3a3a3a;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark-mode .btn {
            background-color: #6200ee; /* Purple */
        }

        body.dark-mode .btn:hover {
            background-color: #3700b3; /* Darker Purple */
        }

        body.dark-mode #managerStatsDiv div {
            background-color: #3a3a3a;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        body.dark-mode #managerStatsDiv h4 {
            color: #bb86fc;
        }

        body.dark-mode .stat-value {
            color: #03dac6; /* Cyan accent */
        }

        body.dark-mode .message-box.info {
            background-color: #212121;
            color: #90caf9;
            border: 1px solid #1e88e5;
        }

        body.dark-mode .message-box.success {
            background-color: #212121;
            color: #a5d6a7;
            border: 1px solid #66bb6a;
        }

        body.dark-mode .message-box.error {
            background-color: #212121;
            color: #ef9a9a;
            border: 1px solid #e57373;
        }

        body.dark-mode .loading-spinner {
            border-top-color: #bb86fc;
        }

        body.dark-mode #adminDashboardContent .admin-button {
            background-color: #03dac6; /* Cyan */
            color: #1a1a1a;
        }

        body.dark-mode #adminDashboardContent .admin-button:hover {
            background-color: #00bfa5;
        }

        body.dark-mode #adminSearchResults ul {
            background-color: #2a2a2a;
            border-color: #444;
        }

        body.dark-mode #adminSearchResults li {
            border-bottom-color: #444;
        }

        body.dark-mode #adminSearchResults li:hover {
            background-color: #3a3a3a;
        }

        body.dark-mode #adminSearchResults .manager-id {
            color: #aaa;
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    <header>
        <div class="logo">
            <img src="dark mode logo.png" alt="Logo">
            Control Room V2
        </div>
        <div class="hamburger" id="hamburger">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
        <nav class="main-nav" id="mainNav">
            <!-- Desktop navigation links (hidden on mobile) -->
            <a href="#" id="menuAnalyzeMyTeam">Analyze My Team</a>
            <a href="#" id="menuMyControlRoom">My Control Room</a>
            <a href="#" id="menuAdminDashboard" style="display: none;">Admin Dashboard</a>
            <a href="#" id="menuDarkModeToggle">Dark Mode</a>
            <a href="#" id="menuLogout">Logout</a>
        </nav>
    </header>

    <div class="sidebar-menu" id="sidebarMenu">
        <a href="javascript:void(0)" class="close-btn" id="closeBtn">&times;</a>
        <a href="#" id="sidebarAnalyzeMyTeam">Analyze My Team</a>
        <a href="#" id="sidebarMyControlRoom">My Control Room</a>
        <a href="#" id="sidebarAdminDashboard" style="display: none;">Admin Dashboard</a>
        <a href="#" id="sidebarDarkModeToggle">Dark Mode</a>
        <a href="#" id="sidebarLogout">Logout</a>
    </div>

    <main class="container">
        <!-- Login/Signup Section -->
        <section id="authSection" class="content-section">
            <h2>Welcome to Control Room V2</h2>
            <p>Please log in or sign up to continue.</p>
            <div class="form-group">
                <label for="authEmail">Email:</label>
                <input type="email" id="authEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label for="authPassword">Password:</label>
                <input type="password" id="authPassword" placeholder="Enter your password">
            </div>
            <button id="loginBtn" class="btn">Login</button>
            <button id="signupBtn" class="btn">Sign Up</button>
            <p id="authMessageBox" class="message-box" style="display: none;"></p>
        </section>

        <!-- Analyze My Team Section -->
        <section id="analyzerReport" class="content-section">
            <h2>Analyze My Team</h2>
            <div class="form-group">
                <label for="managerIdInput">Enter Manager ID:</label>
                <input type="number" id="managerIdInput" placeholder="e.g., 123456">
            </div>
            <button id="fetchReportBtn" class="btn">Fetch Report</button>
            <p id="loadingMessage" class="message-box info" style="display: none;">Loading...</p>
            <p id="errorMessage" class="message-box error" style="display: none;"></p>

            <div id="managerStatsDiv" style="display: none;">
                <!-- Manager stats will be dynamically inserted here -->
            </div>

            <div class="chart-container" id="rankJourneyChartContainer" style="display: none;">
                <h3>Rank Journey</h3>
                <canvas id="rankJourneyChart"></canvas>
            </div>

            <div class="chart-container" id="pointsChartContainer" style="display: none;">
                <h3>Points Analysis</h3>
                <canvas id="pointsChart"></canvas>
            </div>

            <div class="chart-container" id="captaincyChartContainer" style="display: none;">
                <h3>Captaincy Analysis</h3>
                <canvas id="captaincyChart"></canvas>
            </div>

            <div class="chart-container" id="transferChartContainer" style="display: none;">
                <h3>Transfer Impact</h3>
                <canvas id="transferChart"></canvas>
            </div>

            <div class="chart-container" id="arrowChartContainer" style="display: none;">
                <h3>Arrow Trends</h3>
                <canvas id="arrowChart"></canvas>
            </div>

            <button id="shareVideoButton" class="btn" style="display: none;">Generate Shareable Video</button>
            <p id="videoGeneratingMessage" class="message-box info" style="display: none;">Generating video...</p>
        </section>

        <!-- My Control Room Section -->
        <section id="controlRoom" class="content-section">
            <h2>My Control Room</h2>
            <p>Content for My Control Room will go here.</p>
        </section>

        <!-- Admin Dashboard Section -->
        <section id="adminDashboard" class="content-section">
            <h2>Admin Dashboard</h2>
            <div class="admin-button-group" id="adminDashboardNavButtons">
                <button id="adminSearchButton" class="admin-button">Search Manager</button>
                <button id="adminDataButton" class="admin-button">Data</button>
                <button id="adminUsersButton" class="admin-button">Users</button>
            </div>

            <!-- Admin Search Section (initially hidden) -->
            <div id="adminSearchSection" style="display: none;">
                <h3>Search Manager by ID</h3>
                <div class="form-group">
                    <label for="adminManagerIdInput">Manager ID:</label>
                    <input type="number" id="adminManagerIdInput" class="admin-input" placeholder="Enter manager ID">
                </div>
                <button id="adminFetchManagerBtn" class="admin-button">Fetch Manager Details</button>
                <p id="adminMessage" class="message-box" style="display: none;"></p>
                <div id="adminSearchResults" style="display: none;">
                    <h4>Manager Details:</h4>
                    <ul id="managerDetailsList">
                        <!-- Manager details will be displayed here -->
                    </ul>
                    <button id="adminDeleteManagerBtn" class="admin-button delete-btn">Delete Manager</button>
                </div>
            </div>

            <!-- Data Upload Section (initially hidden) -->
            <div id="dataUploadSection" style="display: none;" class="p-4 bg-white rounded-lg shadow-md">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Upload League Table (Excel)</h3>
                <p class="text-sm text-gray-600 mb-4">
                    Upload an Excel file with columns: "Rank", "Team" (or "Team Name"), "FDR Home", and "FDR Away". FDRs should be numbers between 1-7.
                </p>
                <div class="mb-3">
                    <label for="rankingTypeSelect" class="block text-gray-700 text-sm font-bold mb-2">
                        Select Ranking Type for Upload:
                    </label>
                    <select
                        id="rankingTypeSelect"
                        class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline admin-input"
                    >
                        <option value="overall">Overall Ranking</option>
                        <option value="home">Home Ranking</option>
                        <option value="away">Away Ranking</option>
                    </select>
                </div>
                <label class="block text-white font-bold py-2 px-4 rounded-lg cursor-pointer text-center transition duration-300 transform hover:scale-105 bg-purple-600 hover:bg-purple-700">
                    Upload Excel File
                    <input
                        type="file"
                        accept=".xlsx, .xls"
                        id="excelFileUploadInput"
                        class="hidden"
                    />
                </label>
                <p id="excelUploadMessage" class="mt-2 text-sm text-center message-box" style="display: none;"></p>

                <!-- Display Current Rankings -->
                <div id="currentRankingsDisplay" class="mt-8">
                    <h4 class="text-lg font-semibold text-gray-700 mb-3 text-center">Current Rankings Data</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-100 p-3 rounded-md">
                            <h5 class="font-medium text-gray-800 mb-2">Overall</h5>
                            <ul id="overallRankingsList" class="list-none p-0 max-h-40 overflow-y-auto text-sm"></ul>
                        </div>
                        <div class="bg-gray-100 p-3 rounded-md">
                            <h5 class="font-medium text-gray-800 mb-2">Home</h5>
                            <ul id="homeRankingsList" class="list-none p-0 max-h-40 overflow-y-auto text-sm"></ul>
                        </div>
                        <div class="bg-gray-100 p-3 rounded-md">
                            <h5 class="font-medium text-gray-800 mb-2">Away</h5>
                            <ul id="awayRankingsList" class="list-none p-0 max-h-40 overflow-y-auto text-sm"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Users Section -->
            <div id="adminUsersSection" style="display: none;">
                <h3>Manage Users</h3>
                <p>User management features will be added here.</p>
            </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Configuration ---
        // The API key is injected by Netlify's build script (inject-firebase-api-key.js)
        const firebaseConfig = {
            apiKey: "___FIREBASE_API_KEY_PLACEHOLDER___", 
            authDomain: "splcontrolroom-c02c0.firebaseapp.com",
            projectId: "splcontrolroom-c02c0",
            storageBucket: "splcontrolroom-c02c0.firebasestorage.app",
            messagingSenderId: "272416971084",
            appId: "1:272416971084:web:57517048926e49720197e9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Element References ---
        const authSection = document.getElementById('authSection');
        const authEmailInput = document.getElementById('authEmail');
        const authPasswordInput = document.getElementById('authPassword');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const authMessageBox = document.getElementById('authMessageBox');
        const menuLogout = document.getElementById('menuLogout');
        const sidebarLogout = document.getElementById('sidebarLogout');

        const analyzerReportContent = document.getElementById('analyzerReport');
        const managerIdInput = document.getElementById('managerIdInput');
        const fetchReportBtn = document.getElementById('fetchReportBtn');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const managerStatsDiv = document.getElementById('managerStatsDiv');
        const shareVideoButton = document.getElementById('shareVideoButton');
        const videoGeneratingMessage = document.getElementById('videoGeneratingMessage');

        const controlRoomContent = document.getElementById('controlRoom');

        const adminDashboardContent = document.getElementById('adminDashboard');
        const menuAdminDashboard = document.getElementById('menuAdminDashboard');
        const sidebarAdminDashboard = document.getElementById('sidebarAdminDashboard');
        const adminDashboardNavButtons = document.getElementById('adminDashboardNavButtons');
        const adminSearchButton = document.getElementById('adminSearchButton');
        const adminDataButton = document.getElementById('adminDataButton');
        const adminUsersButton = document.getElementById('adminUsersButton');
        const adminSearchSection = document.getElementById('adminSearchSection');
        const adminManagerIdInput = document.getElementById('adminManagerIdInput');
        const adminFetchManagerBtn = document.getElementById('adminFetchManagerBtn');
        const adminMessage = document.getElementById('adminMessage');
        const adminSearchResults = document.getElementById('adminSearchResults');
        const managerDetailsList = document.getElementById('managerDetailsList');
        const adminDeleteManagerBtn = document.getElementById('adminDeleteManagerBtn');
        const adminUsersSection = document.getElementById('adminUsersSection');

        // Chart.js instances
        let rankJourneyChartInstance = null;
        let pointsChartInstance = null;
        let captaincyChartInstance = null;
        let transferChartInstance = null;
        let arrowChartInstance = null;

        // Menu elements
        const hamburger = document.getElementById('hamburger');
        const sidebarMenu = document.getElementById('sidebarMenu');
        const closeBtn = document.getElementById('closeBtn');
        const overlay = document.getElementById('overlay');
        const menuAnalyzeMyTeam = document.getElementById('menuAnalyzeMyTeam');
        const sidebarAnalyzeMyTeam = document.getElementById('sidebarAnalyzeMyTeam');
        const menuMyControlRoom = document.getElementById('menuMyControlRoom');
        const sidebarMyControlRoom = document.getElementById('sidebarMyControlRoom');
        const menuDarkModeToggle = document.getElementById('menuDarkModeToggle');
        const sidebarDarkModeToggle = document.getElementById('sidebarDarkModeToggle');

        // Data Upload Elements (NEW)
        const dataUploadSection = document.getElementById('dataUploadSection');
        const rankingTypeSelect = document.getElementById('rankingTypeSelect');
        const excelFileUploadInput = document.getElementById('excelFileUploadInput');
        const excelUploadMessage = document.getElementById('excelUploadMessage');
        const currentRankingsDisplay = document.getElementById('currentRankingsDisplay'); // NEW
        const overallRankingsList = document.getElementById('overallRankingsList'); // NEW
        const homeRankingsList = document.getElementById('homeRankingsList'); // NEW
        const awayRankingsList = document.getElementById('awayRankingsList'); // NEW

        // --- Global Variables ---
        let currentManagerId = null;
        let isAdmin = false;
        let isAnalyzerReportDataFetched = false; // Flag to prevent re-fetching on section switch

        // --- Utility Functions ---
        function showMessage(message, type = 'info', targetElement = authMessageBox) {
            targetElement.textContent = '';
            targetElement.className = `message-box ${type}`;
            targetElement.textContent = message;
            targetElement.style.display = 'block';
        }

        function showLoading(message = 'Loading...') {
            loadingMessage.textContent = message;
            loadingMessage.className = 'message-box info';
            loadingMessage.style.display = 'block';
            errorMessage.style.display = 'none'; // Hide any previous errors
        }

        function hideLoading() {
            loadingMessage.style.display = 'none';
        }

        function showAdminMessage(message, type = 'info') {
            adminMessage.textContent = '';
            adminMessage.className = `message-box ${type}`;
            adminMessage.textContent = message;
            adminMessage.style.display = 'block';
            adminSearchResults.style.display = 'none'; // Hide previous search results
        }

        // Function to display messages specific to Excel Upload (NEW)
        function showExcelUploadMessage(message, type = 'info') {
            excelUploadMessage.textContent = '';
            excelUploadMessage.className = `message-box ${type}`;
            excelUploadMessage.textContent = message;
            excelUploadMessage.style.display = 'block';
        }

        function hideAllContentSections() {
            authSection.style.display = 'none';
            analyzerReportContent.style.display = 'none';
            controlRoomContent.style.display = 'none';
            adminDashboardContent.style.display = 'none'; 
            
            // Admin Dashboard sub-sections
            adminSearchSection.style.display = 'none'; 
            adminSearchResults.style.display = 'none'; 
            adminUsersSection.style.display = 'none';
            dataUploadSection.style.display = 'none'; // NEW: Hide data upload section
            currentRankingsDisplay.style.display = 'none'; // NEW: Hide current rankings display

            // Also hide specific elements that show up in sub-sections
            shareVideoButton.style.display = 'none'; 
            managerStatsDiv.style.display = 'none'; 
            // Hide chart containers and clear chart instances
            document.getElementById('rankJourneyChartContainer').style.display = 'none';
            document.getElementById('pointsChartContainer').style.display = 'none';
            document.getElementById('captaincyChartContainer').style.display = 'none';
            document.getElementById('transferChartContainer').style.display = 'none';
            document.getElementById('arrowChartContainer').style.display = 'none';
            if (rankJourneyChartInstance) rankJourneyChartInstance.destroy();
            if (pointsChartInstance) pointsChartInstance.destroy();
            if (captaincyChartInstance) captaincyChartInstance.destroy();
            if (transferChartInstance) transferChartInstance.destroy();
            if (arrowChartInstance) arrowChartInstance.destroy();

            // General messages/loading indicators
            loadingMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            videoGeneratingMessage.style.display = 'none';
            authMessageBox.style.display = 'none'; 
            adminMessage.style.display = 'none';      
            excelUploadMessage.style.display = 'none'; // NEW: Hide excel upload message
        }

        function showContentSection(sectionId) {
            hideAllContentSections();
            document.getElementById(sectionId).style.display = 'block';
            if (sectionId === 'adminDashboard') {
                adminDashboardNavButtons.style.display = 'flex'; // Show admin nav buttons
                // Default to showing search when admin dashboard is opened
                adminSearchSection.style.display = 'block'; 
                showAdminMessage("Enter manager ID to search.", "info");
            }
        }

        // --- Chart Rendering Functions ---
        function renderChart(chartId, type, data, options, instanceVar) {
            const ctx = document.getElementById(chartId).getContext('2d');
            if (instanceVar) {
                instanceVar.destroy(); // Destroy previous instance if it exists
            }
            return new Chart(ctx, { type, data, options });
        }

        function renderRankJourneyChart(data) {
            const labels = data.map(item => `Round ${item.round}`);
            const ranks = data.map(item => item.rank);

            rankJourneyChartInstance = renderChart(
                'rankJourneyChart',
                'line',
                {
                    labels: labels,
                    datasets: [{
                        label: 'Overall Rank',
                        data: ranks,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            reverse: true, // Lower rank is better
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Rank'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Round'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: (context) => `Round ${context[0].label.replace('Round ', '')}`,
                                label: (context) => `Rank: ${context.raw}`
                            }
                        }
                    }
                },
                rankJourneyChartInstance
            );
            document.getElementById('rankJourneyChartContainer').style.display = 'block';
        }

        function renderPointsChart(data) {
            const labels = data.map(item => `Round ${item.round}`);
            const points = data.map(item => item.points);
            const overallPoints = data.map(item => item.overallPoints);

            pointsChartInstance = renderChart(
                'pointsChart',
                'bar',
                {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Round Points',
                            data: points,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Overall Points',
                            data: overallPoints,
                            type: 'line',
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.1,
                            fill: false,
                            yAxisID: 'y1' // Use a second Y-axis for overall points
                        }
                    ]
                },
                {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Round Points'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false, // Only draw grid lines for the first Y-axis
                            },
                            title: {
                                display: true,
                                text: 'Overall Points'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: (context) => `Round ${context[0].label.replace('Round ', '')}`,
                                label: (context) => {
                                    if (context.dataset.label === 'Round Points') {
                                        return `Round Points: ${context.raw}`;
                                    } else {
                                        return `Overall Points: ${context.raw}`;
                                    }
                                }
                            }
                        }
                    }
                },
                pointsChartInstance
            );
            document.getElementById('pointsChartContainer').style.display = 'block';
        }

        function renderCaptaincyChart(data) {
            const labels = data.map(item => item.playerName);
            const counts = data.map(item => item.count);
            const points = data.map(item => item.totalPoints);

            captaincyChartInstance = renderChart(
                'captaincyChart',
                'bar',
                {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Times Captained',
                            data: counts,
                            backgroundColor: 'rgba(153, 102, 255, 0.6)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Total Points (as Captain)',
                            data: points,
                            type: 'line',
                            borderColor: 'rgb(255, 159, 64)',
                            tension: 0.1,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Times Captained'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'Total Points'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: (context) => context[0].label,
                                label: (context) => {
                                    if (context.dataset.label === 'Times Captained') {
                                        return `Times Captained: ${context.raw}`;
                                    } else {
                                        return `Points: ${context.raw}`;
                                    }
                                }
                            }
                        }
                    }
                },
                captaincyChartInstance
            );
            document.getElementById('captaincyChartContainer').style.display = 'block';
        }

        function renderTransferChart(data) {
            const labels = data.map(t => t.playerName);
            const profits = data.map(t => t.profit);

            transferChartInstance = renderChart(
                'transferChart',
                'bar',
                {
                    labels: labels,
                    datasets: [{
                        label: 'Profit/Loss',
                        data: profits,
                        backgroundColor: profits.map(p => p >= 0 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)'),
                        borderColor: profits.map(p => p >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)'),
                        borderWidth: 1
                    }]
                },
                {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Points Gained/Lost'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: (context) => context[0].label,
                                label: (context) => `Points: ${context.raw}`
                            }
                        }
                    }
                },
                transferChartInstance
            );
            document.getElementById('transferChartContainer').style.display = 'block';
        }

        function renderArrowChart(greenArrows, redArrows) {
            arrowChartInstance = renderChart(
                'arrowChart',
                'pie',
                {
                    labels: ['Green Arrows', 'Red Arrows'],
                    datasets: [{
                        data: [greenArrows, redArrows],
                        backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(255, 99, 132, 0.6)'],
                        borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)'],
                        borderWidth: 1
                    }]
                },
                {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.label}: ${context.raw}`
                            }
                        }
                    }
                },
                arrowChartInstance
            );
            document.getElementById('arrowChartContainer').style.display = 'block';
        }


        // --- Authentication Functions ---
        loginBtn.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            try {
                showLoading('Logging in...');
                await signInWithEmailAndPassword(auth, email, password);
                showMessage('Logged in successfully!', 'success');
                // UI update handled by onAuthStateChanged
            } catch (error) {
                console.error("Login failed:", error);
                showMessage(`Login failed: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        signupBtn.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            try {
                showLoading('Signing up...');
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage('Signed up successfully! Please log in.', 'success');
                // UI update handled by onAuthStateChanged
            } catch (error) {
                console.error("Sign up failed:", error);
                showMessage(`Sign up failed: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        menuLogout.addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
            showMessage('Logged out successfully.', 'info');
            // UI update handled by onAuthStateChanged
        });

        sidebarLogout.addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
            showMessage('Logged out successfully.', 'info');
            sidebarMenu.classList.remove('open');
            overlay.style.display = 'none';
            // UI update handled by onAuthStateChanged
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                authSection.style.display = 'none';
                menuLogout.style.display = 'block';
                sidebarLogout.style.display = 'block';
                
                // Check if user is admin
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().role === 'admin') {
                    isAdmin = true;
                    menuAdminDashboard.style.display = 'block';
                    sidebarAdminDashboard.style.display = 'block';
                } else {
                    isAdmin = false;
                    menuAdminDashboard.style.display = 'none';
                    sidebarAdminDashboard.style.display = 'none';
                }

                // Show default content for logged-in users (e.g., Analyze My Team)
                showContentSection('analyzerReport');
            } else {
                // User is signed out
                authSection.style.display = 'block';
                menuLogout.style.display = 'none';
                sidebarLogout.style.display = 'none';
                menuAdminDashboard.style.display = 'none';
                sidebarAdminDashboard.style.display = 'none';
                isAdmin = false;
                hideAllContentSections(); // Hide all content and show login
            }
        });

        // --- Fetch SPL Report Data ---
        async function fetchAndDisplaySPLReport(managerId) {
            showLoading('Fetching SPL report...');
            managerStatsDiv.innerHTML = ''; // Clear previous stats
            managerStatsDiv.style.display = 'none';
            shareVideoButton.style.display = 'none';
            isAnalyzerReportDataFetched = false;

            try {
                const response = await fetch(`/.netlify/functions/fetch-spl-data?managerId=${managerId}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Received SPL Report Data:', data); // Debugging

                // Display manager stats
                managerStatsDiv.style.display = 'grid';
                managerStatsDiv.innerHTML = `
                    <div><h4>Manager Name</h4><p class="stat-value">${data.managerName || 'N/A'}</p></div>
                    <div><h4>Overall Rank</h4><p class="stat-value">${data.overallRank || 'N/A'}</p></div>
                    <div><h4>Overall Points</h4><p class="stat-value">${data.overallPoints || 'N/A'}</p></div>
                    <div><h4>Current Place</h4><p class="stat-value">${data.currentPlace || 'N/A'}</p></div>
                    <div><h4>Best Round</h4><p class="stat-value">${data.bestRound?.round || 'N/A'} (${data.bestRound?.points || 'N/A'} pts)</p></div>
                    <div><h4>Worst Round</h4><p class="stat-value">${data.worstRound?.round || 'N/A'} (${data.worstRound?.points || 'N/A'} pts)</p></div>
                    <div><h4>Green Arrows</h4><p class="stat-value">${data.greenArrowsCount || 0}</p></div>
                    <div><h4>Red Arrows</h4><p class="stat-value">${data.redArrowsCount || 0}</p></div>
                    <div><h4>Total Transfers</h4><p class="stat-value">${data.totalTransfersCount || 0}</p></div>
                    <div><h4>Total Hits</h4><p class="stat-value">${data.totalHitsPoints || 0}</p></div>
                `;

                // Render Charts if data is available
                if (data.rankJourney && data.rankJourney.length > 0) {
                    renderRankJourneyChart(data.rankJourney);
                } else {
                    document.getElementById('rankJourneyChartContainer').style.display = 'none';
                }
                if (data.pointsHistory && data.pointsHistory.length > 0) {
                    renderPointsChart(data.pointsHistory);
                } else {
                    document.getElementById('pointsChartContainer').style.display = 'none';
                }
                if (data.top3Captains && data.top3Captains.length > 0) {
                    renderCaptaincyChart(data.top3Captains);
                } else {
                    document.getElementById('captaincyChartContainer').style.display = 'none';
                }
                if (data.top5ProfitableTransfers && data.top5ProfitableTransfers.length > 0) {
                    renderTransferChart(data.top5ProfitableTransfers);
                } else {
                    document.getElementById('transferChartContainer').style.display = 'none';
                }
                if (data.greenArrowsCount !== undefined && data.redArrowsCount !== undefined) {
                    renderArrowChart(data.greenArrowsCount, data.redArrowsCount);
                } else {
                    document.getElementById('arrowChartContainer').style.display = 'none';
                }


                shareVideoButton.style.display = 'block';
                isAnalyzerReportDataFetched = true;
                hideLoading();

            } catch (error) {
                console.error("Error fetching SPL report:", error);
                showMessage(`Failed to fetch report: ${error.message}`, 'error');
                hideLoading();
            }
        }

        fetchReportBtn.addEventListener('click', () => {
            const managerId = managerIdInput.value;
            if (managerId) {
                currentManagerId = managerId;
                fetchAndDisplaySPLReport(managerId);
            } else {
                showMessage('Please enter a Manager ID.', 'error');
            }
        });

        // --- Admin Dashboard Functions ---
        adminSearchButton.addEventListener('click', () => {
            adminSearchSection.style.display = 'block';
            adminUsersSection.style.display = 'none';
            dataUploadSection.style.display = 'none'; // NEW: Hide data upload section
            currentRankingsDisplay.style.display = 'none'; // NEW: Hide display
            showAdminMessage("Enter manager ID to search.", "info");
        });

        adminDataButton.addEventListener('click', () => {
            adminSearchSection.style.display = 'none'; // Hide search input/button
            adminSearchResults.style.display = 'none'; // Hide results
            adminUsersSection.style.display = 'none';
            adminMessage.style.display = 'none'; // Clear previous messages
            dataUploadSection.style.display = 'block'; // Show the data upload section
            currentRankingsDisplay.style.display = 'block'; // Show current rankings display
            showExcelUploadMessage("Upload your league table Excel file here.", "info");
            fetchAndDisplayCurrentRankings(); // Fetch and display existing rankings
        });

        adminUsersButton.addEventListener('click', () => {
            adminSearchSection.style.display = 'none';
            adminSearchResults.style.display = 'none';
            dataUploadSection.style.display = 'none'; // NEW: Hide data upload section
            currentRankingsDisplay.style.display = 'none'; // NEW: Hide display
            adminUsersSection.style.display = 'block';
            showAdminMessage("User management features will be available here.", "info");
        });

        async function fetchManagerDetails(managerId) {
            showAdminMessage('Fetching manager details...', 'info');
            try {
                const managerDocRef = doc(db, 'managers', managerId);
                const managerDocSnap = await getDoc(managerDocRef);

                if (managerDocSnap.exists()) {
                    const data = managerDocSnap.data();
                    managerDetailsList.innerHTML = `
                        <li><strong>Manager ID:</strong> <span class="manager-id">${managerId}</span></li>
                        <li><strong>Email:</strong> ${data.email || 'N/A'}</li>
                        <li><strong>Role:</strong> ${data.role || 'user'}</li>
                        <!-- Add more details as needed -->
                    `;
                    adminSearchResults.style.display = 'block';
                    adminMessage.style.display = 'none';
                    adminDeleteManagerBtn.style.display = 'block'; // Show delete button
                } else {
                    showAdminMessage('Manager not found.', 'error');
                    adminSearchResults.style.display = 'none';
                    adminDeleteManagerBtn.style.display = 'none';
                }
            } catch (error) {
                console.error("Error fetching manager details:", error);
                showAdminMessage(`Failed to fetch manager details: ${error.message}`, 'error');
            }
        }

        adminFetchManagerBtn.addEventListener('click', () => {
            const managerId = adminManagerIdInput.value;
            if (managerId) {
                fetchManagerDetails(managerId);
            } else {
                showAdminMessage('Please enter a Manager ID.', 'error');
            }
        });

        adminDeleteManagerBtn.addEventListener('click', async () => {
            const managerIdToDelete = adminManagerIdInput.value;
            // Using a custom message box instead of confirm()
            const confirmDelete = window.prompt(`Type "DELETE" to confirm deletion of manager with ID: ${managerIdToDelete}`);
            if (confirmDelete === "DELETE") {
                try {
                    // Implement Firebase Admin SDK function call here to delete user and their data
                    // This would typically be done via a Netlify Function that calls your Python backend
                    // For now, this is a placeholder. Direct client-side deletion of auth users is restricted.
                    showAdminMessage('Deletion initiated (requires backend implementation).', 'info');
                    // Example: await deleteDoc(doc(db, 'managers', managerIdToDelete));
                    // Then refresh or clear display
                    adminManagerIdInput.value = '';
                    adminSearchResults.style.display = 'none';
                    adminDeleteManagerBtn.style.display = 'none';
                    showAdminMessage('Manager deletion request sent (requires backend).', 'success');
                } catch (error) {
                    console.error("Error deleting manager:", error);
                    showAdminMessage(`Failed to delete manager: ${error.message}`, 'error');
                }
            } else if (confirmDelete !== null) {
                showAdminMessage('Deletion cancelled.', 'info');
            }
        });

        // --- Excel File Upload Logic (NEW) ---
        excelFileUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                showExcelUploadMessage('No file selected.', 'error');
                return;
            }

            // Check window.XLSX directly here (it's loaded from CDN in HTML)
            if (typeof window.XLSX === 'undefined') {
                showExcelUploadMessage('Excel library (XLSX.js) not loaded. Please try refreshing the page.', 'error');
                console.error("window.XLSX is not defined. Excel library not loaded.");
                return;
            }

            showExcelUploadMessage('Uploading and processing Excel file...', 'info');

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' }); // Use XLSX directly

                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonRows = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // Use XLSX directly

                    if (jsonRows.length < 2) {
                        showExcelUploadMessage('Excel file is empty or missing data rows.', 'error');
                        return;
                    }

                    const headerRow = jsonRows[0].map(h => String(h).trim().toLowerCase());
                    
                    // Updated expected headers for FDR Home and FDR Away
                    const expectedHeaders = {
                        rank: ['rank', 'ranking number'],
                        team: ['team', 'team name'],
                        fdrHome: ['fdr home', 'home fdr', 'fdr rating home'], 
                        fdrAway: ['fdr away', 'away fdr', 'fdr rating away']  
                    };

                    const getColumnIndex = (headers, aliases) => {
                        for (const alias of aliases) {
                            const index = headers.indexOf(alias);
                            if (index !== -1) return index;
                        }
                        return -1;
                    };

                    const rankIndex = getColumnIndex(headerRow, expectedHeaders.rank);
                    const teamIndex = getColumnIndex(headerRow, expectedHeaders.team);
                    const fdrHomeIndex = getColumnIndex(headerRow, expectedHeaders.fdrHome);
                    const fdrAwayIndex = getColumnIndex(headerRow, expectedHeaders.fdrAway);

                    if (rankIndex === -1 || teamIndex === -1 || fdrHomeIndex === -1 || fdrAwayIndex === -1) {
                        showExcelUploadMessage('Invalid Excel headers. Expected "Rank", "Team", "FDR Home", and "FDR Away".', 'error');
                        return;
                    }

                    const parsedRankings = [];
                    for (let i = 1; i < jsonRows.length; i++) {
                        const row = jsonRows[i];
                        const rank = parseInt(row[rankIndex], 10);
                        const team = String(row[teamIndex]).trim();
                        const fdrHome = parseInt(row[fdrHomeIndex], 10); 
                        const fdrAway = parseInt(row[fdrAwayIndex], 10); 

                        // Validate FDR values are between 1 and 7
                        if (!isNaN(rank) && team && !isNaN(fdrHome) && !isNaN(fdrAway) &&
                            fdrHome >=1 && fdrHome <= 7 && fdrAway >= 1 && fdrAway <= 7) {
                            parsedRankings.push({ rank, team, fdrHome, fdrAway });
                        } else {
                            console.warn(`Skipping row ${i+1} due to invalid data or FDR out of range (1-7): Rank=${row[rankIndex]}, Team=${row[teamIndex]}, FDR Home=${row[fdrHomeIndex]}, FDR Away=${row[fdrAwayIndex]}`);
                        }
                    }

                    if (parsedRankings.length === 0) {
                        showExcelUploadMessage('No valid ranking data found in the Excel file after parsing. Ensure all columns are present and FDRs are 1-7.', 'error');
                        return;
                    }

                    const selectedRankingType = rankingTypeSelect.value; 
                    const seasonId = "2024-2025"; 
                    
                    // Firestore path: public_data/splRankings/2024-2025
                    // This path is chosen for publicly accessible data in Firestore.
                    const splRankingsDocRef = doc(db, 'public_data', 'splRankings', seasonId); 

                    let existingData = {};
                    const docSnap = await getDoc(splRankingsDocRef);
                    if (docSnap.exists()) {
                        existingData = docSnap.data();
                    }

                    const newData = {
                        ...existingData,
                        season: seasonId,
                        lastUpdated: serverTimestamp(),
                        // Store the parsed rankings under the selected type (e.g., 'overall', 'home', 'away')
                        [selectedRankingType]: parsedRankings 
                    };

                    await setDoc(splRankingsDocRef, newData, { merge: true });
                    showExcelUploadMessage(`Successfully uploaded ${selectedRankingType} rankings from Excel!`, 'success');
                    event.target.value = null; // Clear file input
                    fetchAndDisplayCurrentRankings(); // Refresh display after upload
                } catch (error) {
                    console.error('Error processing Excel file or uploading to Firestore:', error);
                    showExcelUploadMessage(`Failed to process Excel or upload: ${error.message}. Please check file format and console for details.`, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // --- Fetch and Display Current Rankings from Firestore (NEW) ---
        async function fetchAndDisplayCurrentRankings() {
            showExcelUploadMessage('Fetching current rankings...', 'info');
            overallRankingsList.innerHTML = '';
            homeRankingsList.innerHTML = '';
            awayRankingsList.innerHTML = '';

            const seasonId = "2024-2025";
            const splRankingsDocRef = doc(db, 'public_data', 'splRankings', seasonId);

            try {
                // Use onSnapshot for real-time updates if desired, otherwise getDoc is fine for one-time fetch
                const docSnap = await getDoc(splRankingsDocRef); 
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("Current Rankings from Firestore:", data);

                    const renderList = (listElement, rankings) => {
                        listElement.innerHTML = ''; // Clear previous list items
                        if (rankings && rankings.length > 0) {
                            rankings.forEach(item => {
                                const listItem = document.createElement('li');
                                listItem.className = 'flex justify-between items-center py-1 px-2 hover:bg-gray-200 rounded-md';
                                listItem.innerHTML = `
                                    <span class="font-medium text-gray-800">${item.rank}.</span>
                                    <span class="flex-grow ml-2 text-gray-700">${item.team}</span>
                                    <span class="ml-2 text-gray-600 text-xs">(H: ${item.fdrHome}, A: ${item.fdrAway})</span>
                                `;
                                listElement.appendChild(listItem);
                            });
                        } else {
                            listElement.innerHTML = '<li class="text-gray-500 text-center">No data available.</li>';
                        }
                    };

                    renderList(overallRankingsList, data.overall);
                    renderList(homeRankingsList, data.home);
                    renderList(awayRankingsList, data.away);
                    showExcelUploadMessage('Current rankings loaded.', 'success');
                } else {
                    showExcelUploadMessage('No rankings data found in Firestore for 2024-2025 season.', 'info');
                    overallRankingsList.innerHTML = '<li class="text-gray-500 text-center">No data available.</li>';
                    homeRankingsList.innerHTML = '<li class="text-gray-500 text-center">No data available.</li>';
                    awayRankingsList.innerHTML = '<li class="text-gray-500 text-center">No data available.</li>';
                }
            } catch (error) {
                console.error("Error fetching current rankings for display:", error);
                showExcelUploadMessage(`Failed to load current rankings: ${error.message}`, 'error');
            }
        }


        // --- Menu Item Click Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial content display based on authentication status
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    showContentSection('authSection');
                } else {
                    // This will be handled by the onAuthStateChanged listener itself
                    // which calls showContentSection('analyzerReport') after checking admin status
                }
            });

            hamburger.addEventListener('click', () => {
                sidebarMenu.classList.add('open');
                overlay.style.display = 'block';
            });

            closeBtn.addEventListener('click', () => {
                sidebarMenu.classList.remove('open');
                overlay.style.display = 'none';
            });

            overlay.addEventListener('click', () => {
                sidebarMenu.classList.remove('open');
                overlay.style.display = 'none';
            });

            // --- Menu Item Click Listeners ---
            if (menuAnalyzeMyTeam) {
                menuAnalyzeMyTeam.addEventListener('click', (e) => {
                    e.preventDefault();
                    showContentSection('analyzerReport');
                    sidebarMenu.classList.remove('open'); // Close menu after click
                    overlay.style.display = 'none';
                    if (currentManagerId && !isAnalyzerReportDataFetched) {
                        fetchAndDisplaySPLReport(currentManagerId);
                    }
                });
            }
            if (menuMyControlRoom) {
                menuMyControlRoom.addEventListener('click', (e) => {
                    e.preventDefault();
                    showContentSection('controlRoom');
                    sidebarMenu.classList.remove('open'); // Close menu after click
                    overlay.style.display = 'none';
                });
            }
            if (menuAdminDashboard) {
                menuAdminDashboard.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.trace("DEBUG: Admin Dashboard menu item clicked!"); 
                    showContentSection('adminDashboard');
                    sidebarMenu.classList.remove('open'); // Close menu after click
                    overlay.style.display = 'none';
                });
            }

            // Dark Mode Toggle
            function toggleDarkMode() {
                document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                localStorage.setItem('darkMode', isDarkMode);
            }

            if (menuDarkModeToggle) {
                menuDarkModeToggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    toggleDarkMode();
                    sidebarMenu.classList.remove('open');
                    overlay.style.display = 'none';
                });
            }

            if (sidebarDarkModeToggle) {
                sidebarDarkModeToggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    toggleDarkMode();
                    sidebarMenu.classList.remove('open');
                    overlay.style.display = 'none';
                });
            }

            // Apply dark mode preference on load
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                document.body.classList.add('dark-mode');
            }
        });
    </script>
</body>
</html>